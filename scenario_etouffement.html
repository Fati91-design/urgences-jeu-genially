<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sc√©nario ‚Äì √âtouffement</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
html,body{margin:0;background:transparent;font-family:system-ui;color:#fff}
.stage{min-height:100vh;display:flex;justify-content:center;padding:16px}
.wrap{max-width:1100px;width:100%}

.hud{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.hudbox{background:rgba(20,22,30,.75);border-radius:18px;padding:14px;display:flex;justify-content:space-between;align-items:center}

.profile{display:flex;gap:14px;align-items:center}
.avatar{width:90px;height:90px;border-radius:22px;object-fit:cover;object-position:50% 10%;transform:scale(1.3)}

.stats{display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end}
.pill{background:rgba(255,255,255,.08);border-radius:999px;padding:8px 12px;font-weight:900;font-size:13px}

.timer{display:flex;align-items:center;gap:8px}
.ring{width:38px;height:38px;border-radius:50%;background:conic-gradient(#ffc857 var(--p),#333 0);display:grid;place-items:center}
.inner{width:26px;height:26px;border-radius:50%;background:#111;display:grid;place-items:center;font-size:14px}

.frame{background:rgba(15,17,25,.65);border-radius:20px;padding:20px}
.opt{background:linear-gradient(180deg,#4fa3ff55,#4fa3ff33);padding:14px;border-radius:14px;font-weight:900;margin-top:12px;cursor:pointer}
.opt.sel{background:linear-gradient(180deg,#ffb84d,#ff7a2f)}

.actions{text-align:right;margin-top:14px}
.btnPrimary{background:linear-gradient(180deg,#ffb84d,#ff7a2f);border:none;border-radius:12px;padding:10px 14px;font-weight:900;color:#111}

.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#0f121a;border-radius:18px;padding:20px;max-width:600px;width:90%}
</style>
</head>

<body>
<div class="stage">
<div class="wrap">

<div class="hud">
<div class="hudbox">
<div class="profile">
<img id="avatar" class="avatar">
<div>
<div id="name" style="font-size:22px;font-weight:900"></div>
<div id="role" style="opacity:.7;font-size:13px"></div>
</div>
</div>
</div>

<div class="hudbox">
<div class="stats">
<div class="pill">‚≠ê <span id="score">0</span></div>
<div class="pill">Q <span id="qnum">1</span>/10</div>
<div class="pill">üéØ <span id="tries">0</span>/2</div>
<div class="pill timer">
<div class="ring" id="ring"><div class="inner">‚è±</div></div>
<span><span id="time">12</span>s</span>
</div>
</div>
</div>
</div>

<div class="frame">
<h3 id="title"></h3>
<p id="desc"></p>
<div id="options"></div>
<div class="actions">
<button id="validate" class="btnPrimary" disabled>Valider</button>
</div>
</div>

</div>
</div>

<div class="overlay" id="overlay">
<div class="modal">
<p id="feedback"></p>
<button id="retry" class="btnPrimary">OK</button>
</div>
</div>

<script>
/* =========================
   PLAYER
========================= */
const playerName = localStorage.getItem("playerName") || "Joueur";
const role = localStorage.getItem("role") || "Infirmier";
document.getElementById("name").textContent = playerName;
document.getElementById("role").textContent = role;
document.getElementById("avatar").src = "assets/avatars/medecin_f.png";

/* =========================
   STATE
========================= */
let score = 0;
let tries = 0;
let qIndex = 0;
let locked = false;

/* TIMER TOKEN (cl√© du fix) */
let timerToken = 0;
let timeLeft = 12;

/* =========================
   QUESTION
========================= */
const question = {
title:"Victime qui s‚Äô√©touffe",
desc:"La victime ne peut pas parler et tousse faiblement. Que fais-tu ?",
options:[
{text:"Encourager la toux", ok:false},
{text:"Claques dorsales + Heimlich", ok:true},
{text:"Donner de l‚Äôeau", ok:false}
]
};

/* =========================
   TIMER (ANTI BUG)
========================= */
function stopTimer(){
  timerToken++;
  document.getElementById("time").textContent = timeLeft;
  updateRing();
}

function startTimer(){
  timerToken++;
  const myToken = timerToken;
  timeLeft = 12;
  updateRing();
  document.getElementById("time").textContent = timeLeft;

  const tick = ()=>{
    if(timerToken !== myToken || locked) return;
    timeLeft--;
    document.getElementById("time").textContent = timeLeft;
    updateRing();
    if(timeLeft <= 0){
      stopTimer();
      fail("‚è± Temps √©coul√©. Mission √©chou√©e.");
      return;
    }
    setTimeout(tick,1000);
  };
  setTimeout(tick,1000);
}

function updateRing(){
  document.getElementById("ring").style.setProperty("--p",(timeLeft/12*100)+"%");
}

/* =========================
   RENDER
========================= */
function render(){
  locked = false;
  tries = 0;
  document.getElementById("tries").textContent = tries;
  document.getElementById("title").textContent = question.title;
  document.getElementById("desc").textContent = question.desc;
  const optBox = document.getElementById("options");
  optBox.innerHTML="";
  let selected = null;

  question.options.forEach((o,i)=>{
    const d=document.createElement("div");
    d.className="opt";
    d.textContent=o.text;
    d.onclick=()=>{
      document.querySelectorAll(".opt").forEach(x=>x.classList.remove("sel"));
      d.classList.add("sel");
      selected=i;
      document.getElementById("validate").disabled=false;
    };
    optBox.appendChild(d);
  });

  document.getElementById("validate").onclick=()=>{
    stopTimer();
    locked=true;
    if(question.options[selected].ok){
      score+=10;
      document.getElementById("score").textContent=score;
      show("‚úÖ Bonne r√©ponse !");
    }else{
      tries++;
      document.getElementById("tries").textContent=tries;
      if(tries>=2){
        fail("‚ùå Deux erreurs. Mission √©chou√©e.");
      }else{
        show("‚ö† Mauvaise r√©ponse. R√©essaie.");
      }
    }
  };

  startTimer();
}

/* =========================
   FEEDBACK
========================= */
function show(msg){
  document.getElementById("feedback").textContent=msg;
  document.getElementById("overlay").style.display="flex";
}

function fail(msg){
  score=0;
  document.getElementById("score").textContent=0;
  show(msg);
}

document.getElementById("retry").onclick=()=>{
  document.getElementById("overlay").style.display="none";
  render();
};

/* =========================
   START
========================= */
render();
</script>
</body>
</html>
