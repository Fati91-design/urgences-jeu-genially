<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sc√©nario 1 ‚Äî √âtouffement</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --glass: rgba(6, 10, 18, .62);
      --glass2: rgba(6, 10, 18, .42);
      --stroke: rgba(140, 210, 255, .18);
      --stroke2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --blue: rgba(22, 145, 255, 1);
      --blue2: rgba(22, 145, 255, .25);
      --ember: rgba(255, 150, 70, 1);
      --red: rgba(255, 70, 70, 1);
      --green: rgba(45, 200, 120, 1);
      --yellow: rgba(255, 200, 80, 1);

      /* difficulty defaults */
      --baseTime: 12;            /* seconds per question */
      --stressTick: 2;           /* stress added on timeout */
      --stressWrong: 6;          /* stress added on wrong */
      --stressCritical: 18;      /* stress added on critical */
    }

    html, body{
      margin:0;
      background: transparent;
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    /* FULL SCREEN FRAME */
    .game{
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }

    /* MAIN PANEL mimics your screenshot‚Äôs sci-fi frame */
    .panel{
      width: min(1280px, 100%);
      background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.10));
      border-radius: 18px;
      position: relative;
      overflow: hidden;
    }

    /* subtle neon frame */
    .panel::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: 18px;
      border: 1px solid rgba(120, 200, 255, .22);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.25) inset,
        0 0 35px rgba(22,145,255,.10),
        0 25px 80px rgba(0,0,0,.45);
      pointer-events:none;
    }

    /* top HUD area with two boxes like your red rectangles */
    .topbar{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 22px;
      padding: 18px 18px 10px;
      position: relative;
      z-index: 2;
    }

    .hudbox{
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: 10px;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      backdrop-filter: blur(12px);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      min-height: 74px;
    }

    /* left HUD content */
    .profile{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }
    .avatar{
      width: 52px;
      height: 52px;
      border-radius: 14px;
      object-fit: cover;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      flex: 0 0 auto;
    }
    .ptext{
      min-width: 0;
    }
    .pname{
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .prole{
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chip{
      background: rgba(22,145,255,.16);
      border: 1px solid rgba(22,145,255,.22);
      color: rgba(255,255,255,.88);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
    }

    /* right HUD content */
    .stats{
      display:flex;
      align-items:center;
      gap: 14px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .stat{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
    }

    .timer{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
    }
    .timer .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.35);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .timer.danger .dot{ background: var(--red); box-shadow: 0 0 0 4px rgba(255,70,70,.14); }
    .timer.warn .dot{ background: var(--yellow); box-shadow: 0 0 0 4px rgba(255,200,80,.14); }

    .stressWrap{
      width: 180px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow: hidden;
    }
    .stressBar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(45,200,120,.95), rgba(255,200,80,.95), rgba(255,70,70,.95));
      transition: width .25s ease;
    }

    /* MAIN CONTENT box like your central frame */
    .main{
      padding: 0 18px 18px;
      position: relative;
      z-index: 2;
    }

    .frame{
      background: var(--glass2);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 55px rgba(0,0,0,.40);
    }

    .qtop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 12px;
    }

    .qmeta{
      color: rgba(255,255,255,.70);
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .3px;
      text-transform: uppercase;
    }

    .qtitle{
      font-weight: 950;
      font-size: clamp(18px, 1.7vw, 24px);
      margin: 3px 0 0;
      line-height: 1.2;
      text-shadow: 0 10px 28px rgba(0,0,0,.55);
    }

    .qdesc{
      margin-top: 8px;
      color: rgba(255,255,255,.78);
      font-size: 13px;
      line-height: 1.45;
      max-width: 920px;
    }

    /* Options like blue bars */
    .options{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 14px;
    }

    .opt{
      background: rgba(22,145,255,.34);
      border: 1px solid rgba(22,145,255,.24);
      color: rgba(255,255,255,.95);
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 900;
      letter-spacing: .2px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, filter .12s ease, background .12s ease;
    }
    .opt:hover{
      transform: translateY(-1px);
      filter: brightness(1.05);
      background: rgba(22,145,255,.42);
    }
    .opt:active{
      transform: translateY(0px);
      filter: brightness(.98);
    }

    /* Feedback box */
    .feedback{
      display:none;
      margin-top: 14px;
      border-radius: 14px;
      padding: 14px 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      line-height: 1.45;
    }
    .feedback.good{ border-color: rgba(45,200,120,.35); background: rgba(45,200,120,.14); }
    .feedback.warn{ border-color: rgba(255,200,80,.35); background: rgba(255,200,80,.14); }
    .feedback.bad { border-color: rgba(255,70,70,.40); background: rgba(255,70,70,.14); }

    /* Buttons bottom inside frame */
    .actions{
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      margin-top: 14px;
    }

    .btnNeo{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      color: rgba(255,255,255,.88);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .btnPrimary{
      border: none;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      color: rgba(10,12,18,.96);
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 950;
      letter-spacing: .2px;
      display:none;
    }
    .btnPrimary.show{ display:inline-block; }

    /* Critical alert overlay */
    .alertOverlay{
      position:absolute;
      inset:0;
      background: radial-gradient(800px 300px at 50% 20%, rgba(255,70,70,.20), transparent 70%),
                  rgba(0,0,0,.12);
      border: 2px solid rgba(255,70,70,.55);
      box-shadow: 0 0 0 2px rgba(0,0,0,.35) inset, 0 0 55px rgba(255,70,70,.25);
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease;
      z-index: 5;
    }
    .alertOverlay.on{ opacity:1; }

    .shake{
      animation: shake .24s linear 1;
    }
    @keyframes shake{
      0% { transform: translateX(0px); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
      100%{ transform: translateX(0px); }
    }

    /* responsive tweaks */
    @media (max-width: 720px){
      .topbar{ grid-template-columns: 1fr; }
      .stats{ justify-content:flex-start; }
      .stressWrap{ width: 140px; }
    }
  </style>
</head>

<body>
  <div class="game">
    <div class="panel" id="panel">
      <div class="alertOverlay" id="alertOverlay"></div>

      <!-- TOP HUD -->
      <div class="topbar">
        <!-- LEFT: avatar + name -->
        <div class="hudbox">
          <div class="profile">
            <img class="avatar" id="hudAvatar" alt="Avatar" />
            <div class="ptext">
              <div class="pname" id="hudName">Joueur</div>
              <div class="prole" id="hudRole">‚Äî</div>
            </div>
          </div>
          <div class="chip" id="difficultyChip">MODE: NORMAL</div>
        </div>

        <!-- RIGHT: score + question + timer + stress -->
        <div class="hudbox">
          <div class="stats">
            <div class="stat">‚≠ê Score : <span id="hudScore">0</span></div>
            <div class="stat">Question : <span id="hudQnum">1</span>/<span id="hudQtotal">10</span></div>
            <div class="timer" id="timerPill"><span class="dot"></span> <span id="hudTime">12</span>s</div>
            <div class="stressWrap" title="Stress">
              <div class="stressBar" id="stressBar"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- MAIN FRAME -->
      <div class="main">
        <div class="frame" id="frame">
          <div class="qtop">
            <div>
              <div class="qmeta" id="qMeta">Sc√©nario 1 ‚Äî √âtouffement</div>
              <div class="qtitle" id="qTitle">‚Ä¶</div>
              <div class="qdesc" id="qDesc">‚Ä¶</div>
            </div>
          </div>

          <div class="options" id="options"></div>

          <div class="feedback" id="feedback"></div>

          <div class="actions">
            <button class="btnNeo" id="retryBtn" style="display:none;">R√©essayer</button>
            <button class="btnPrimary" id="nextBtn">Suivant</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  /* =========================
     0) UTILITAIRES
  ========================= */
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  /* =========================
     1) CONTEXTE JOUEUR
  ========================= */
  const role = localStorage.getItem("role") || "infirmier";
  const playerName = localStorage.getItem("playerName") || "Joueur";
  const avatarFile = localStorage.getItem("avatar") || "medecin_f.png";

  const roleLabelMap = {
    medecin: "M√©decin",
    infirmier: "Infirmier",
    pompier: "Pompier"
  };

  // difficulty optional (easy/intermediate/expert) - default "normal"
  const difficulty = (localStorage.getItem("difficulty") || "normal").toLowerCase();

  const difficultyConfig = {
    easy:         { time: 15, stressTick: 2,  stressWrong: 4,  stressCritical: 14, scoreOk: 10 },
    normal:       { time: 12, stressTick: 2,  stressWrong: 6,  stressCritical: 18, scoreOk: 10 },
    intermediate: { time: 10, stressTick: 3,  stressWrong: 8,  stressCritical: 22, scoreOk: 10 },
    expert:       { time: 8,  stressTick: 4,  stressWrong: 10, stressCritical: 26, scoreOk: 10 }
  };

  const cfg = difficultyConfig[difficulty] || difficultyConfig.normal;

  // Apply chip label
  const chip = document.getElementById("difficultyChip");
  chip.textContent = "MODE: " + difficulty.toUpperCase();

  // HUD fill
  document.getElementById("hudName").textContent = playerName;
  document.getElementById("hudRole").textContent = roleLabelMap[role] ? ("R√¥le: " + roleLabelMap[role]) : "R√¥le: ‚Äî";

  // avatar path
  document.getElementById("hudAvatar").src = "assets/avatars/" + avatarFile;

  /* =========================
     2) SCORE / STRESS
  ========================= */
  let score = parseInt(localStorage.getItem("score") || "0", 10);
  let stress = parseInt(localStorage.getItem("stress") || "0", 10);
  score = isNaN(score) ? 0 : score;
  stress = isNaN(stress) ? 0 : stress;

  function setScore(v){
    score = v;
    localStorage.setItem("score", String(score));
    document.getElementById("hudScore").textContent = String(score);
  }

  function addScore(delta){
    setScore(score + delta);
  }

  function setStress(v){
    stress = clamp(v, 0, 100);
    localStorage.setItem("stress", String(stress));
    document.getElementById("stressBar").style.width = stress + "%";
  }

  function addStress(delta){
    setStress(stress + delta);
  }

  // initial draw
  setScore(score);
  setStress(stress);

  /* =========================
     3) ADAPTATION M√âTIER
     - Ajuste stress/score & wording
  ========================= */
  // Role modifiers: doctors have more responsibility ‚Üí wrong/critical add more stress
  const roleMods = {
    medecin:   { stressMul: 1.15, scoreMul: 1.00 },
    infirmier: { stressMul: 1.00, scoreMul: 1.00 },
    pompier:   { stressMul: 1.08, scoreMul: 1.00 }
  };
  const rm = roleMods[role] || roleMods.infirmier;

  function roleStress(v){ return Math.round(v * rm.stressMul); }
  function roleScore(v){ return Math.round(v * rm.scoreMul); }

  /* =========================
     4) QUESTIONS (10)
     - branches + critical
     - +10 correct, +5 partial, -10 critical
  ========================= */
  const TOTAL = 10;
  document.getElementById("hudQtotal").textContent = String(TOTAL);

  const questions = [
    {
      title: "Reconna√Ætre l‚Äôurgence",
      desc: "La victime porte ses mains √† la gorge, ne peut pas parler et sa toux est faible. Quelle conclusion est la plus probable ?",
      opts: [
        { text: "Obstruction l√©g√®re (encourager la toux)", type:"wrong", fb:"‚ùå Toux faible/inefficace + impossibilit√© de parler = obstruction s√©v√®re." },
        { text: "Obstruction s√©v√®re des voies a√©riennes", type:"ok", pts: roleScore(cfg.scoreOk), fb:"‚úÖ Correct. Les signes d√©crivent une obstruction s√©v√®re (√©touffement grave)." },
        { text: "Crise d‚Äôangoisse uniquement", type:"wrong", fb:"‚ùå Les signes d√©crivent d‚Äôabord une obstruction : incapacit√© √† parler + toux inefficace." },
        { text: "Malaise vagal", type:"wrong", fb:"‚ùå Le geste ‚Äúmains √† la gorge‚Äù + toux inefficace oriente vers l‚Äô√©touffement." }
      ]
    },

    {
      title: "Toux efficace = conduite √† tenir",
      desc: "La victime tousse fort, parle et respire. Que fais-tu en premier ?",
      opts: [
        { text:"Encourager la toux et surveiller", type:"ok", pts: roleScore(cfg.scoreOk), fb:"‚úÖ Oui. Si la toux est efficace, on encourage √† tousser et on surveille." },
        { text:"Claques dorsales imm√©diatement", type:"wrong", fb:"‚ùå Pas si la toux est efficace : intervenir peut aggraver." },
        { text:"Compressions abdominales imm√©diatement", type:"wrong", fb:"‚ùå Pas si la toux est efficace : on commence par encourager la toux." },
        { text:"Donner de l‚Äôeau", type:"wrong", fb:"‚ùå Boire peut aggraver (risque d‚Äôinhalation). On surveille et on encourage la toux." }
      ]
    },

    {
      title: "S√©quence des gestes (adulte conscient)",
      desc: "Obstruction s√©v√®re chez un adulte conscient : quel encha√Ænement est recommand√© ?",
      opts: [
        { text:"5 claques dorsales puis 5 compressions abdominales (cycles)", type:"ok", pts: roleScore(cfg.scoreOk), fb:"‚úÖ Correct. On alterne 5 claques dorsales et 5 compressions abdominales." },
        { text:"Uniquement compressions abdominales", type:"partial", pts: roleScore(5), fb:"üü° Partiel. Les compressions peuvent aider, mais tu as saut√© les claques dorsales : on alterne 5+5." },
        { text:"Insufflations (bouche-√†-bouche) directement", type:"wrong", fb:"‚ùå Non. Priorit√© : d√©sobstruction (claques/pressions) chez une victime consciente." },
        { text:"Taper sur la poitrine", type:"wrong", fb:"‚ùå Les recommandations parlent de claques dorsales et compressions (pas de ‚Äútapes poitrine‚Äù)." }
      ]
    },

    {
      title: "Position pour les claques dorsales",
      desc: "Pour rendre les claques dorsales efficaces, la victime doit √™tre‚Ä¶",
      opts: [
        { text:"Pench√©e en avant, bouche vers le sol", type:"ok", pts: roleScore(cfg.scoreOk), fb:"‚úÖ Oui. Pencher en avant favorise l‚Äôexpulsion (gravit√© + efficacit√©)." },
        { text:"Allong√©e sur le dos", type:"wrong", fb:"‚ùå Non. On l‚Äôallonge surtout si elle devient inconsciente." },
        { text:"T√™te en arri√®re", type:"wrong", fb:"‚ùå Non. T√™te en arri√®re ne favorise pas l‚Äôexpulsion." },
        { text:"Assise, t√™te en arri√®re", type:"wrong", fb:"‚ùå Non. Mieux : pencher en avant." }
      ]
    },

    {
      title: "Erreur critique : ‚Äúbalayage du doigt‚Äù",
      desc: "Quelle action est dangereuse et doit √™tre √©vit√©e ?",
      opts: [
        { text:"Balayage du doigt dans la bouche sans voir l‚Äôobjet", type:"critical", pts: -10, fb:"üö® ERREUR CRITIQUE : √† l‚Äôaveugle, tu peux enfoncer l‚Äôobjet plus loin." },
        { text:"Retirer un objet clairement visible", type:"ok", pts: roleScore(cfg.scoreOk), fb:"‚úÖ Oui : uniquement si l‚Äôobjet est clairement visible et accessible." },
        { text:"Encourager la toux si elle est efficace", type:"ok", pts: roleScore(5), fb:"üü° Correct : si toux efficace, on encourage et on surveille." },
        { text:"Pencher la victime en avant", type:"ok", pts: roleScore(5), fb:"üü° Correct : position utile surtout avant les claques dorsales." }
      ]
    },

    {
      title: "Cas particulier : femme enceinte / ob√®se",
      desc: "Chez une femme enceinte (ou personne tr√®s corpulente), si les claques dorsales √©chouent, tu fais‚Ä¶",
      opts: [
        { text:"Compressions thoraciques (√† la place des abdominales)", type:"ok", pts: roleScore(cfg.scoreOk), fb:"‚úÖ Correct. On remplace les compressions abdominales par des compressions thoraciques." },
        { text:"Compressions abdominales (Heimlich) comme d‚Äôhabitude", type:"critical", pts: -10, fb:"üö® ERREUR CRITIQUE : risque de blessure. On utilise des compressions thoraciques." },
        { text:"Donner de l‚Äôeau", type:"wrong", fb:"‚ùå Non. Risque d‚Äôinhalation." },
        { text:"Attendre sans agir", type:"wrong", fb:"‚ùå Non. Il faut agir et alerter." }
      ]
    },

    {
      title: "Appeler les secours",
      desc: "Quand doit-on alerter les secours (112/15 selon pays) ?",
      opts: [
        { text:"D√®s obstruction s√©v√®re ou si les man≈ìuvres √©chouent", type:"ok", pts: roleScore(cfg.scoreOk), fb:"‚úÖ Oui. On demande de l‚Äôaide rapidement et on poursuit les gestes." },
        { text:"Seulement si la victime devient inconsciente", type:"wrong", fb:"‚ùå Trop tard. Alerte pr√©coce si obstruction s√©v√®re/persistante." },
        { text:"Apr√®s 10 minutes", type:"wrong", fb:"‚ùå Trop tard. Chaque minute compte." },
        { text:"Uniquement pour les enfants", type:"wrong", fb:"‚ùå Non. Pour toute obstruction s√©v√®re persistante." }
      ]
    },

    {
      title: "Si la victime devient inconsciente",
      desc: "Pendant les man≈ìuvres, la victime perd connaissance. Tu fais quoi ?",
      opts: [
        { text:"L‚Äôallonger au sol et commencer la RCP (compressions)", type:"ok", pts: roleScore(cfg.scoreOk), fb:"‚úÖ Correct. Si elle ne respire pas normalement : RCP, compressions en premier." },
        { text:"Continuer les compressions abdominales debout", type:"wrong", fb:"‚ùå Non. Inconsciente ‚Üí au sol, √©valuation respiration, RCP si besoin." },
        { text:"La relever et la faire marcher", type:"critical", pts: -10, fb:"üö® ERREUR CRITIQUE : perte de temps vital. Inconsciente ‚Üí au sol + prise en charge imm√©diate." },
        { text:"Attendre l‚Äôambulance sans rien faire", type:"critical", pts: -10, fb:"üö® ERREUR CRITIQUE : inaction = risque vital. Il faut agir." }
      ]
    },

    {
      title: "Apr√®s expulsion de l‚Äôobjet",
      desc: "L‚Äôobjet est expuls√©, la victime respire et parle, mais tousse encore. Que fais-tu ?",
      opts: [
        { text:"Surveiller et recommander un avis m√©dical si sympt√¥mes persistent", type:"ok", pts: roleScore(cfg.scoreOk), fb:"‚úÖ Oui. On surveille : douleur, toux persistante, malaise ‚Üí avis m√©dical." },
        { text:"Je pars, tout est fini", type:"partial", pts: roleScore(5), fb:"üü° Partiel. L‚Äôurgence est pass√©e mais la surveillance reste importante." },
        { text:"Je recommence Heimlich ‚Äúpour √™tre s√ªr‚Äù", type:"wrong", fb:"‚ùå Non. Si l‚Äôobjet est sorti et la respiration OK, on ne recommence pas." },
        { text:"Je donne √† manger tout de suite", type:"wrong", fb:"‚ùå Non. Risque de fausse route/irritation." }
      ]
    },

    {
      title: "D√©cision professionnelle",
      desc: "En tant que <b>" + escapeHtml(roleLabelMap[role] || "intervenant") + "</b>, quelle attitude est la plus s√ªre pendant l‚Äôintervention ?",
      opts: [
        { text:"Agir m√©thodiquement : √©valuer ‚Üí gestes adapt√©s ‚Üí alerter ‚Üí surveiller", type:"ok", pts: roleScore(cfg.scoreOk), fb:"‚úÖ Exact. La m√©thode r√©duit les erreurs et am√©liore l‚Äôefficacit√©." },
        { text:"Agir vite sans v√©rifier les signes", type:"wrong", fb:"‚ùå La pr√©cipitation augmente les erreurs (mauvais geste, mauvais timing)." },
        { text:"Faire boire pour ‚Äúd√©coller‚Äù l‚Äôobjet", type:"wrong", fb:"‚ùå Risque d‚Äôinhalation. On ne fait pas boire." },
        { text:"Tout faire soi-m√™me sans demander d‚Äôaide", type:"wrong", fb:"‚ùå En obstruction s√©v√®re, on alerte/demande de l‚Äôaide t√¥t." }
      ]
    },
  ];

  /* =========================
     5) TIMER + UI
  ========================= */
  let idx = 0;
  let timeLeft = cfg.time;
  let timerId = null;
  let locked = false;

  const hudQnum = document.getElementById("hudQnum");
  const hudTime = document.getElementById("hudTime");
  const timerPill = document.getElementById("timerPill");

  const qTitle = document.getElementById("qTitle");
  const qDesc = document.getElementById("qDesc");
  const optionsEl = document.getElementById("options");
  const feedbackEl = document.getElementById("feedback");
  const nextBtn = document.getElementById("nextBtn");
  const retryBtn = document.getElementById("retryBtn");
  const frame = document.getElementById("frame");
  const alertOverlay = document.getElementById("alertOverlay");

  function setTimerPill(){
    timerPill.classList.remove("danger","warn");
    if(timeLeft <= 4) timerPill.classList.add("danger");
    else if(timeLeft <= 7) timerPill.classList.add("warn");
  }

  function startTimer(){
    clearInterval(timerId);
    timeLeft = cfg.time;
    hudTime.textContent = String(timeLeft);
    setTimerPill();
    timerId = setInterval(()=>{
      if(locked) return;
      timeLeft--;
      hudTime.textContent = String(timeLeft);
      setTimerPill();

      if(timeLeft <= 0){
        clearInterval(timerId);
        // Timeout: add stress + show warning feedback + allow retry
        addStress(roleStress(cfg.stressTick));
        showFeedback("warn",
          "‚è±Ô∏è Temps √©coul√© ! Sous stress, tu risques de te tromper. Relis les signes et r√©essaie.",
          true
        );
        // Wrong branch: retry
        retryBtn.style.display = "inline-block";
        nextBtn.classList.remove("show");
        nextBtn.style.display = "none";
      }
    }, 1000);
  }

  function setQuestion(i){
    locked = false;
    clearInterval(timerId);
    feedbackEl.style.display = "none";
    feedbackEl.className = "feedback";
    feedbackEl.textContent = "";
    optionsEl.innerHTML = "";
    nextBtn.style.display = "none";
    nextBtn.classList.remove("show");
    retryBtn.style.display = "none";
    alertOverlay.classList.remove("on");
    frame.classList.remove("shake");

    const q = questions[i];
    hudQnum.textContent = String(i+1);

    qTitle.textContent = q.title;
    qDesc.innerHTML = q.desc;

    q.opts.forEach((opt, k)=>{
      const div = document.createElement("div");
      div.className = "opt";
      div.textContent = opt.text;
      div.addEventListener("click", ()=>handleAnswer(opt));
      optionsEl.appendChild(div);
    });

    startTimer();
  }

  function showFeedback(kind, text, keepOptions){
    feedbackEl.style.display = "block";
    feedbackEl.className = "feedback " + kind;
    feedbackEl.textContent = text;

    // optionally disable options to force retry/next
    if(!keepOptions){
      [...optionsEl.children].forEach(ch => ch.style.pointerEvents = "none");
      locked = true;
    }
  }

  function triggerCriticalFX(){
    alertOverlay.classList.add("on");
    frame.classList.add("shake");
    // also send message to parent (if you later handle it)
    try{ window.parent.postMessage({ type:"CRITICAL_ERROR", q: idx+1 }, "*"); }catch(e){}
  }

  function handleAnswer(opt){
    if(locked) return;

    clearInterval(timerId);

    // Apply scoring / stress
    if(opt.type === "ok"){
      addScore(opt.pts || roleScore(cfg.scoreOk));
      showFeedback("good", opt.fb || "‚úÖ Correct.", false);
      // allow next
      nextBtn.style.display = "inline-block";
      nextBtn.classList.add("show");
      retryBtn.style.display = "none";
    }
    else if(opt.type === "partial"){
      addScore(opt.pts || roleScore(5));
      addStress(roleStress(cfg.stressWrong));
      showFeedback("warn", opt.fb || "üü° Partiel. R√©essaie pour consolider.", true);
      retryBtn.style.display = "inline-block";
      nextBtn.style.display = "none";
    }
    else if(opt.type === "critical"){
      addScore(opt.pts || -10);
      addStress(roleStress(cfg.stressCritical));
      triggerCriticalFX();
      showFeedback("bad", opt.fb || "üö® Erreur critique.", true);
      retryBtn.style.display = "inline-block";
      nextBtn.style.display = "none";
    }
    else { // wrong
      addStress(roleStress(cfg.stressWrong));
      showFeedback("warn", opt.fb || "‚ùå Incorrect. R√©essaie.", true);
      retryBtn.style.display = "inline-block";
      nextBtn.style.display = "none";
    }
  }

  retryBtn.addEventListener("click", ()=>{
    // reset same question
    setQuestion(idx);
  });

  nextBtn.addEventListener("click", ()=>{
    idx++;
    if(idx < TOTAL){
      setQuestion(idx);
    } else {
      endScenario();
    }
  });

  function endScenario(){
    clearInterval(timerId);
    locked = true;

    const result =
      score >= 80 ? "üü¢ Intervention ma√Ætris√©e"
      : score >= 60 ? "üü° Bon niveau ‚Äî √† renforcer"
      : "üî¥ R√©visions fortement conseill√©es";

    qTitle.textContent = "Fin du sc√©nario ‚Äî √âtouffement";
    qDesc.innerHTML = `
      <div style="margin-top:8px; color: rgba(255,255,255,.86);">
        <div style="font-weight:950; font-size:16px;">R√©sultat : ${escapeHtml(result)}</div>
        <div style="margin-top:6px;">‚≠ê Score final : <b>${score}</b></div>
        <div>üò∞ Stress : <b>${stress}%</b></div>
        <div style="margin-top:10px; color: rgba(255,255,255,.75); font-size:13px;">
          Tu peux maintenant cliquer sur <b>Suivant</b> dans Genially pour continuer.
        </div>
      </div>
    `;

    optionsEl.innerHTML = "";
    feedbackEl.style.display = "none";
    retryBtn.style.display = "none";
    nextBtn.style.display = "none";
  }

  /* =========================
     6) INIT
  ========================= */
  // Ensure baseline keys
  localStorage.setItem("playerName", playerName);
  localStorage.setItem("role", role);
  localStorage.setItem("avatar", avatarFile);

  // First question
  setQuestion(0);
</script>
</body>
</html>
