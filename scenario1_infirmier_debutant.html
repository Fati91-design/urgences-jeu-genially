<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sc√©nario 1 ‚Äî √âtouffement ‚Äî Infirmier ‚Äî d√©butant</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --glass: rgba(25, 27, 31, .72);
      --glass2: rgba(15, 17, 20, .55);

      --text: rgba(255,255,255,.93);
      --muted: rgba(255,255,255,.70);

      --gold: rgba(255,200,80,1);
      --red: rgba(255,70,70,1);
      --green: rgba(45,200,120,1);
      --blue: rgba(80,170,255,1);
      --ember: rgba(255,150,70,1);
      --ember2: rgba(255,120,50,1);
    }

    html,body{ margin:0; background: transparent; color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .stage{ min-height: 100vh; display:flex; justify-content:center; align-items:flex-start; padding: 16px 14px; }
    /* ‚úÖ √©largir comme Genially (plus large que 1120px) */
    .wrap{ width: min(1650px, 100%); }

    /* ====== TOP LEVEL TAB (niveau) + PROGRESS ====== */
    .topTabs{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .levelTab{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,150,70,.18), rgba(80,170,255,.10));
      box-shadow: 0 16px 44px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      font-weight: 950;
      letter-spacing: .25px;
      white-space: nowrap;
    }
    .levelDot{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(255,176,90,1);
      box-shadow: 0 0 0 5px rgba(255,176,90,.18);
    }
    /* ‚úÖ police plus lisible */
    .miniHint{
      font-size: 13px;
      font-weight: 950;
      color: rgba(255,255,255,.78);
      white-space: nowrap;
    }
    .progressShell{
      flex: 1 1 220px;
      height: 10px;
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      min-width: 220px;
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,176,90,1), rgba(80,170,255,1));
      transition: width .25s ease;
    }

    .hud{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }

    .hudbox{
      background: var(--glass);
      border: 1px solid rgba(255, 200, 150, .22);
      border-radius: 18px;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      position: relative;
      overflow:hidden;
      box-shadow: 0 18px 65px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
    }
    .hudbox::after{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      background:
        radial-gradient(420px 160px at 15% 0%, rgba(255,150,70,.18), transparent 60%),
        radial-gradient(520px 220px at 85% 120%, rgba(80,170,255,.10), transparent 60%);
      opacity:.9;
    }

    .profile{ display:flex; align-items:center; gap: 14px; min-width: 0; position: relative; z-index:2; }

    .avatarFrame{
      width: 92px; height: 92px; border-radius: 24px; padding: 4px;
      background: linear-gradient(180deg, rgba(255,150,70,.36), rgba(80,170,255,.14));
      box-shadow: 0 18px 42px rgba(0,0,0,.45);
      flex: 0 0 auto;
    }
    .avatar{
      width:100%; height:100%;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.12);
      object-fit: cover;
      object-position: 50% 6%;
      transform: scale(1.35);
      transform-origin: 50% 12%;
      background: rgba(255,255,255,.06);
    }

    .ptext{ min-width:0; }
    .pname{ font-weight: 950; font-size: 22px; line-height: 1.05; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; text-shadow: 0 14px 30px rgba(0,0,0,.55); }
    .prole{ margin-top: 4px; font-weight: 850; font-size: 13px; color: var(--muted); white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }

    .chip{
      background: rgba(255,150,70,.14);
      border: 1px solid rgba(255,150,70,.20);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 12.5px;
      font-weight: 950;
      white-space: nowrap;
      position: relative;
      z-index:2;
    }

    .stats{ display:flex; align-items:center; justify-content:flex-end; gap: 12px; flex-wrap: wrap; position: relative; z-index:2; }

    .pill{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 950;
      font-size: 13px;
      white-space: nowrap;
    }

    .timerPill{ padding: 8px 10px; gap: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18); }

    .ring{
      width: 40px; height: 40px; border-radius: 999px;
      background: conic-gradient(var(--gold) var(--p, 0%), rgba(255,255,255,.14) 0);
      display:grid; place-items:center;
      box-shadow: 0 0 0 5px rgba(255,200,80,.14), 0 0 28px rgba(255,200,80,.10);
      transition: box-shadow .2s ease;
    }
    .ringInner{
      width: 28px; height: 28px; border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      color: rgba(255,255,255,.9);
      font-size: 14px; font-weight: 950;
    }

    .timeText{ display:flex; align-items:center; gap: 8px; }
    .timeText .label{ font-size: 12px; font-weight: 900; color: rgba(255,255,255,.75); }
    .timeText .sec{ font-size: 16px; font-weight: 950; }

    .timerWarn .ring{
      background: conic-gradient(var(--gold) var(--p, 0%), rgba(255,255,255,.14) 0);
      box-shadow: 0 0 0 5px rgba(255,200,80,.18), 0 0 32px rgba(255,200,80,.14);
    }
    .timerDanger .ring{
      background: conic-gradient(var(--red) var(--p, 0%), rgba(255,255,255,.14) 0);
      box-shadow: 0 0 0 5px rgba(255,70,70,.20), 0 0 40px rgba(255,70,70,.18);
    }

    .stressWrap{
      width: 240px; height: 12px; border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .stressBar{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(45,200,120,.95), rgba(255,200,80,.95), rgba(255,70,70,.95));
      transition: width .25s ease;
    }

    .frame{
      background: var(--glass2);
      border: 1px solid rgba(255, 200, 150, .22);
      border-radius: 18px;
      padding: 18px;
      position: relative;
      overflow:hidden;
      box-shadow: 0 18px 70px rgba(0,0,0,.50);
      backdrop-filter: blur(12px);
    }
    .frame::after{
      content:"";
      position:absolute; inset:-2px; pointer-events:none;
      background:
        radial-gradient(800px 260px at 55% 0%, rgba(255,150,70,.16), transparent 60%),
        radial-gradient(760px 260px at 40% 120%, rgba(80,170,255,.10), transparent 60%);
      opacity:.9;
    }

    .qmeta{ position: relative; z-index:2; color: rgba(255,255,255,.70); font-size: 12px; font-weight: 950; letter-spacing: .35px; text-transform: uppercase; }
    .qtitle{ position: relative; z-index:2; margin-top: 6px; font-weight: 950; font-size: clamp(19px, 2.35vw, 28px); line-height: 1.2; text-shadow: 0 14px 30px rgba(0,0,0,.55); }
    .qdesc{ position: relative; z-index:2; margin-top: 10px; color: rgba(255,255,255,.85); font-size: 15px; line-height: 1.55; max-width: 1200px; }

    .options{ position: relative; z-index:2; display:flex; flex-direction:column; gap: 12px; margin-top: 16px; }

    .opt{
      border-radius: 14px;
      padding: 13px 14px;
      font-weight: 950;
      letter-spacing: .2px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, filter .12s ease, background .12s ease;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(80,170,255,.22), rgba(80,170,255,.14));
      box-shadow: 0 10px 28px rgba(0,0,0,.20);
    }
    .opt:hover{ transform: translateY(-1px); filter: brightness(1.07); background: linear-gradient(180deg, rgba(255,150,70,.22), rgba(80,170,255,.10)); }
    .opt:active{ transform: translateY(0px); filter: brightness(.98); }

    .opt.sel{
      background: linear-gradient(180deg, rgba(255,150,70,.30), rgba(255,120,50,.18));
      border-color: rgba(255,150,70,.30);
      box-shadow: 0 0 0 3px rgba(255,150,70,.10), 0 16px 34px rgba(0,0,0,.28);
    }

    /* ===== Actions layout ===== */
    .actions{
      display:flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      position: relative;
      z-index:2;
    }
    .actions-left,
    .actions-right{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btnNeo{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.90);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 950;
      letter-spacing: .2px;
      cursor: pointer;
    }

    .btnPrimary{
      border: none;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      color: rgba(10,12,18,.96);
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 950;
      letter-spacing: .2px;
      display:none;
      cursor: pointer;
    }
    .btnPrimary.show{ display:inline-block; }
    .btnPrimary:disabled{
      opacity:.45;
      filter: grayscale(.2);
      cursor: not-allowed;
    }

    .overlay{
      position: fixed; inset: 0;
      display:none; align-items:center; justify-content:center;
      z-index: 50;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
    }

    /* Loading overlay: transparent */
    #loadingOverlay{
      background: transparent !important;
      backdrop-filter: none !important;
    }

    .modalBox{
      width: min(760px, 92%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(8,10,14,.82);
      box-shadow: 0 26px 90px rgba(0,0,0,.62);
      overflow:hidden;
      position: relative;
    }

    .modalTop{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }

    .badgeState{
      font-weight: 950;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }
    .bGood{ border-color: rgba(45,200,120,.30); background: rgba(45,200,120,.12); }
    .bWarn{ border-color: rgba(255,200,80,.30); background: rgba(255,200,80,.12); }
    .bBad { border-color: rgba(255,70,70,.35); background: rgba(255,70,70,.12); }

    .modalBody{ padding: 16px; color: rgba(255,255,255,.92); line-height: 1.55; font-size: 15px; }
    .modalActions{
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex; justify-content:flex-end; gap: 10px; flex-wrap: wrap;
    }

    .startTitle{ font-weight: 950; font-size: 22px; margin-bottom: 6px; }
    .startText{ color: rgba(255,255,255,.85); font-size: 15px; line-height: 1.55; }
    .startBtn{
      border:none; border-radius: 14px; padding: 12px 16px;
      font-weight: 950; letter-spacing: .3px;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      color: rgba(10,12,18,.96);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      cursor: pointer;
    }

    .shake{ animation: shake .24s linear 1; }
    @keyframes shake{
      0% { transform: translateX(0px); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
      100%{ transform: translateX(0px); }
    }
    .pulseGood{ animation: pulseGood .32s ease 1; }
    @keyframes pulseGood{
      from{ box-shadow: 0 0 0 0 rgba(45,200,120,.0); }
      50%{ box-shadow: 0 0 0 7px rgba(45,200,120,.18); }
      to{ box-shadow: 0 0 0 0 rgba(45,200,120,.0); }
    }
    .flashBad{ animation: flashBad .30s ease 1; }
    @keyframes flashBad{
      from{ box-shadow: 0 0 0 0 rgba(255,70,70,.0); }
      50%{ box-shadow: 0 0 0 7px rgba(255,70,70,.22); }
      to{ box-shadow: 0 0 0 0 rgba(255,70,70,.0); }
    }

    @media (max-width: 980px){
      .hud{ grid-template-columns: 1fr; }
      .stressWrap{ width: 190px; }
      .progressShell{ min-width: 100%; }
    }

    /* Hotspot zones */
    @keyframes hsPulse {
      0% { box-shadow: 0 0 0 0 rgba(255,255,255,.25); border-color: rgba(255,255,255,.55); }
      70% { box-shadow: 0 0 0 14px rgba(255,255,255,0); border-color: rgba(255,255,255,.85); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); border-color: rgba(255,255,255,.55); }
    }
    .hotspot-zone{
      position:absolute;
      background: transparent !important;
      border: 2px solid rgba(255,255,255,.65);
      border-radius: 16px;
      padding:0;
      margin:0;
      cursor:pointer;
      animation: hsPulse 1.35s infinite;
    }
    .hotspot-zone.sel{
      border-color: rgba(34,197,94,.95);
      box-shadow: 0 0 0 6px rgba(34,197,94,.20);
      animation: none;
    }

    /* ‚úÖ Q4 images - r√©duire taille */
    .imgGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 980px){
      .imgGrid{ grid-template-columns: 1fr; }
    }
    .imgCard{
      border-radius:18px;
      overflow:hidden;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      transition:.15s ease;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
    }
    .imgCard:hover{ transform:translateY(-3px); filter:brightness(1.05); }
    .imgCard.sel{
      outline:3px solid rgba(255,165,0,.4);
      box-shadow:0 0 0 4px rgba(255,165,0,.25), 0 20px 40px rgba(0,0,0,.35);
    }
    .imgHead{
      padding:10px 14px;
      font-weight:950;
      display:flex;
      justify-content:space-between;
      background:linear-gradient(180deg, rgba(120,180,255,.25), rgba(120,180,255,.10));
      font-size: 13px;
    }
    .imgTag{
      width:32px;
      height:32px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      background:rgba(0,0,0,.25);
      font-size: 13px;
    }
    .imgPic{
      width:100%;
      height: 220px;              /* ‚úÖ plus petit */
      object-fit:cover;
      display:block;
    }
    .imgCap{
      padding:12px;
      text-align:center;
      font-weight:850;
      font-size: 13px;
    }

    /* ===== Corrig√© overlay ===== */
    .closeX{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      width: 36px; height: 36px;
      border-radius: 12px;
      display:grid; place-items:center;
      cursor:pointer;
      font-weight: 950;
      user-select:none;
    }
    .closeX:hover{ filter: brightness(1.08); }
	

    .keyBox{ width:min(980px, 95%); }
	/* ======= FIN / BADGE OBTENU (comme screenshot) ======= */
.resultWrap{ position:relative; z-index:2; margin-top: 6px; }
.resultMeta{
  font-size: 12px;
  font-weight: 950;
  letter-spacing: .35px;
  text-transform: uppercase;
  color: rgba(255,255,255,.72);
  margin-bottom: 8px;
}
.resultTitle{
  font-weight: 950;
  font-size: clamp(26px, 3vw, 38px);
  margin: 0 0 14px 0;
  text-shadow: 0 18px 40px rgba(0,0,0,.55);
}
.resultCard{
  display:flex;
  gap: 16px;
  align-items:center;
  padding: 14px 14px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  box-shadow: 0 18px 60px rgba(0,0,0,.35);
  overflow:hidden;
}
.badgeThumb{
  width: 74px;
  height: 74px;
  border-radius: 16px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  display:grid;
  place-items:center;
  overflow:hidden;
  flex: 0 0 auto;
}
.badgeThumb img{
  width: 52px;
  height: 52px;
  object-fit: contain;
  display:block;
}
.badgeText{ min-width:0; }
.badgeLine{
  font-weight: 950;
  font-size: 18px;
  line-height: 1.15;
}
.badgeSub{
  margin-top: 4px;
  color: rgba(255,255,255,.70);
  font-weight: 900;
  font-size: 13px;
}

.resultPills{
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}
.resultInfo{
  margin-top: 10px;
  font-weight: 900;
  color: rgba(255,255,255,.78);
  display:flex;
  align-items:center;
  gap: 8px;
}
.resultInfo .okDot{
  width: 10px; height: 10px; border-radius: 999px;
  background: rgba(45,200,120,.95);
  box-shadow: 0 0 0 5px rgba(45,200,120,.16);
}

.resultHero{
  margin-top: 14px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.12);
  background: linear-gradient(180deg, rgba(80,170,255,.22), rgba(80,170,255,.10));
  padding: 26px 16px;
  text-align:center;
  box-shadow: 0 18px 70px rgba(0,0,0,.35);
}
.heroBadge{
  width: 92px;
  height: 92px;
  border-radius: 22px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  display:grid;
  place-items:center;
  margin: 0 auto 12px auto;
}
.heroBadge img{
  width: 64px;
  height: 64px;
  object-fit: contain;
  display:block;
}
.heroTitle{
  font-weight: 950;
  font-size: 18px;
  margin: 0;
}
.heroSub{
  margin-top: 4px;
  font-weight: 900;
  color: rgba(255,255,255,.72);
}

  </style>
</head>

<body>
<div class="stage">
  <div class="wrap">

    <!-- TOP TAB + PROGRESS -->
    <div class="topTabs">
      <div class="levelTab" title="Niveau">
        <span class="levelDot"></span>
        <span id="levelTabText">NIVEAU : ‚Äî</span>
      </div>

      <div class="progressShell" title="Progression">
        <div class="progressBar" id="progressBar"></div>
      </div>

      <div class="miniHint" id="miniHint">‚è± ‚Äîs / question ‚Ä¢ ‚Äî tentatives ‚Ä¢ üí° ‚Äî indices</div>
    </div>

    <div class="hud">
      <div class="hudbox">
        <div class="profile">
          <div class="avatarFrame">
            <img class="avatar" id="hudAvatar" alt="Avatar">
          </div>
          <div class="ptext">
            <div class="pname" id="hudName">Joueur</div>
            <div class="prole" id="hudRole">R√¥le: ‚Äî</div>
          </div>
        </div>
        <div class="chip" id="difficultyChip">MODE: D√âBUTANT</div>
      </div>

      <div class="hudbox">
        <div class="stats">
          <div class="pill">‚≠ê <span id="hudScore">0</span></div>
          <div class="pill">Q <span id="hudQnum">1</span>/<span id="hudQtotal">10</span></div>
          <div class="pill">üéØ Tentatives <span id="hudAttempts">0</span>/<span id="hudAttemptsMax">3</span></div>

          <div class="pill timerPill" id="timerPill">
            <div class="ring" id="ring"><div class="ringInner">‚è±</div></div>
            <div class="timeText">
              <div class="label">Temps</div>
              <div class="sec"><span id="hudTime">30</span>s</div>
            </div>
          </div>

          <div class="stressWrap" title="Stress">
            <div class="stressBar" id="stressBar"></div>
          </div>

          <!-- Indice + Pause -->
          <button class="btnNeo" id="hintBtn" type="button">üí° Indice</button>
          <button class="btnNeo" id="pauseBtn" type="button">‚è∏ Pause</button>
        </div>
      </div>
    </div>

    <div class="frame" id="frame">
      <div class="qmeta" id="qMeta">Sc√©nario 1 ‚Äî √âtouffement</div>
      <div class="qtitle" id="qTitle">‚Ä¶</div>
      <div class="qdesc" id="qDesc">‚Ä¶</div>

      <div class="options" id="options"></div>

      <!-- Actions (corrig√© + terminer √† gauche) -->
      <div class="actions">
        <div class="actions-left">
          <button class="btnNeo" id="showKeyBtn" type="button" disabled>üìò Corrig√©</button>
          <button class="btnPrimary" id="endBtn" type="button" style="display:none;">‚úÖ Terminer</button>
        </div>

        <div class="actions-right">
          <button class="btnPrimary show" id="validateBtn" type="button" disabled>Valider</button>
          <button class="btnNeo" id="clearBtn" style="display:none;">Effacer</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- START overlay -->
<div class="overlay" id="startOverlay" style="display:flex;">
  <div class="modalBox">
    <div class="modalTop">
      <div class="badgeState bWarn">üéÆ Pr√™t ?</div>
      <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
        Mission ‚Ä¢ √âtouffement
      </div>
    </div>
    <div class="modalBody">
      <div class="startTitle">Tu as une mission.</div>
      <div class="startText" id="startText">
        Tu vas intervenir en situation d‚Äôurgence. Tu as peu de temps pour r√©pondre.
        <br><br>
        <b>Si le temps s‚Äô√©coule 3 fois ou apr√®s 3 tentatives rat√©es, tu retournes au d√©but de la mission (score = 0).</b>
        <br>
        Es-tu pr√™t √† commencer ?
      </div>
    </div>
    <div class="modalActions">
      <button class="startBtn" id="startBtn">D√âMARRER</button>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div class="overlay" id="loadingOverlay">
  <div class="modalBox" style="max-width:520px;">
    <div class="modalBody" style="text-align:center; padding:26px 16px;">
      <div style="font-weight:950; font-size:18px;">Chargement‚Ä¶</div>
      <div style="margin-top:8px; color:rgba(255,255,255,.75);">Pr√©paration de la prochaine √©tape</div>
    </div>
  </div>
</div>

<!-- Feedback overlay -->
<div class="overlay" id="overlay">
  <div class="modalBox" id="modalBox">
    <div class="modalTop">
      <div class="badgeState" id="badgeState">‚Äî</div>
      <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
        Score: <span id="modalScore">0</span> ‚Ä¢ Stress: <span id="modalStress">0</span>%
      </div>
    </div>
    <div class="modalBody" id="modalText">‚Ä¶</div>
    <div class="modalActions">
      <button class="btnNeo" id="retryBtn">R√©essayer</button>
      <button class="btnPrimary" id="nextBtn">Suivant</button>
      <button class="btnPrimary" id="okBtn" style="display:none;">OK</button>
    </div>
  </div>
</div>

<!-- ‚úÖ Corrig√© overlay -->
<div class="overlay" id="keyOverlay">
  <div class="modalBox keyBox">
    <div class="modalTop">
      <div class="badgeState bWarn">üìò Corrig√©</div>
      <div class="closeX" id="keyCloseBtn" title="Fermer">‚úï</div>
    </div>
    <div class="modalBody" id="keyBody" style="max-height:70vh; overflow:auto;"></div>
    <div class="modalActions">
      <button class="btnNeo" id="keyCloseBtn2" type="button">Fermer</button>
    </div>
  </div>
</div>

<script>
/* ========= SCENARIO ENGINE (Design Genially-like) ========= */
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function tone(freq, dur=0.08, type="sine", gain=0.05){
  ensureAudio();
  const t0 = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type; osc.frequency.value = freq;
  g.gain.value = gain;
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(t0); osc.stop(t0 + dur);
}
function sfxClick(){ tone(520,0.04,"triangle",0.035); }
function sfxCorrect(){ tone(660,0.07,"sine",0.06); setTimeout(()=>tone(880,0.08,"sine",0.06), 80); }
function sfxVictory(){
  ensureAudio();
  const notes = [
    {f:659,d:0.10},{f:784,d:0.10},{f:988,d:0.14},
    {f:1175,d:0.18},{f:988,d:0.14},{f:1047,d:0.22}
  ];
  let t = 0;
  notes.forEach((n)=>{ setTimeout(()=>tone(n.f, n.d, "sine", 0.065), t*1000); t += n.d + 0.03; });
}
function sfxWrong(){ tone(220,0.10,"square",0.05); setTimeout(()=>tone(180,0.12,"square",0.05), 90); }
function sfxCritical(){ tone(140,0.14,"sawtooth",0.05); setTimeout(()=>tone(120,0.16,"sawtooth",0.05), 120); }
function sfxAlarmLong(){
  ensureAudio();
  const now = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = "sawtooth";
  osc.frequency.setValueAtTime(520, now);
  osc.frequency.linearRampToValueAtTime(380, now + 0.35);
  osc.frequency.linearRampToValueAtTime(520, now + 0.70);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.07, now + 0.02);
  g.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(now); osc.stop(now + 1.25);
}

const el = (id)=>document.getElementById(id);
const hudName = el("hudName"), hudRole = el("hudRole"), hudAvatar = el("hudAvatar"), difficultyChip = el("difficultyChip");
const hudScore = el("hudScore"), hudQnum = el("hudQnum"), hudQtotal = el("hudQtotal"), hudAttempts = el("hudAttempts");
const hudAttemptsMaxEl = el("hudAttemptsMax");
const hudTime = el("hudTime"), ring = el("ring"), timerPill = el("timerPill"), stressBar = el("stressBar");
const qMeta = el("qMeta"), qTitle = el("qTitle"), qDesc  = el("qDesc"), optionsEl = el("options");
const validateBtn = el("validateBtn"), clearBtn = el("clearBtn");
const startOverlay = el("startOverlay"), startBtn = el("startBtn");
const startText = el("startText");
const loadingOverlay = el("loadingOverlay");
const overlay = el("overlay"), modalBox = el("modalBox"), badgeState = el("badgeState"), modalText = el("modalText");
const modalScore = el("modalScore"), modalStress = el("modalStress");
const retryBtn = el("retryBtn"), nextBtn = el("nextBtn"), okBtn = el("okBtn"), frame = el("frame");

const pauseBtn = el("pauseBtn");
const hintBtn = el("hintBtn");
const progressBar = el("progressBar");
const levelTabText = el("levelTabText");
const showKeyBtn = el("showKeyBtn");
const endBtn = el("endBtn");
const miniHint = el("miniHint");

const keyOverlay = el("keyOverlay");
const keyBody = el("keyBody");
const keyCloseBtn = el("keyCloseBtn");
const keyCloseBtn2 = el("keyCloseBtn2");

/* ======= CONFIG ======= */
const SCENARIO = {
  id: 1,
  label: "Sc√©nario 1 ‚Äî √âtouffement",
  mission: "√âtouffement",
  level: "Niveau d√©butant"
};

// ‚úÖ URL du sc√©nario suivant (remplace par ton lien)
const NEXT_SCENARIO_URL = "#";

const STRESS_RULES = { wrong: 10, timeout: 15, critical: 25 };

const role = "infirmier";

/* ‚úÖ Nom affich√© : "Dr. + player_name" */
const player_name = localStorage.getItem("playerName") || "Joueur";
const avatarFile = localStorage.getItem("avatar") || "infirmier_f.png";

/* ‚úÖ Niveau choisi : variable `niveau` (sinon localStorage) */
const difficultyRaw = (typeof window.niveau !== "undefined" && window.niveau)
  ? String(window.niveau)
  : (localStorage.getItem("niveau") || localStorage.getItem("difficulty") || "d√©butant");

const difficulty = String(difficultyRaw).toLowerCase();
const roleLabelMap = { medecin:"M√©decin", infirmier:"Infirmier", pompier:"Pompier" };

hudName.textContent = "Dr. " + player_name;
hudRole.textContent = "R√¥le: " + (roleLabelMap[role] || "‚Äî");
hudAvatar.src = "assets/avatars/" + avatarFile;

difficultyChip.textContent = "MODE: " + difficulty.toUpperCase();
levelTabText.textContent = "NIVEAU : " + difficulty.toUpperCase();

/* ‚úÖ R√®gles par niveau (comme ton code pr√©c√©dent) */
let TIMER_SECONDS = 60;
let ATTEMPTS_MAX = 3;
let HINT_MAX = 3;

if(difficulty.includes("inter")){
  TIMER_SECONDS = 45;
  ATTEMPTS_MAX = 2;
  HINT_MAX = 2;
}
if(difficulty.includes("expert")){
  TIMER_SECONDS = 30;
  ATTEMPTS_MAX = 1;
  HINT_MAX = 1;
}

hudAttemptsMaxEl.textContent = String(ATTEMPTS_MAX);
miniHint.textContent = `‚è± ${TIMER_SECONDS}s / question ‚Ä¢ ${ATTEMPTS_MAX} tentative${ATTEMPTS_MAX>1?"s":""} ‚Ä¢ üí° ${HINT_MAX} indice${HINT_MAX>1?"s":""}`;

/* ‚úÖ Indices : total sc√©nario + 1 seul indice par question */
const HINT_KEY = `hints_left_s${SCENARIO.id}`;
let hintsLeft = parseInt(localStorage.getItem(HINT_KEY) ?? String(HINT_MAX), 10);
if(isNaN(hintsLeft)) hintsLeft = HINT_MAX;
hintsLeft = Math.max(0, Math.min(HINT_MAX, hintsLeft));

let hintUsedThisQuestion = false;

/* ===== Score / Stress ===== */
let score = parseInt(localStorage.getItem("score") || "0", 10);
let stress = parseInt(localStorage.getItem("stress") || "0", 10);
if(isNaN(score)) score = 0;
if(isNaN(stress)) stress = 0;

let idx = 0;
let attemptsForCurrentQuestion = 0;
let locked = true;
let timerId = null;
let timeLeft = TIMER_SECONDS;

/* ======= QUESTIONS (NE PAS TOUCHER) ======= */
const questions = [{"type": "single", "title": "√âvaluation infirmi√®re", "desc": "En tant qu‚Äô**infirmier(√®re)**, tu observes : victime consciente, mains √† la gorge, ne peut pas parler, toux faible. Quelle situation ?", "options": [{"text": "Obstruction grave des voies a√©riennes (√©touffement grave)", "kind": "ok", "fb": "‚úÖ Oui : incapacit√© √† parler + toux inefficace = obstruction grave."}, {"text": "Obstruction l√©g√®re (toux efficace)", "kind": "wrong", "fb": "‚ùå Non : la toux est faible/inefficace."}, {"text": "Crise d‚Äôangoisse", "kind": "wrong", "fb": "‚ùå Non : les signes sont typiques d‚Äôune obstruction."}, {"text": "Malaise vagal", "kind": "wrong", "fb": "‚ùå Non : priorit√© = obstruction."}]}, {"type": "tf", "title": "Toux efficace", "desc": "Vrai ou faux : si la victime tousse fort et peut parler, on fait Heimlich imm√©diatement. (Indice : toux efficace = on surveille)", "tf": {"trueOpt": {"kind": "wrong", "fb": "‚ùå Faux : toux efficace ‚Üí encourager la toux, surveiller."}, "falseOpt": {"kind": "ok", "fb": "‚úÖ Exact : on encourage la toux et on surveille."}}}, {"type": "multi", "title": "Actions infirmi√®res adapt√©es", "desc": "S√©lectionne **toutes** les bonnes actions.", "options": [{"text": "Observer : parole / toux / respiration", "correct": true}, {"text": "Rassurer et rester avec la victime", "correct": true}, {"text": "Faire boire pour ‚Äúaider √† avaler‚Äù", "correct": false}, {"text": "Demander √† quelqu‚Äôun d‚Äôalerter (SAMU)", "correct": true}], "okFb": "‚úÖ Bien : observation + rassurer + alerte.", "badFb": "‚ùå Non : boire est dangereux en √©touffement."}, {"type": "image_single", "title": "Choix de l‚Äôimage", "desc": "Quel visuel correspond au **bon** geste initial (adulte conscient, obstruction grave) ?<br>", "options": [{"label": "A", "caption": "Bouche-√†-bouche imm√©diat", "kind": "wrong", "fb": "‚ùå Non : la victime est consciente, priorit√© √† la d√©sobstruction.", "imgSrc": "assets/q4_a.png"}, {"label": "B", "caption": "5 claques dorsales", "kind": "ok", "fb": "‚úÖ Oui : on commence par les claques dorsales.", "imgSrc": "assets/q4_b.png"}, {"label": "C", "caption": "Victime allong√©e sur le dos", "kind": "wrong", "fb": "‚ùå Non : on garde la victime pench√©e en avant pour les claques.", "imgSrc": "assets/q4_c.png"}]}, {"type": "drag_order", "title": "Ordonner la conduite √† tenir", "desc": "Glisse les √©tapes dans le bon ordre.", "items": [{"id": "eval", "text": "√âvaluer : parler / tousser / respirer"}, {"id": "lean", "text": "Pencher la victime en avant"}, {"id": "back", "text": "Donner 5 claques dorsales"}, {"id": "abd", "text": "Donner 5 compressions abdominales"}, {"id": "call", "text": "Alerter / demander de l‚Äôaide"}], "expected": ["eval", "lean", "back", "abd", "call"], "okFb": "‚úÖ Ordre correct.", "badFb": "‚ùå Ordre incorrect."}, {"type": "cloze", "title": "Texte √† trous", "desc": "√âcris uniquement les nombres.", "template": "On r√©alise <b>{blank1}</b> claques dorsales puis <b>{blank2}</b> compressions abdominales.", "blanks": [{"key": "blank1", "answer": "5"}, {"key": "blank2", "answer": "5"}], "okFb": "‚úÖ 5 puis 5.", "badFb": "‚ùå Attendu : 5 puis 5."}, {"type": "short", "title": "Alerte", "desc": "Quel est le num√©ro du SAMU au Maroc ? (3 chiffres)", "answers": ["141"], "okFb": "‚úÖ SAMU = 141.", "badFb": "‚ùå Attendu : 141."}, {"type": "single", "title": "Pi√®ge √† √©viter", "desc": "Choisis la meilleure r√©ponse.", "options": [{"text": "Balayage du doigt √† l‚Äôaveugle", "kind": "critical", "fb": "üö® Danger : peut enfoncer l‚Äôobjet plus loin.", "pts": -10}, {"text": "Retirer un objet visible et accessible", "kind": "ok", "fb": "‚úÖ Oui, seulement si visible."}, {"text": "Encourager la toux si elle est efficace", "kind": "ok", "fb": "‚úÖ Oui, si toux efficace."}, {"text": "Tapoter doucement le dos sans pencher", "kind": "wrong", "fb": "‚ùå Non : il faut pencher et donner des claques efficaces."}]}, {"type": "hotspot", "gate": true, "title": "Hotspot ‚Äî O√π se situe le probl√®me ?", "desc": "", "imgSrc": "scenario_1_hotspot.png", "hotspots": [{"label": "Zone correcte", "x": 38.29, "y": 45.07, "w": 23.21, "h": 23.98, "kind": "ok", "fb": "‚úÖ Correct : zone de la gorge (√©touffement).", "pts": 10}, {"label": "Zone fausse", "x": 46.63, "y": 13.35, "w": 22.22, "h": 27.08, "kind": "wrong", "fb": "‚ùå Faux : ce n‚Äôest pas la bonne zone.", "pts": -2}, {"label": "Zone fausse", "x": 55.16, "y": 78.72, "w": 25.79, "h": 19.15, "kind": "wrong", "fb": "‚ùå Faux : ce n‚Äôest pas la bonne zone.", "pts": -2}]}, {"type": "multi", "title": "Apr√®s les gestes", "desc": "S√©lectionne toutes les r√©ponses correctes.", "options": [{"text": "Surveiller la respiration apr√®s am√©lioration", "correct": true}, {"text": "Alerter si l‚Äôobjet ne sort pas", "correct": true}, {"text": "Donner √† manger pour tester", "correct": false}, {"text": "Rassurer la victime", "correct": true}], "okFb": "‚úÖ Correct.", "badFb": "‚ùå Ne jamais faire manger/boire."}];

const TOTAL = questions.length;
hudQtotal.textContent = String(TOTAL);

/* ===== Helpers ===== */
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function setScore(v){
  score=v;
  localStorage.setItem("score", String(score));
  hudScore.textContent=String(score);
  modalScore.textContent=String(score);
}
function addScore(d){ setScore(score + d); }
function setStress(v){
  stress=clamp(v,0,100);
  localStorage.setItem("stress", String(stress));
  stressBar.style.width=stress+"%";
  modalStress.textContent=String(stress);
}
function addStress(d){
  const factor = (stress >= 70) ? 0.7 : 1;
  setStress(stress + Math.round(d*factor));
}
function setAttemptsUI(){ hudAttempts.textContent = String(attemptsForCurrentQuestion); }

/* Progress */
function updateProgress(){
  const p = Math.round((idx / TOTAL) * 100);
  if(progressBar) progressBar.style.width = p + "%";
}

/* ===== TIMER ===== */
function setRingProgress(){
  const p = clamp(Math.round((timeLeft / TIMER_SECONDS) * 100), 0, 100);
  ring.style.setProperty("--p", p + "%");
  timerPill.classList.remove("timerWarn","timerDanger");
  if(timeLeft <= 5) timerPill.classList.add("timerDanger");
  else if(timeLeft <= 10) timerPill.classList.add("timerWarn");
}
function stopTimer(){ clearInterval(timerId); timerId=null; }

function startTimer(reset=true){
  stopTimer();
  if(reset) timeLeft = TIMER_SECONDS;
  hudTime.textContent = String(timeLeft);
  setRingProgress();

  timerId = setInterval(()=>{
    if(locked) return;
    timeLeft--;
    hudTime.textContent = String(timeLeft);
    setRingProgress();

    if(timeLeft <= 0){
      stopTimer();
      sfxAlarmLong();

      addStress(STRESS_RULES.timeout);
      attemptsForCurrentQuestion++;
      setAttemptsUI();

      if(attemptsForCurrentQuestion >= ATTEMPTS_MAX){
        missionFail(`‚è±Ô∏è Temps √©coul√© (${ATTEMPTS_MAX} fois). Mission √©chou√©e. Retour au d√©part‚Ä¶ (score remis √† z√©ro)`);
      }else{
        showOverlay("warn", `‚è±Ô∏è Temps √©coul√©. (Tentative ${attemptsForCurrentQuestion}/${ATTEMPTS_MAX})`, {allowRetry:true, allowNext:false, missionFail:false});
      }
    }
  }, 1000);
}

/* ======= SELECTION STATE ======= */
let selectedSingle = null;
let multiSelected = new Set();
let inputValue = "";
let clozeValues = {};

function resetState(){
  selectedSingle=null;
  multiSelected.clear();
  inputValue="";
  clozeValues={};
  validateBtn.disabled=true;
}

function mkOpt(text){
  const d = document.createElement("div");
  d.className="opt";
  d.textContent=text;
  return d;
}

/* ‚úÖ Loading (temps de passage r√©duit) */
function showLoading(ms=800){
  frame.style.visibility = "hidden";
  loadingOverlay.style.display = "flex";
  return new Promise(res=>{
    setTimeout(()=>{
      loadingOverlay.style.display="none";
      frame.style.visibility = "visible";
      res();
    }, ms);
  });
}

/* Safety HTML */
function escapeHtml(str){
  return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function nl2brSafe(str){
  return escapeHtml(str).replaceAll("\n","<br>");
}

/* ===== INDICE (total sc√©nario + 1 par question) ===== */
function updateHintBtn(){
  const used = hintUsedThisQuestion ? "‚úî" : "";
  hintBtn.textContent = `üí° Indice (${hintsLeft}) ${used}`.trim();
  hintBtn.disabled = (hintsLeft <= 0) || locked || hintUsedThisQuestion;
  hintBtn.style.opacity = hintBtn.disabled ? ".55" : "1";
}

function getHintForQuestion(q){
  if(q.hint) return q.hint;
  if(q.type==="single"){
    const ok = (q.options||[]).find(o=>o.kind==="ok");
    const words = (ok?.text || "").split(/\s+/).slice(0,6).join(" ");
    return `Indice : la bonne r√©ponse commence par ‚Äú${words}‚Ä¶‚Äù.`;
  }
  if(q.type==="tf"){
    const ans = (q.tf?.trueOpt?.kind==="ok") ? "Vrai" : "Faux";
    return `Indice : la bonne r√©ponse est ‚Äú${ans}‚Äù.`;
  }
  if(q.type==="multi"){
    const n = (q.options||[]).filter(o=>o.correct).length;
    return `Indice : il y a ${n} propositions correctes √† s√©lectionner.`;
  }
  if(q.type==="image_single"){
    const ok = (q.options||[]).find(o=>o.kind==="ok");
    return `Indice : observe l‚Äôoption ${ok?.label || "?"} (geste initial).`;
  }
  if(q.type==="drag_order"){
    const firstId = q.expected?.[0];
    const firstText = (q.items||[]).find(it=>it.id===firstId)?.text || "√âvaluer";
    return `Indice : la premi√®re √©tape est : ‚Äú${firstText}‚Äù.`;
  }
  if(q.type==="cloze"){
    const ans = q.blanks?.[0]?.answer || "";
    return `Indice : le premier trou commence par ‚Äú${String(ans).slice(0,1)}‚Ä¶‚Äù.`;
  }
  if(q.type==="short"){
    const ans = String(q.answers?.[0] ?? "");
    return `Indice : la r√©ponse commence par ‚Äú${ans.slice(0,1)}‚Ä¶‚Äù.`;
  }
  if(q.type==="hotspot"){
    return "Indice : cible la zone de la gorge / voies a√©riennes.";
  }
  return "Indice : relis bien les mots-cl√©s de la situation.";
}

hintBtn.onclick = ()=>{
  if(locked) return;
  if(hintsLeft <= 0) return;
  if(hintUsedThisQuestion) return; // ‚úÖ un indice max par question

  sfxClick();
  stopTimer();
  locked = true;

  hintsLeft--;
  hintUsedThisQuestion = true;
  localStorage.setItem(HINT_KEY, String(hintsLeft));
  updateHintBtn();

  const q = questions[idx];
  const hint = getHintForQuestion(q);

  showOverlay("warn", "üí° " + hint, {allowRetry:false, allowNext:false, missionFail:false});

  retryBtn.style.display="none";
  nextBtn.style.display="none";
  okBtn.style.display="inline-block"; okBtn.classList.add("show");
  okBtn.textContent="OK";
  okBtn.onclick = ()=>{ hideOverlay(); locked=false; startTimer(false); };
};

/* ===== Render question ===== */
function renderQuestion(i, resetAttempts=true){
  locked=false;
  stopTimer();
  hideOverlay();

  if(resetAttempts){ attemptsForCurrentQuestion=0; setAttemptsUI(); }
  hintUsedThisQuestion = false; // ‚úÖ reset 1 indice/question

  resetState();

  const q = questions[i];
  qMeta.textContent = SCENARIO.label + " ‚Ä¢ " + SCENARIO.level;
  qTitle.textContent = q.title || "‚Äî";

  // ‚úÖ Pour "mettre en ordre": on ne montre pas la phrase "Glisse les √©tapes..." (sans toucher les questions)
  if(q.type === "drag_order"){
    qDesc.innerHTML = "";
  }else{
    qDesc.innerHTML = q.desc || "";
  }

  optionsEl.innerHTML = "";
  clearBtn.style.display = "none";

  const type = q.type;

  if(type==="single"){
    q.options.forEach((opt, oi)=>{
      const d = mkOpt(opt.text);
      d.onclick=()=>{
        sfxClick();
        [...optionsEl.children].forEach(x=>x.classList.remove("sel"));
        d.classList.add("sel");
        selectedSingle=oi;
        validateBtn.disabled=false;
      };
      optionsEl.appendChild(d);
    });
  }

  if(type==="tf"){
    const opts=[{label:"Vrai",data:q.tf.trueOpt},{label:"Faux",data:q.tf.falseOpt}];
    opts.forEach((o, oi)=>{
      const d = mkOpt(o.label);
      d.onclick=()=>{
        sfxClick();
        [...optionsEl.children].forEach(x=>x.classList.remove("sel"));
        d.classList.add("sel");
        selectedSingle=oi;
        validateBtn.disabled=false;
      };
      optionsEl.appendChild(d);
    });
  }

  if(type==="multi"){
    clearBtn.style.display="inline-block";
    q.options.forEach((opt, oi)=>{
      const d=mkOpt(opt.text);
      d.onclick=()=>{
        sfxClick();
        if(multiSelected.has(oi)){ multiSelected.delete(oi); d.classList.remove("sel"); }
        else { multiSelected.add(oi); d.classList.add("sel"); }
        validateBtn.disabled = (multiSelected.size===0);
      };
      optionsEl.appendChild(d);
    });
  }

  if(type==="short"){
    clearBtn.style.display="inline-block";
    const box = document.createElement("div");
    box.className="opt"; box.style.cursor="default";
    box.innerHTML = `
      <div style="font-weight:950; margin-bottom:8px;">Ta r√©ponse</div>
      <input id="shortInput" class="form-control" type="text" placeholder="√âcris ici‚Ä¶"
        style="background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.18); color: rgba(255,255,255,.92); font-weight:900;" />
      <div style="margin-top:8px; font-size:12px; color: rgba(255,255,255,.72);">Astuce : une valeur courte suffit.</div>
    `;
    optionsEl.appendChild(box);
    const inp = box.querySelector("#shortInput");
    inp.addEventListener("input", ()=>{
      inputValue = inp.value;
      validateBtn.disabled = (inp.value.trim().length===0);
    });
  }

  if(type==="image_single"){
    const grid = document.createElement("div");
    grid.className = "imgGrid";

    q.options.forEach((opt, oi)=>{
      const card = document.createElement("div");
      card.className = "imgCard";
      card.innerHTML = `
        <div class="imgHead">
          <div>Option ${opt.label}</div>
          <div class="imgTag">${opt.label}</div>
        </div>
        <img class="imgPic" src="${opt.imgSrc}" alt="Option ${opt.label}">
        <div class="imgCap">${opt.caption}</div>
      `;
      card.onclick = ()=>{
        sfxClick();
        [...grid.querySelectorAll(".imgCard")].forEach(c=>c.classList.remove("sel"));
        card.classList.add("sel");
        selectedSingle = oi;
        validateBtn.disabled = false;
      };
      grid.appendChild(card);
    });

    optionsEl.appendChild(grid);
  }

  if(type==="hotspot"){
    clearBtn.style.display="inline-block";

    const msg = document.createElement("div");
    msg.className="pill";
    msg.style.marginBottom="10px";
    msg.innerHTML = "üéØ <b>Clique sur la zone correcte</b> sur l‚Äôimage, puis appuie sur <b>Valider</b>.";
    optionsEl.appendChild(msg);

    const wrap = document.createElement("div");
    wrap.style.position="relative";
    wrap.style.width="100%";
    wrap.style.maxWidth="760px";
    wrap.style.margin="0 auto";
    wrap.style.borderRadius="18px";
    wrap.style.overflow="hidden";
    wrap.style.border="1px solid rgba(255,255,255,.14)";
    wrap.style.background="rgba(0,0,0,.18)";
    wrap.innerHTML = q.svg
      ? q.svg
      : `<img src="${q.imgSrc||""}" alt="hotspot" style="width:100%; height:auto; display:block;">`;
    optionsEl.appendChild(wrap);

    const zones = document.createElement("div");
    zones.style.position="absolute";
    zones.style.inset="0";
    zones.style.pointerEvents="auto";
    wrap.appendChild(zones);

    selectedSingle = null;
    validateBtn.disabled = true;

    (q.hotspots||[]).forEach((h, hi)=>{
      const z = document.createElement("button");
      z.type="button";
      z.className="hotspot-zone";
      z.style.left = h.x + "%";
      z.style.top  = h.y + "%";
      z.style.width = h.w + "%";
      z.style.height= h.h + "%";
      z.style.borderRadius = (h.r||16) + "px";
      z.style.pointerEvents="auto";

      z.onclick=()=>{
        sfxClick();
        [...zones.querySelectorAll("button")].forEach(b=>b.classList.remove("sel"));
        z.classList.add("sel");
        selectedSingle = hi;
        validateBtn.disabled = false;
      };
      zones.appendChild(z);
    });
  }

  if(type==="drag_order"){
    clearBtn.style.display="inline-block";

    // ‚úÖ enlever la phrase et rendre plus discret
    const note = document.createElement("div");
    note.className="pill";
    note.style.marginBottom="10px";
    note.innerHTML = "üñ±Ô∏è <b>Mets les cartes dans l‚Äôordre</b>, puis clique sur <b>Valider</b>.";
    optionsEl.appendChild(note);

    const list = document.createElement("div");
    list.id="dragList";
    list.style.display="grid";
    list.style.gap="10px";

    const items = [...q.items];
    for(let k=items.length-1;k>0;k--){
      const j=Math.floor(Math.random()*(k+1));
      [items[k],items[j]]=[items[j],items[k]];
    }

    items.forEach((it)=>{
      const row = document.createElement("div");
      row.className="opt";
      row.setAttribute("draggable","true");
      row.dataset.id = it.id;

      // ‚úÖ "(glisser)" d√©plac√© √† l'extr√©mit√© droite
      row.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div style="font-weight:950;">${it.text}</div>
          <div style="font-size:12px; color: rgba(255,255,255,.72); font-weight:950;">glisser</div>
        </div>
      `;
      list.appendChild(row);
    });
    optionsEl.appendChild(list);

    let dragSrc = null;
    list.addEventListener("dragstart",(e)=>{
      const target = e.target.closest("[draggable='true']");
      if(!target) return;
      dragSrc = target;
      e.dataTransfer.effectAllowed="move";
      target.style.opacity="0.6";
    });
    list.addEventListener("dragend",(e)=>{
      const target = e.target.closest("[draggable='true']");
      if(target) target.style.opacity="1";
      dragSrc=null;
    });
    list.addEventListener("dragover",(e)=>{
      e.preventDefault();
      e.dataTransfer.dropEffect="move";
      const over = e.target.closest("[draggable='true']");
      if(!over || !dragSrc || over===dragSrc) return;
      const rect = over.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      list.insertBefore(dragSrc, before ? over : over.nextSibling);
    });
    list.addEventListener("drop",(e)=>{
      e.preventDefault();
      validateBtn.disabled=false;
    });
  }

  if(type==="cloze"){
    clearBtn.style.display="inline-block";
    const box = document.createElement("div");
    box.className="opt"; box.style.cursor="default";
    const html = q.template
      .replace("{blank1}", `<input data-k="blank1" class="form-control"
        style="display:inline-block; width:220px; margin:0 6px; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.18); color: rgba(255,255,255,.92); font-weight:900;" placeholder="..." />`)
      .replace("{blank2}", `<input data-k="blank2" class="form-control"
        style="display:inline-block; width:240px; margin:0 6px; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.18); color: rgba(255,255,255,.92); font-weight:900;" placeholder="..." />`);
    box.innerHTML = `<div style="line-height:1.9; font-size:15px;">${html}</div>`;
    optionsEl.appendChild(box);
    const inputs = box.querySelectorAll("input[data-k]");
    inputs.forEach(inp=>{
      inp.addEventListener("input", ()=>{
        clozeValues[inp.dataset.k] = inp.value;
        const filled = q.blanks.every(b => (clozeValues[b.key]||"").trim().length>0);
        validateBtn.disabled = !filled;
      });
    });
  }

  hudQnum.textContent = String(i+1);
  updateProgress();
  updateHintBtn();
  startTimer(true);
}

clearBtn.onclick = ()=>{ sfxClick(); renderQuestion(idx, false); };

/* Pause */
let paused = false;
pauseBtn.onclick = ()=>{
  sfxClick();
  paused = !paused;
  pauseBtn.textContent = paused ? "‚ñ∂ Reprendre" : "‚è∏ Pause";
  locked = paused ? true : false;
  updateHintBtn();

  if(!paused) startTimer(false);
  else stopTimer();
};

/* Validate */
validateBtn.onclick = ()=>{
  if(locked) return;

  const q = questions[idx];
  const type = q.type;

  const needSelection = (msg)=>{
    sfxClick();
    stopTimer();
    locked = true;

    showOverlay("warn", msg, {allowRetry:false, allowNext:false, missionFail:false});
    retryBtn.style.display="none";
    nextBtn.style.display="none";
    okBtn.style.display="inline-block"; okBtn.classList.add("show");
    okBtn.textContent="OK";
    okBtn.onclick = ()=>{ hideOverlay(); locked=false; startTimer(false); };
  };

  if(type==="single" || type==="tf" || type==="image_single" || type==="hotspot"){
    if(selectedSingle===null){ needSelection("Choisis une r√©ponse avant de valider."); return; }
  }
  if(type==="multi"){
    if(multiSelected.size===0){ needSelection("S√©lectionne au moins une proposition avant de valider."); return; }
  }
  if(type==="short"){
    if((inputValue||"").trim().length===0){ needSelection("√âcris une r√©ponse avant de valider."); return; }
  }
  if(type==="cloze"){
    const filled = q.blanks.every(b => ((clozeValues[b.key]||"").trim().length>0));
    if(!filled){ needSelection("Compl√®te tous les trous avant de valider."); return; }
  }

  stopTimer();
  locked=true;

  if(type==="single"){ evaluateOption(q.options[selectedSingle]); return; }
  if(type==="tf"){
    const opt = (selectedSingle===0) ? q.tf.trueOpt : q.tf.falseOpt;
    evaluateOption(opt); return;
  }
  if(type==="multi"){
    const chosen=[...multiSelected].sort((a,b)=>a-b);
    const correctIdx=q.options.map((o,i)=>o.correct?i:null).filter(v=>v!==null);
    const ok = chosen.length===correctIdx.length && chosen.every((v,i)=>v===correctIdx[i]);
    if(ok){
      addScore(10);
      showOverlay("good", q.okFb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå Incorrect.");
    }
    return;
  }
  if(type==="short"){
    const norm=(inputValue||"").trim().toLowerCase();
    const accepted=(q.answers||[]).map(a=>String(a).trim().toLowerCase());
    const ok = accepted.includes(norm);
    if(ok){
      addScore(10);
      showOverlay("good", q.okFb || "‚úÖ Bonne r√©ponse.", {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå R√©ponse incorrecte.");
    }
    return;
  }
  if(type==="image_single"){ evaluateOption(q.options[selectedSingle]); return; }
  if(type==="hotspot"){
    const h = (q.hotspots||[])[selectedSingle];
    if(!h){ locked=false; startTimer(false); return; }

    if(h.kind==="ok"){
      addScore(h.pts ?? 10);
      showOverlay("good", h.fb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else if(h.kind==="critical"){
      addStress(STRESS_RULES.critical);
      addScore(h.pts ?? -10);
      sfxCritical(); motion("critical");
      failedAttempt(h.fb || "üö® Erreur critique.");
    }else{
      addStress(STRESS_RULES.wrong);
      addScore(h.pts ?? 0);
      sfxWrong(); motion("wrong");
      failedAttempt(h.fb || "‚ùå Incorrect.");
    }
    return;
  }
  if(type==="drag_order"){
    const list = document.getElementById("dragList");
    const order = [...list.querySelectorAll("[draggable='true']")].map(x=>x.dataset.id);
    const ok = order.length===q.expected.length && q.expected.every((v,i)=>order[i]===v);
    if(ok){
      addScore(10);
      showOverlay("good", q.okFb || "‚úÖ Bon ordre.", {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå Ordre incorrect.");
    }
    return;
  }
  if(type==="cloze"){
    const ok = q.blanks.every(b => ((clozeValues[b.key]||"").trim().toLowerCase() === b.answer.trim().toLowerCase()));
    if(ok){
      addScore(10);
      showOverlay("good", q.okFb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå Texte incorrect.");
    }
    return;
  }
};

function evaluateOption(opt){
  if(opt.kind==="ok"){
    addScore(opt.pts ?? 10);
    showOverlay("good", opt.fb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
    sfxCorrect(); motion("good"); return;
  }
  if(opt.kind==="critical"){
    addStress(STRESS_RULES.critical);
    addScore(opt.pts ?? -10);
    sfxCritical(); motion("critical");
    failedAttempt(opt.fb || "üö® Erreur critique."); return;
  }
  addStress(STRESS_RULES.wrong);
  sfxWrong(); motion("wrong");
  failedAttempt(opt.fb || "‚ùå Incorrect.");
}

function failedAttempt(baseMsg){
  attemptsForCurrentQuestion++;
  setAttemptsUI();

  if(attemptsForCurrentQuestion >= ATTEMPTS_MAX){
    sfxAlarmLong();
    missionFail(`‚ùå ${ATTEMPTS_MAX} tentative${ATTEMPTS_MAX>1?"s":""} rat√©e${ATTEMPTS_MAX>1?"s":""}. Mission √©chou√©e. Retour au d√©part‚Ä¶ (score remis √† z√©ro)`);
    return;
  }
  showOverlay("warn", `${baseMsg} (Tentative ${attemptsForCurrentQuestion}/${ATTEMPTS_MAX})`, {allowRetry:true, allowNext:false, missionFail:false});
}

function showOverlay(kind, text, {allowRetry, allowNext, missionFail}){
  badgeState.className="badgeState";
  if(kind==="good"){ badgeState.classList.add("bGood"); badgeState.textContent="‚úÖ Bonne r√©ponse"; }
  if(kind==="warn"){ badgeState.classList.add("bWarn"); badgeState.textContent="‚ö†Ô∏è √Ä corriger"; }
  if(kind==="bad") { badgeState.classList.add("bBad");  badgeState.textContent="üö® Mission √©chou√©e"; }

  modalText.innerHTML = nl2brSafe(text);
  overlay.style.display="flex";

  retryBtn.style.display = allowRetry ? "inline-block" : "none";
  nextBtn.style.display  = allowNext  ? "inline-block" : "none";
  nextBtn.classList.toggle("show", !!allowNext);

  okBtn.style.display="none"; okBtn.onclick=null;

  retryBtn.onclick = ()=>{ hideOverlay(); locked=false; startTimer(false); };

  nextBtn.onclick  = async ()=>{
    hideOverlay();
    idx++;
    if(idx < TOTAL){
      await showLoading(800);
      renderQuestion(idx,true);
    }else{
      endScenario();
    }
  };

  if(missionFail){
    retryBtn.style.display="none"; nextBtn.style.display="none";
    okBtn.style.display="inline-block"; okBtn.classList.add("show");
    okBtn.onclick = ()=>{ hideOverlay(); resetMission(true); };
  }
}
function hideOverlay(){ overlay.style.display="none"; }

function missionFail(message){
  stopTimer();
  showOverlay("bad", message, {allowRetry:false, allowNext:false, missionFail:true});
  motion("critical");
}

function resetMission(showStart=true){
  stopTimer();
  idx=0;
  attemptsForCurrentQuestion=0;
  setAttemptsUI();
  setScore(0);
  setStress(0);

  // reset hints
  hintsLeft = HINT_MAX;
  localStorage.setItem(HINT_KEY, String(hintsLeft));
  hintUsedThisQuestion = false;
  updateHintBtn();

  // reset UI end buttons
  showKeyBtn.disabled = true;
  endBtn.style.display = "none";

  locked=true;
  updateProgress();
  timeLeft = TIMER_SECONDS;
  setRingProgress();
  hudTime.textContent = String(TIMER_SECONDS);

  if(showStart) startOverlay.style.display="flex";
}

/* ===== Corrig√© modal ===== */
function buildAnswerKeyHtml(){
  const rows = questions.map((q, i)=>{
    let ans = "";
    if(q.type==="single" || q.type==="image_single"){
      const oi = q.options.findIndex(o=>o.kind==="ok");
      if(q.type==="image_single"){
        ans = oi>=0 ? (q.options[oi].label + " ‚Äî " + q.options[oi].caption) : "‚Äî";
      }else{
        ans = oi>=0 ? (q.options[oi].text || "‚Äî") : "‚Äî";
      }
    }else if(q.type==="tf"){
      ans = (q.tf.trueOpt.kind==="ok") ? "Vrai" : "Faux";
    }else if(q.type==="multi"){
      const a = q.options.map((o,idx)=>o.correct?o.text:null).filter(Boolean);
      ans = a.join(" ; ");
    }else if(q.type==="short"){
      ans = (q.answers||[]).join(" / ");
    }else if(q.type==="drag_order"){
      const map = Object.fromEntries(q.items.map(it=>[it.id,it.text]));
      ans = q.expected.map(id=>map[id]).join(" ‚Üí ");
    }else if(q.type==="cloze"){
      ans = q.blanks.map(b=>b.answer).join(" | ");
    }else if(q.type==="hotspot"){
      ans = "Zone correcte (gorge)";
    }else{
      ans = "‚Äî";
    }

    return `<tr>
      <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); width:52px; color: rgba(255,255,255,.75);">Q${i+1}</td>
      <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); font-weight:900;">${escapeHtml(q.title||"")}</td>
      <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); color: rgba(255,255,255,.86);">${escapeHtml(ans)}</td>
    </tr>`;
  }).join("");

  return `
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
      <span class="pill">üìå Mission : <b>${escapeHtml(SCENARIO.mission)}</b></span>
      <span class="pill">üéö Niveau : <b>${escapeHtml(difficulty.toUpperCase())}</b></span>
      <span class="pill">‚≠ê Score : <b>${escapeHtml(String(score))}</b></span>
      <span class="pill">üò∞ Stress : <b>${escapeHtml(String(stress))}%</b></span>
    </div>
    <div style="overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.12);">
      <table style="width:100%; border-collapse:collapse; min-width:760px;">
        <thead>
          <tr>
            <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">#</th>
            <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">Question</th>
            <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">Bonne r√©ponse</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

function openKey(){
  if(showKeyBtn.disabled) return;
  sfxClick();
  keyBody.innerHTML = buildAnswerKeyHtml();
  keyOverlay.style.display = "flex";
  document.body.style.overflow = "hidden";
}
function closeKey(){
  sfxClick();
  keyOverlay.style.display = "none";
  document.body.style.overflow = "";
}
showKeyBtn.addEventListener("click", openKey);
keyCloseBtn.addEventListener("click", closeKey);
keyCloseBtn2.addEventListener("click", closeKey);
keyOverlay.addEventListener("click", (e)=>{ if(e.target === keyOverlay) closeKey(); });

/* ===== Badge helpers (affichage fin comme screenshot) ===== */
function normalizeLevelLabel(){
  // on garde exactement ce que tu affiches en haut: difficulty (d√©butant/interm√©diaire/expert)
  return String(difficulty || "d√©butant").toUpperCase();
}

function computeBadgeTypeFromScore(sc){
  // logique simple + coh√©rente avec ton screenshot (100 => OR)
  if(sc >= 90) return "OR";
  if(sc >= 70) return "ARGENT";
  return "BRONZE";
}

function badgeImageForType(type){
  // tes images: bronze.png or.png argent.png
  const t = String(type || "").toUpperCase();
  if(t === "OR") return "or.png";
  if(t === "ARGENT") return "argent.png";
  return "bronze.png";
}

function saveBadge({scenario, mission, type, level, score}){
  const payload = {
    scenario: scenario,
    name: `${type} ‚Äî ${mission}`,
    type: type,
    niveau: level,
    score: score,
    img: badgeImageForType(type),
    ts: Date.now()
  };
  localStorage.setItem(`badge_s${scenario}`, JSON.stringify(payload));
  return payload;
}

function endScenario(){
  stopTimer();
  hideOverlay();

  // Verrouiller l'UI de quiz
  optionsEl.innerHTML = "";
  validateBtn.disabled = true;
  validateBtn.classList.remove("show");
  validateBtn.style.display = "none";     // ‚úÖ comme screenshot: Valider n‚Äôest plus utile
  clearBtn.style.display = "none";
  locked = true;

  // Activer Corrig√© uniquement √† la fin (comme tu fais d√©j√†)
  showKeyBtn.disabled = false;

  // Afficher bouton Terminer √† gauche (comme screenshot)
  endBtn.style.display = "inline-block";
  endBtn.classList.add("show");

  // ----- Badge (type + image) -----
  const levelLabel = normalizeLevelLabel();         // ex: DEBUTANT
  const badgeType  = computeBadgeTypeFromScore(score); // OR/ARGENT/BRONZE
  const badgeImg   = badgeImageForType(badgeType);

  // Enregistrer (nom + type + niveau) comme tu voulais
  const saved = saveBadge({
    scenario: SCENARIO.id,
    mission: SCENARIO.mission,
    type: badgeType,
    level: levelLabel,
    score
  });

  // Progress full
  if(progressBar) progressBar.style.width = "100%";

  // Texte FIN (comme screenshot)
  qMeta.textContent = "FIN ‚Äî BADGE OBTENU";
  qTitle.textContent = "F√©licitations !";
  qDesc.innerHTML = ""; // on remplace par un bloc r√©sultat dans optionsEl

  // Stress label (optionnel: Calme si faible)
  const stressLabel = (stress <= 25) ? "Calme" : (stress <= 60) ? "Sous tension" : "Critique";

  // Indices restants (affichage)
  const used = (HINT_MAX - hintsLeft);
  const hintLeftTxt = `${hintsLeft} / ${HINT_MAX}`;

  // ----- Bloc r√©sultat (identique √† ton screenshot) -----
  optionsEl.innerHTML = `
    <div class="resultWrap">

      <div class="resultCard">
        <div class="badgeThumb">
          <img src="assets/${saved.img}" alt="badge">
        </div>

        <div class="badgeText">
          <div class="badgeLine">üèÖ Badge ${badgeType} ‚Äî ${escapeHtml(SCENARIO.mission)}</div>
          <div class="badgeSub">Niveau : <b>${escapeHtml(levelLabel)}</b> ‚Ä¢ Type : <b>${escapeHtml(badgeType)}</b></div>

          <div class="resultPills">
            <span class="pill">‚≠ê Score final : <b>${score}</b></span>
            <span class="pill">üò∞ Stress : <b>${stress}%</b> (<span style="color:rgba(255,255,255,.78);">${stressLabel}</span>)</span>
            <span class="pill">üí° Indices restants : <b>${hintLeftTxt}</b></span>
          </div>

          <div class="resultInfo">
            <span class="okDot"></span>
            <span>Badge enregistr√© (nom + type + niveau).</span>
          </div>
        </div>
      </div>

      <div class="resultHero">
        <div class="heroBadge">
          <img src="assets/${saved.img}" alt="badge">
        </div>
        <p class="heroTitle">Badge ${badgeType} ‚Äî ${escapeHtml(SCENARIO.mission)}</p>
        <div class="heroSub">Niveau : <b>${escapeHtml(levelLabel)}</b></div>
      </div>

    </div>
  `;

  // On d√©sactive Indice/Pause une fois termin√©
  updateHintBtn();
  hintBtn.disabled = true;
  pauseBtn.disabled = true;

  // petit son victoire
  sfxVictory();
}


/* Motion */
function motion(type){
  frame.classList.remove("shake","pulseGood","flashBad");
  modalBox.classList.remove("shake","pulseGood","flashBad");
  if(type==="good"){ frame.classList.add("pulseGood"); }
  else if(type==="wrong"){ modalBox.classList.add("shake"); }
  else if(type==="critical"){ modalBox.classList.add("shake"); frame.classList.add("flashBad"); }
}

/* ‚úÖ Terminer */
endBtn.addEventListener("click", ()=>{
  sfxClick();
  window.location.href = NEXT_SCENARIO_URL;
});

/* Start */
startBtn.addEventListener("click", ()=>{
  ensureAudio(); sfxClick();

  localStorage.setItem("stress", "0");
  localStorage.setItem("score", "0");
  stress = 0; score = 0;
  setStress(0); setScore(0);

  // reset hints at start
  hintsLeft = HINT_MAX;
  localStorage.setItem(HINT_KEY, String(hintsLeft));
  hintUsedThisQuestion = false;

  // reset end buttons
  showKeyBtn.disabled = true;
  endBtn.style.display = "none";

  startOverlay.style.display="none";
  idx=0;
  attemptsForCurrentQuestion=0;
  setAttemptsUI();
  updateProgress();

  timeLeft = TIMER_SECONDS;
  setRingProgress();
  hudTime.textContent = String(TIMER_SECONDS);

  updateHintBtn();
  renderQuestion(0, true);
});

/* Init */
(function init(){
  locked=true;
  qMeta.textContent = SCENARIO.label;
  qTitle.textContent="Pr√©pare-toi‚Ä¶";
  qDesc.innerHTML = `Tu as <b>${TIMER_SECONDS} secondes</b> par question. Clique sur <b>D√âMARRER</b>.`;
  optionsEl.innerHTML="";
  hudQnum.textContent="1";

  timeLeft = TIMER_SECONDS;
  hudTime.textContent=String(TIMER_SECONDS);
  ring.style.setProperty("--p","100%");
  setRingProgress();

  validateBtn.disabled = true;
  attemptsForCurrentQuestion = 0;
  setAttemptsUI();
  updateProgress();

  showKeyBtn.disabled = true;
  endBtn.style.display = "none";

  // ‚úÖ Start overlay texte dynamique (m√™mes r√®gles)
  startText.innerHTML = `
    Tu vas intervenir en situation d‚Äôurgence. Tu as peu de temps pour r√©pondre.
    <br><br>
    <b>Niveau :</b> ${escapeHtml(difficulty.toUpperCase())}<br>
    ‚è± <b>${TIMER_SECONDS}s</b> par question ‚Ä¢ üéØ <b>${ATTEMPTS_MAX}</b> tentative${ATTEMPTS_MAX>1?"s":""} ‚Ä¢ üí° <b>${HINT_MAX}</b> indice${HINT_MAX>1?"s":""} (1 par question)
    <br><br>
    <b>Si le temps s‚Äô√©coule ${ATTEMPTS_MAX} fois ou apr√®s ${ATTEMPTS_MAX} tentatives rat√©es, tu retournes au d√©but de la mission (score = 0).</b>
    <br>
    Es-tu pr√™t √† commencer ?
  `;

  updateHintBtn();
})();
</script>
	<div id="badgesGrid">
/* =========================================
   ‚úÖ PAGE BADGES ‚Äî AFFICHAGE DES BADGES
========================================= */
const BADGE_IMAGES = {
  OR: "or.png",
  ARGENT: "argent.png",
  BRONZE: "bronze.png",
  LOCK: "bronze.png" // ou une image lock.png si tu en as
};

const DIFFICULTY = (localStorage.getItem("niveau")
  || localStorage.getItem("difficulty")
  || "D√âBUTANT").toUpperCase();

const SCENARIOS = [
  { id: 1, label: "Sc√©nario 1" },
  { id: 2, label: "Sc√©nario 2" },
  { id: 3, label: "Sc√©nario 3" },
  { id: 4, label: "Sc√©nario 4" }
];

function readBadge(scenarioId, difficulty){
  const key = `badge_s${scenarioId}_${difficulty}`;
  try{
    return JSON.parse(localStorage.getItem(key) || "null");
  }catch(e){
    return null;
  }
}

function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderBadges(){
  const host = document.getElementById("badgesGrid");
  if(!host) return;

  const cards = SCENARIOS.map(sc=>{
    const b = readBadge(sc.id, DIFFICULTY);

    if(!b){
      return `
        <div class="badgeCard locked">
          <img class="badgeImg" src="${BADGE_IMAGES.LOCK}" alt="locked">
          <div class="badgeTitle">${escapeHtml(sc.label)}</div>
          <div class="badgeMeta">üîí Non obtenu</div>
        </div>
      `;
    }

    return `
      <div class="badgeCard">
        <img class="badgeImg" src="${escapeHtml(b.badgeImage)}" alt="${escapeHtml(b.badgeLevel)}">
        <div class="badgeTitle">${escapeHtml(b.scenarioLabel || sc.label)}</div>
        <div class="badgeMeta">üèÖ ${escapeHtml(b.badgeLevel)} ‚Ä¢ ‚≠ê ${b.score} ‚Ä¢ üéö ${escapeHtml(b.difficulty)}</div>
      </div>
    `;
  }).join("");

  host.innerHTML = cards;
}

renderBadges();


</div>

</body>
</html>
