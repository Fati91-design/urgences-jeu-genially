<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sc√©nario 3 ‚Äî Chute du 2e √©tage ‚Äî Urgences</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --glass: rgba(25, 27, 31, .72);
      --glass2: rgba(15, 17, 20, .55);

      --text: rgba(255,255,255,.93);
      --muted: rgba(255,255,255,.70);

      --gold: rgba(255,200,80,1);
      --red: rgba(255,70,70,1);
      --green: rgba(45,200,120,1);
      --blue: rgba(80,170,255,1);
      --ember: rgba(255,150,70,1);
      --ember2: rgba(255,120,50,1);
    }

    html,body{
      margin:0;
      background: transparent;
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow: hidden; /* ‚úÖ Genially anti-scroll */
    }

    .stage{
      min-height: 100vh;
      height: 100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding: 16px 14px;
      overflow:hidden;
    }

    /* ‚úÖ GENIALLY AUTO-SCALE (ajout) */
    .scaler{
      width:100%;
      height:100%;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      overflow:hidden;
    }
    .scalerInner{
      --scale: 1;
      transform: scale(var(--scale));
      transform-origin: top center;
      will-change: transform;
      width: fit-content;
    }

    /* ‚úÖ version large (r√©f√©rence) */
    .wrap{
      width: min(1650px, 100%);
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: calc(100vh - 28px);
    }

    /* ========= TOP TABS ========= */
    .topTabs{
      display:flex;
      align-items:center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .levelTab{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--glass);
      border: 1px solid rgba(255, 200, 150, .22);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 65px rgba(0,0,0,.35);
      position: relative;
      overflow:hidden;
    }
    .levelTab::after{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(460px 160px at 10% 0%, rgba(255,150,70,.18), transparent 60%),
        radial-gradient(520px 220px at 85% 120%, rgba(80,170,255,.10), transparent 60%);
      opacity:.85;
      pointer-events:none;
    }
    .levelDot{
      width: 10px; height: 10px; border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      box-shadow: 0 0 0 5px rgba(255,150,70,.14);
      position: relative; z-index:2;
    }
    #levelTabText{
      font-weight: 950;
      letter-spacing: .35px;
      position: relative; z-index:2;
      white-space: nowrap;
    }

    .progressShell{
      height: 10px;
      min-width: 220px;
      flex: 1 1 420px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      position: relative;
      box-shadow: 0 18px 65px rgba(0,0,0,.18);
    }
    .progressBar{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(80,170,255,.95), rgba(255,150,70,.95));
      transition: width .25s ease;
    }

    .miniHint{
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 950;
      font-size: 12px;
      color: rgba(255,255,255,.84);
      white-space: nowrap;
      backdrop-filter: blur(10px);
    }

    /* ========= HUD ========= */
    .hud{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .hudbox{
      background: var(--glass);
      border: 1px solid rgba(255, 200, 150, .22);
      border-radius: 18px;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      position: relative;
      overflow:hidden;
      box-shadow: 0 18px 65px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      min-height: 92px;
    }
    .hudbox::after{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      background:
        radial-gradient(420px 160px at 15% 0%, rgba(255,150,70,.18), transparent 60%),
        radial-gradient(520px 220px at 85% 120%, rgba(80,170,255,.10), transparent 60%);
      opacity:.9;
    }

    .profile{ display:flex; align-items:center; gap: 14px; min-width: 0; position: relative; z-index:2; }

    .avatarFrame{
      width: 92px; height: 92px; border-radius: 24px; padding: 4px;
      background: linear-gradient(180deg, rgba(255,150,70,.36), rgba(80,170,255,.14));
      box-shadow: 0 18px 42px rgba(0,0,0,.45);
      flex: 0 0 auto;
    }
    .avatar{
      width:100%; height:100%;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.12);
      object-fit: cover;
      object-position: 50% 6%;
      transform: scale(1.35);
      transform-origin: 50% 12%;
      background: rgba(255,255,255,.06);
    }

    .ptext{ min-width:0; }
    .pname{
      font-weight: 950;
      font-size: 22px;
      line-height: 1.05;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      text-shadow: 0 14px 30px rgba(0,0,0,.55);
    }
    .prole{
      margin-top: 4px;
      font-weight: 850;
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .chip{
      background: rgba(255,150,70,.14);
      border: 1px solid rgba(255,150,70,.20);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 12px;
      font-weight: 950;
      white-space: nowrap;
      position: relative;
      z-index:2;
    }

    .stats{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap: wrap;
      position: relative;
      z-index:2;
    }

    .pill{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 950;
      font-size: 13px;
      white-space: nowrap;
    }

    .timerPill{
      padding: 8px 10px;
      gap: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }

    .ring{
      width: 40px; height: 40px; border-radius: 999px;
      background: conic-gradient(var(--gold) var(--p, 0%), rgba(255,255,255,.14) 0);
      display:grid; place-items:center;
      box-shadow: 0 0 0 5px rgba(255,200,80,.14), 0 0 28px rgba(255,200,80,.10);
      transition: box-shadow .2s ease;
    }
    .ringInner{
      width: 28px; height: 28px; border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      color: rgba(255,255,255,.9);
      font-size: 14px; font-weight: 950;
    }

    .timeText{ display:flex; align-items:center; gap: 8px; }
    .timeText .label{ font-size: 12px; font-weight: 900; color: rgba(255,255,255,.75); }
    .timeText .sec{ font-size: 16px; font-weight: 950; }

    .timerWarn .ring{
      background: conic-gradient(var(--gold) var(--p, 0%), rgba(255,255,255,.14) 0);
      box-shadow: 0 0 0 5px rgba(255,200,80,.18), 0 0 32px rgba(255,200,80,.14);
    }
    .timerDanger .ring{
      background: conic-gradient(var(--red) var(--p, 0%), rgba(255,255,255,.14) 0);
      box-shadow: 0 0 0 5px rgba(255,70,70,.20), 0 0 40px rgba(255,70,70,.18);
    }

    .stressWrap{
      width: 240px; height: 12px; border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .stressBar{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(45,200,120,.95), rgba(255,200,80,.95), rgba(255,70,70,.95));
      transition: width .25s ease;
    }

    /* ========= FRAME QUIZ (scroll interne) ========= */
    .frame{
      background: var(--glass2);
      border: 1px solid rgba(255, 200, 150, .22);
      border-radius: 18px;
      padding: 18px;
      position: relative;
      overflow:hidden;
      box-shadow: 0 18px 70px rgba(0,0,0,.50);
      backdrop-filter: blur(12px);

      flex: 1;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .frame::after{
      content:"";
      position:absolute; inset:-2px; pointer-events:none;
      background:
        radial-gradient(800px 260px at 55% 0%, rgba(255,150,70,.16), transparent 60%),
        radial-gradient(760px 260px at 40% 120%, rgba(80,170,255,.10), transparent 60%);
      opacity:.9;
    }

    .qmeta{ position: relative; z-index:2; color: rgba(255,255,255,.70); font-size: 12px; font-weight: 950; letter-spacing: .35px; text-transform: uppercase; }
    .qtitle{ position: relative; z-index:2; margin-top: 6px; font-weight: 950; font-size: clamp(18px, 2.2vw, 26px); line-height: 1.2; text-shadow: 0 14px 30px rgba(0,0,0,.55); }
    .qdesc{ position: relative; z-index:2; margin-top: 10px; color: rgba(255,255,255,.82); font-size: 14px; line-height: 1.5; max-width: 980px; }

    .options{
      position: relative;
      z-index:2;
      display:flex;
      flex-direction:column;
      gap: 12px;
      margin-top: 16px;

      flex: 1;
      min-height: 0;
      overflow:auto;
      padding-right: 6px;
    }

    /* scrollbar */
    .options::-webkit-scrollbar{ width: 10px; }
    .options::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.16);
      border: 2px solid rgba(0,0,0,.25);
      border-radius: 999px;
    }
    .options::-webkit-scrollbar-track{ background: rgba(0,0,0,.10); border-radius: 999px; }

    .opt{
      border-radius: 14px;
      padding: 13px 14px;
      font-weight: 950;
      letter-spacing: .2px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, filter .12s ease, background .12s ease;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(80,170,255,.22), rgba(80,170,255,.14));
      box-shadow: 0 10px 28px rgba(0,0,0,.20);
    }
    .opt:hover{ transform: translateY(-1px); filter: brightness(1.07); background: linear-gradient(180deg, rgba(255,150,70,.22), rgba(80,170,255,.10)); }
    .opt:active{ transform: translateY(0px); filter: brightness(.98); }

    .opt.sel{
      background: linear-gradient(180deg, rgba(255,150,70,.30), rgba(255,120,50,.18));
      border-color: rgba(255,150,70,.30);
      box-shadow: 0 0 0 3px rgba(255,150,70,.10), 0 16px 34px rgba(0,0,0,.28);
    }

    /* actions align r√©f√©rence: gauche (Corrig√©/Terminer) + droite (Valider/Effacer) */
    .actions{
      position: relative;
      z-index:2;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      flex-wrap: wrap;
    }
    .actions .leftActions,
    .actions .rightActions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btnNeo{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.90);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 950;
      letter-spacing: .2px;
      transition: transform .12s ease, filter .12s ease;
    }
    .btnNeo:hover{ transform: translateY(-1px); filter: brightness(1.06); }
    .btnNeo:disabled{ opacity:.45; cursor:not-allowed; transform:none; filter:none; }

    .btnPrimary{
      border: none;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      color: rgba(10,12,18,.96);
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 950;
      letter-spacing: .2px;
      transition: transform .12s ease, filter .12s ease;
    }
    .btnPrimary:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .btnPrimary:disabled{
      opacity:.45;
      filter: grayscale(.2);
      cursor: not-allowed;
      transform:none;
    }

    /* ========= OVERLAYS ========= */
    .overlay{
      position: fixed; inset: 0;
      display:none; align-items:center; justify-content:center;
      z-index: 50;
      background: rgba(0,0,0,.48);
      backdrop-filter: blur(8px);
      padding: 18px;
    }

    .modalBox{
      width: min(780px, 96%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(8,10,14,.82);
      box-shadow: 0 26px 90px rgba(0,0,0,.62);
      overflow:hidden;
      position: relative;
    }

    .modalTop{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }

    .badgeState{
      font-weight: 950;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }
    .bGood{ border-color: rgba(45,200,120,.30); background: rgba(45,200,120,.12); }
    .bWarn{ border-color: rgba(255,200,80,.30); background: rgba(255,200,80,.12); }
    .bBad { border-color: rgba(255,70,70,.35); background: rgba(255,70,70,.12); }

    .modalBody{ padding: 16px; color: rgba(255,255,255,.92); line-height: 1.55; font-size: 14px; }
    .modalActions{
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex; justify-content:flex-end; gap: 10px; flex-wrap: wrap;
    }

    .startTitle{ font-weight: 950; font-size: 22px; margin-bottom: 6px; }
    .startText{ color: rgba(255,255,255,.82); font-size: 14px; line-height: 1.5; }

    .startBtn{
      border:none; border-radius: 14px; padding: 12px 16px;
      font-weight: 950; letter-spacing: .3px;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      color: rgba(10,12,18,.96);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      transition: transform .12s ease, filter .12s ease;
    }
    .startBtn:hover{ transform: translateY(-1px); filter: brightness(1.05); }

    /* loading overlay transparent */
    .loadingBox{
      width: min(520px, 92%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      padding: 18px;
      text-align:center;
      box-shadow: 0 26px 90px rgba(0,0,0,.55);
    }
    .spinner{
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 3px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,150,70,.95);
      margin: 0 auto 10px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* ========= animations ========= */
    .shake{ animation: shake .24s linear 1; }
    @keyframes shake{
      0% { transform: translateX(0px); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
      100%{ transform: translateX(0px); }
    }
    .pulseGood{ animation: pulseGood .32s ease 1; }
    @keyframes pulseGood{
      from{ box-shadow: 0 0 0 0 rgba(45,200,120,.0); }
      50%{ box-shadow: 0 0 0 7px rgba(45,200,120,.18); }
      to{ box-shadow: 0 0 0 0 rgba(45,200,120,.0); }
    }
    .flashBad{ animation: flashBad .30s ease 1; }
    @keyframes flashBad{
      from{ box-shadow: 0 0 0 0 rgba(255,70,70,.0); }
      50%{ box-shadow: 0 0 0 7px rgba(255,70,70,.22); }
      to{ box-shadow: 0 0 0 0 rgba(255,70,70,.0); }
    }

    /* ========= Hotspot zones ========= */
    @keyframes hsPulse {
      0% { box-shadow: 0 0 0 0 rgba(255,255,255,.25); border-color: rgba(255,255,255,.55); }
      70% { box-shadow: 0 0 0 14px rgba(255,255,255,0); border-color: rgba(255,255,255,.85); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); border-color: rgba(255,255,255,.55); }
    }
    .hotspot-zone{
      position:absolute;
      background: transparent !important;
      border: 2px solid rgba(255,255,255,.65);
      border-radius: 16px;
      padding:0;
      margin:0;
      cursor:pointer;
      animation: hsPulse 1.35s infinite;
    }
    .hotspot-zone.sel{
      border-color: rgba(34,197,94,.95);
      box-shadow: 0 0 0 6px rgba(34,197,94,.20);
      animation: none;
    }

    /* ========= image_single cards ========= */
    .imgGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:16px;
      margin-top: 6px;
    }
    @media (max-width: 980px){ .imgGrid{ grid-template-columns: 1fr; } }

    .imgCard{
      border-radius:18px;
      overflow:hidden;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      transition:.15s ease;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
    }
    .imgCard:hover{ transform:translateY(-3px); filter:brightness(1.05); }
    .imgCard.sel{
      outline:3px solid rgba(255,165,0,.4);
      box-shadow:0 0 0 4px rgba(255,165,0,.25), 0 20px 40px rgba(0,0,0,.35);
    }
    .imgHead{
      padding:12px 16px;
      font-weight:900;
      display:flex;
      justify-content:space-between;
      background:linear-gradient(180deg, rgba(120,180,255,.25), rgba(120,180,255,.10));
    }
    .imgTag{
      width:36px; height:36px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      background:rgba(0,0,0,.25);
    }
    .imgPic{
      width:100%;
      height: 220px;
      object-fit:cover;
      display:block;
    }
    .imgCap{
      padding:14px;
      text-align:center;
      font-weight:800;
    }

    /* ========= Key overlay content ========= */
    .keyBody{
      max-height: 70vh;
      overflow:auto;
      padding-right: 6px;
    }
    .keyBody::-webkit-scrollbar{ width: 10px; }
    .keyBody::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.16);
      border: 2px solid rgba(0,0,0,.25);
      border-radius: 999px;
    }
    .keyClose{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 950;
      cursor:pointer;
    }

    /* ========= responsive ========= */
    @media (max-width: 980px){
      .hud{ grid-template-columns: 1fr; }
      .stressWrap{ width: 190px; }
      .progressShell{ flex: 1 1 100%; min-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="stage" id="stage">
    <!-- ‚úÖ GENIALLY AUTO-SCALE wrapper (ajout) -->
    <div class="scaler" id="scaler">
      <div class="scalerInner" id="scalerInner">
        <div class="wrap" id="wrap">

          <!-- TOP TABS -->
          <div class="topTabs">
            <div class="levelTab">
              <div class="levelDot"></div>
              <div id="levelTabText">NIVEAU</div>
            </div>

            <div class="progressShell" title="Progression">
              <div class="progressBar" id="progressBar"></div>
            </div>

            <div class="miniHint" id="miniHint">‚Äî</div>
          </div>

          <!-- HUD -->
          <div class="hud">
            <div class="hudbox">
              <div class="profile">
                <div class="avatarFrame">
                  <img class="avatar" id="hudAvatar" alt="Avatar">
                </div>
                <div class="ptext">
                  <div class="pname" id="hudName">Dr. Joueur</div>
                  <div class="prole" id="hudRole">R√¥le: ‚Äî</div>
                </div>
              </div>
              <div class="chip" id="difficultyChip">MODE: ‚Äî</div>
            </div>

            <div class="hudbox">
              <div class="stats">
                <div class="pill">‚≠ê <span id="hudScore">0</span></div>
                <div class="pill">Q <span id="hudQnum">1</span>/<span id="hudQtotal">0</span></div>
                <div class="pill">üéØ <span id="hudAttempts">0</span>/<span id="hudAttemptsMax">0</span></div>

                <div class="pill timerPill" id="timerPill">
                  <div class="ring" id="ring"><div class="ringInner">‚è±</div></div>
                  <div class="timeText">
                    <div class="label">Temps</div>
                    <div class="sec"><span id="hudTime">0</span>s</div>
                  </div>
                </div>

                <div class="stressWrap" title="Stress">
                  <div class="stressBar" id="stressBar"></div>
                </div>

                <button class="btnNeo" id="hintBtn" type="button">üí° Indice (<span id="hudHints">0</span>)</button>
                <button class="btnNeo" id="pauseBtn" type="button">‚è∏ Pause</button>
              </div>
            </div>
          </div>

          <!-- FRAME -->
          <div class="frame" id="frame">
            <div class="qmeta" id="qMeta">‚Äî</div>
            <div class="qtitle" id="qTitle">‚Ä¶</div>
            <div class="qdesc" id="qDesc">‚Ä¶</div>

            <div class="options" id="options"></div>

            <div class="actions">
              <div class="leftActions">
                <button class="btnNeo" id="showKeyBtn" type="button" disabled>üìò Corrig√©</button>
                <button class="btnPrimary" id="endBtn" type="button" style="display:none;">‚úÖ Terminer</button>
              </div>

              <div class="rightActions">
                <button class="btnPrimary" id="validateBtn" type="button" disabled>Valider</button>
                <button class="btnNeo" id="clearBtn" type="button" style="display:none;">Effacer</button>
              </div>
            </div>
          </div>

        </div><!-- /wrap -->
      </div><!-- /scalerInner -->
    </div><!-- /scaler -->
  </div><!-- /stage -->

  <!-- START overlay -->
  <div class="overlay" id="startOverlay" style="display:flex;">
    <div class="modalBox">
      <div class="modalTop">
        <div class="badgeState bWarn">üéÆ Briefing</div>
        <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
          Mission ‚Ä¢ <span id="startMission">‚Äî</span>
        </div>
      </div>
      <div class="modalBody">
        <div class="startTitle">Chaque seconde compte.</div>
        <div class="startText" id="startRules">
          ‚Äî r√®gles ‚Äî
        </div>
      </div>
      <div class="modalActions">
        <button class="startBtn" id="startBtn">D√âMARRER</button>
      </div>
    </div>
  </div>

  <!-- LOADING overlay -->
  <div class="overlay" id="loadingOverlay">
    <div class="loadingBox">
      <div class="spinner"></div>
      <div style="font-weight:950; letter-spacing:.3px;">CHARGEMENT‚Ä¶</div>
      <div style="margin-top:6px; color: rgba(255,255,255,.72); font-size: 13px;">
        Pr√©pare-toi √† intervenir.
      </div>
    </div>
  </div>

  <!-- Feedback overlay -->
  <div class="overlay" id="overlay">
    <div class="modalBox" id="modalBox">
      <div class="modalTop">
        <div class="badgeState" id="badgeState">‚Äî</div>
        <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
          Score: <span id="modalScore">0</span> ‚Ä¢ Stress: <span id="modalStress">0</span>%
        </div>
      </div>
      <div class="modalBody" id="modalText">‚Ä¶</div>
      <div class="modalActions">
        <button class="btnNeo" id="retryBtn">R√©essayer</button>
        <button class="btnPrimary" id="nextBtn">Suivant</button>
        <button class="btnPrimary" id="okBtn" style="display:none;">OK</button>
      </div>
    </div>
  </div>

  <!-- KEY overlay -->
  <div class="overlay" id="keyOverlay">
    <div class="modalBox">
      <div class="modalTop">
        <div class="badgeState bWarn">üìò Corrig√©</div>
        <button class="keyClose" id="keyCloseBtn" type="button">‚úñ</button>
      </div>
      <div class="modalBody keyBody" id="keyBody"></div>
    </div>
  </div>

<script>
/* ‚úÖ GENIALLY AUTO-SCALE (ajout) : r√©duit automatiquement la taille globale pour tenir dans la page */
(function(){
  const stage = document.getElementById("stage");
  const inner = document.getElementById("scalerInner");
  const wrap  = document.getElementById("wrap");

  function fitGenially(){
    if(!stage || !inner || !wrap) return;

    const st = stage.getBoundingClientRect();
    const cs = getComputedStyle(stage);
    const padX = (parseFloat(cs.paddingLeft)||0) + (parseFloat(cs.paddingRight)||0);
    const padY = (parseFloat(cs.paddingTop)||0)  + (parseFloat(cs.paddingBottom)||0);

    const availW = Math.max(0, st.width  - padX);
    const availH = Math.max(0, st.height - padY);

    // tailles "r√©elles" du contenu (non affect√©es par transform)
    const bw = Math.max(wrap.scrollWidth, wrap.offsetWidth);
    const bh = Math.max(wrap.scrollHeight, wrap.offsetHeight);

    // marge de s√©curit√© (Genially aime bien rogner 1-2%)
    const s = Math.min(1, (availW / bw) * 0.985, (availH / bh) * 0.985);

    inner.style.setProperty("--scale", String(Math.max(0.5, s).toFixed(4)));
  }

  window.__fitGenially = fitGenially;

  // multiple passes (fonts / images)
  window.addEventListener("resize", ()=> requestAnimationFrame(fitGenially));
  window.addEventListener("load", ()=> {
    requestAnimationFrame(fitGenially);
    setTimeout(fitGenially, 150);
    setTimeout(fitGenially, 450);
    setTimeout(fitGenially, 900);
  });
})();
</script>

<script>
/* ========= SFX (WebAudio) ========= */
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function tone(freq, dur=0.08, type="sine", gain=0.05){
  ensureAudio();
  const t0 = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type; osc.frequency.value = freq;
  g.gain.value = gain;
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(t0); osc.stop(t0 + dur);
}
function sfxClick(){ tone(520,0.04,"triangle",0.035); }
function sfxCorrect(){ tone(660,0.07,"sine",0.06); setTimeout(()=>tone(880,0.08,"sine",0.06), 80); }
function sfxWrong(){ tone(220,0.10,"square",0.05); setTimeout(()=>tone(180,0.12,"square",0.05), 90); }
function sfxCritical(){ tone(140,0.14,"sawtooth",0.05); setTimeout(()=>tone(120,0.16,"sawtooth",0.05), 120); }
function sfxAlarmLong(){
  ensureAudio();
  const now = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = "sawtooth";
  osc.frequency.setValueAtTime(520, now);
  osc.frequency.linearRampToValueAtTime(380, now + 0.35);
  osc.frequency.linearRampToValueAtTime(520, now + 0.70);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.07, now + 0.02);
  g.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(now); osc.stop(now + 1.25);
}
function sfxVictory(){
  ensureAudio();
  const notes = [
    {f:659,d:0.10},{f:784,d:0.10},{f:988,d:0.14},
    {f:1175,d:0.18},{f:988,d:0.14},{f:1047,d:0.22}
  ];
  let t = 0;
  notes.forEach((n)=>{
    setTimeout(()=>tone(n.f, n.d, "sine", 0.065), t*1000);
    t += n.d + 0.03;
  });
}

/* ========= Helpers ========= */
const el = (id)=>document.getElementById(id);
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function escapeHtml(str){ return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

/* ========= Elements ========= */
const levelTabText = el("levelTabText");
const progressBar = el("progressBar");
const miniHint = el("miniHint");

const hudName = el("hudName"), hudRole = el("hudRole"), hudAvatar = el("hudAvatar"), difficultyChip = el("difficultyChip");
const hudScore = el("hudScore"), hudQnum = el("hudQnum"), hudQtotal = el("hudQtotal");
const hudAttempts = el("hudAttempts"), hudAttemptsMax = el("hudAttemptsMax");
const hudTime = el("hudTime"), ring = el("ring"), timerPill = el("timerPill"), stressBar = el("stressBar");
const hintBtn = el("hintBtn"), pauseBtn = el("pauseBtn"), hudHints = el("hudHints");

const qMeta = el("qMeta"), qTitle = el("qTitle"), qDesc  = el("qDesc"), optionsEl = el("options");
const validateBtn = el("validateBtn"), clearBtn = el("clearBtn");
const showKeyBtn = el("showKeyBtn"), endBtn = el("endBtn");

const startOverlay = el("startOverlay"), startBtn = el("startBtn");
const startMission = el("startMission"), startRules = el("startRules");

const loadingOverlay = el("loadingOverlay");

const overlay = el("overlay"), modalBox = el("modalBox"), badgeState = el("badgeState"), modalText = el("modalText");
const modalScore = el("modalScore"), modalStress = el("modalStress");
const retryBtn = el("retryBtn"), nextBtn = el("nextBtn"), okBtn = el("okBtn"), frame = el("frame");

const keyOverlay = el("keyOverlay"), keyBody = el("keyBody"), keyCloseBtn = el("keyCloseBtn");

/* ========= CONFIG ========= */
const SCENARIO = {
  id: 3,
  label: "Sc√©nario 3 ‚Äî Chute du 2e √©tage",
  mission: "Chute du deuxi√®me √©tage",
  level: "‚Äî"
};

// ‚úÖ Remplace par ton lien Genially (page suivante / transition / etc.)
const NEXT_SCENARIO_URL = "#";

/* Stress rules (r√©f√©rence) */
const STRESS_RULES = { wrong: 10, timeout: 15, critical: 25 };

/* Role + profil */
const role = "pompier";
const roleLabelMap = { medecin:"M√©decin", infirmier:"Infirmier", pompier:"Pompier" };

const rawPlayer = (window.player_name || window.playerName || localStorage.getItem("player_name") || localStorage.getItem("playerName") || "Joueur");
const playerName = rawPlayer.trim() || "Joueur";
const avatarFile = localStorage.getItem("avatar") || "pompier_f.png";

/* Difficulty (r√©f√©rence) */
const difficultyRaw = (window.niveau || localStorage.getItem("niveau") || localStorage.getItem("difficulty") || "D√©butant");
const difficulty = String(difficultyRaw).toLowerCase();

function difficultyProfile(d){
  if(d.includes("inter")) return { key:"intermediaire", label:"INTERM√âDIAIRE", time:45, attempts:2, hints:2 };
  if(d.includes("expert")) return { key:"expert", label:"EXPERT", time:30, attempts:1, hints:1 };
  return { key:"debutant", label:"D√âBUTANT", time:60, attempts:3, hints:3 };
}
const diff = difficultyProfile(difficulty);

SCENARIO.level = "Niveau " + diff.label.toLowerCase();

/* Hints (r√©f√©rence) */
const HINT_KEY = `hints_left_s${SCENARIO.id}`;

/* ========= DATA (questions inchang√©es) ========= */
const questions = [{"type":"single","title":"Arriv√©e sur les lieux","desc":"Ta premi√®re action en tant que pompier ?","options":[{"text":"S√©curiser la zone (dangers, circulation, hauteur)","kind":"ok","fb":"‚úÖ Oui : s√©curit√© d‚Äôabord."},{"text":"Relever la victime","kind":"wrong","fb":"‚ùå Non : risque rachis."},{"text":"Donner √† boire","kind":"wrong","fb":"‚ùå Non."},{"text":"Tester la marche","kind":"wrong","fb":"‚ùå Non : mobilisation interdite."}]},{"type":"tf","title":"Mobilisation","desc":"Vrai/Faux : si la victime parle, tu peux la d√©placer sans risque.","tf":{"trueOpt":{"kind":"wrong","fb":"‚ùå Faux : suspicion rachis."},"falseOpt":{"kind":"ok","fb":"‚úÖ Vrai : on √©vite toute mobilisation."}}},{"type":"single","title":"Risque principal","desc":"Apr√®s une chute de hauteur, le risque majeur √† suspecter :","options":[{"text":"L√©sion de la colonne (rachis)","kind":"ok","fb":"‚úÖ Oui."},{"text":"Simple entorse","kind":"wrong","fb":"‚ùå Pas le risque majeur."},{"text":"Rhume","kind":"wrong","fb":"‚ùå Non."},{"text":"D√©shydratation","kind":"wrong","fb":"‚ùå Non."}]},{"type":"image_single","title":"Choix de l‚Äôaction","desc":"Quelle image repr√©sente la conduite la plus s√ªre imm√©diatement apr√®s la chute ?","options":[{"label":"A","imgSrc":"assets/chute_q4_b.png","caption":"Immobilisation axe t√™te-cou-tronc","kind":"wrong","fb":"üü° Bien, mais ici on attend le maintien terrain (B)."},{"label":"B","imgSrc":"assets/chute_q4_a.png","caption":"Maintien t√™te-cou-tronc (terrain)","kind":"ok","fb":"‚úÖ Correct : conduite la plus s√ªre pour un pompier (trauma + rachis)."},{"label":"C","imgSrc":"assets/chute_q4_c.png","caption":"Immobilisation + contr√¥le vital + alerte/O‚ÇÇ si dispo","kind":"wrong","fb":"‚ùå Non : conduite inadapt√©e ici."}]},{"type":"single","title":"Alerte","desc":"Num√©ro m√©dical d‚Äôurgence :","options":[{"text":"15","kind":"ok","fb":"‚úÖ 15."},{"text":"112","kind":"wrong","fb":"‚ùå Ici on attend 15."},{"text":"18","kind":"wrong","fb":"‚ùå Ici on attend 15."},{"text":"19","kind":"wrong","fb":"‚ùå Ici on attend 15."}]},{"type":"single","title":"Immobilisation manuelle","desc":"Que fais-tu pour la t√™te et le cou ?","options":[{"text":"Maintien t√™te-cou (immobilisation manuelle)","kind":"ok","fb":"‚úÖ Correct."},{"text":"Tourner la t√™te","kind":"wrong","fb":"‚ùå Non."},{"text":"Soulever les √©paules","kind":"wrong","fb":"‚ùå Non."},{"text":"Mettre assis","kind":"wrong","fb":"‚ùå Non."}]},{"type":"multi","title":"Surveillance continue","desc":"Coche ce que tu surveilles :","options":[{"text":"Conscience","correct":true},{"text":"Respiration","correct":true},{"text":"Peau froide/p√¢leur","correct":true},{"text":"Couleur des cheveux","correct":false}],"okFb":"‚úÖ Tr√®s bien.","badFb":"‚ùå Surveiller conscience/respiration/circulation."},{"type":"drag_order","title":"Ordre terrain","desc":"Mets dans l‚Äôordre :","items":[{"id":"safe","text":"S√©curiser"},{"id":"abc","text":"Conscience/respiration (ABC)"},{"id":"imm","text":"Immobiliser"},{"id":"call","text":"Alerter / transmettre"},{"id":"warm","text":"Couvrir"}],"expected":["safe","abc","imm","call","warm"],"okFb":"‚úÖ Bon ordre.","badFb":"‚ùå S√©curiser ‚Üí ABC ‚Üí immobiliser ‚Üí alerter ‚Üí couvrir."},{"type":"hotspot","gate":true,"title":"Hotspot ‚Äî Zone √† prot√©ger","desc":"","imgSrc":"scenario_3_hotspot.png","hotspots":[{"label":"ok","x":30,"y":28,"w":18,"h":40,"kind":"ok","fb":"‚úÖ Correct : rachis/colonne (ne pas mobiliser).","pts":10},{"label":"ko","x":10,"y":18,"w":18,"h":20,"kind":"wrong","fb":"‚ùå Non : zone non prioritaire ici.","pts":-2},{"label":"ko","x":70,"y":72,"w":18,"h":18,"kind":"wrong","fb":"‚ùå Non : zone non prioritaire ici.","pts":-2}]},{"type":"tf","title":"Couvrir","desc":"Vrai/Faux : couvrir la victime aide √† pr√©venir le choc.","tf":{"trueOpt":{"kind":"ok","fb":"‚úÖ Vrai."},"falseOpt":{"kind":"wrong","fb":"‚ùå Faux."}}},{"type":"single","title":"Boisson","desc":"Si la victime demande de l‚Äôeau :","options":[{"text":"Ne pas donner √† boire/manger","kind":"ok","fb":"‚úÖ Correct."},{"text":"Donner un grand verre","kind":"wrong","fb":"‚ùå Non."},{"text":"Donner des biscuits","kind":"wrong","fb":"‚ùå Non."},{"text":"Laisser boire si consciente","kind":"wrong","fb":"‚ùå Non."}]},{"type":"single","title":"Mat√©riel","desc":"Mat√©riel utile :","options":[{"text":"Plan dur / matelas coquille (si dispo)","kind":"ok","fb":"‚úÖ Oui."},{"text":"Oreiller seul","kind":"wrong","fb":"‚ùå Insuffisant."},{"text":"Corde pour tirer","kind":"wrong","fb":"‚ùå Non."},{"text":"Rien","kind":"wrong","fb":"‚ùå Non."}]},{"type":"single","title":"Pi√®ge","desc":"Geste dangereux :","options":[{"text":"Redresser la victime","kind":"ok","fb":"üö® Dangereux : suspicion rachis."},{"text":"Rassurer","kind":"wrong","fb":"‚úÖ OK."},{"text":"Couvrir","kind":"wrong","fb":"‚úÖ OK."},{"text":"Surveiller respiration","kind":"wrong","fb":"‚úÖ OK."}]},{"type":"short","title":"Mot-cl√©","desc":"Structure √† prot√©ger (1 mot)","answers":["rachis","colonne"],"okFb":"‚úÖ Rachis.","badFb":"‚ùå Rachis."},{"type":"single","title":"Transmission","desc":"Info essentielle √† transmettre :","options":[{"text":"Hauteur + m√©canisme + √©tat (respiration/conscience)","kind":"ok","fb":"‚úÖ Oui."},{"text":"Plat pr√©f√©r√©","kind":"wrong","fb":"‚ùå Non."},{"text":"Couleur du sac","kind":"wrong","fb":"‚ùå Non."},{"text":"Musique pr√©f√©r√©e","kind":"wrong","fb":"‚ùå Non."}]}];

const TOTAL = questions.length;
hudQtotal.textContent = String(TOTAL);

/* ========= State ========= */
let score = parseInt(localStorage.getItem("score") || "0", 10); if(isNaN(score)) score = 0;
let stress = parseInt(localStorage.getItem("stress") || "0", 10); if(isNaN(stress)) stress = 0;

let idx = 0;
let attemptsForCurrentQuestion = 0;
let locked = true;
let paused = false;
let timerId = null;
let timeLeft = diff.time;

let hintsLeft = parseInt(localStorage.getItem(HINT_KEY) || String(diff.hints), 10);
if(isNaN(hintsLeft)) hintsLeft = diff.hints;
let hintUsedThisQuestion = false;

let selectedSingle = null;
let multiSelected = new Set();
let inputValue = "";
let clozeValues = {};

/* ========= UI init ========= */
function setScore(v){
  score=v;
  localStorage.setItem("score", String(score));
  hudScore.textContent=String(score);
  modalScore.textContent=String(score);
}
function addScore(d){ setScore(score + d); }

function setStress(v){
  stress=clamp(v,0,100);
  localStorage.setItem("stress", String(stress));
  stressBar.style.width=stress+"%";
  modalStress.textContent=String(stress);
}
function addStress(d){ setStress(stress + d); }

function setAttemptsUI(){
  hudAttempts.textContent = String(attemptsForCurrentQuestion);
  hudAttemptsMax.textContent = String(diff.attempts);
}
function setHintsUI(){
  hudHints.textContent = String(hintsLeft);
  hintBtn.disabled = (hintsLeft<=0 || hintUsedThisQuestion || locked);
}

function setMiniHint(){
  miniHint.textContent = `‚è± ${diff.time}s ‚Ä¢ üéØ ${diff.attempts} tentative(s) ‚Ä¢ üí° ${hintsLeft} indice(s)`;
}

function setTopLevel(){
  levelTabText.textContent = diff.label;
  difficultyChip.textContent = "MODE: " + diff.label;
}

function setProfile(){
  hudName.textContent = "Dr. " + playerName;
  hudRole.textContent = "R√¥le: " + (roleLabelMap[role] || "‚Äî");
  hudAvatar.src = "assets/avatars/" + avatarFile;
}

/* Progress bar */
function setProgress(){
  const p = clamp(Math.round((idx / TOTAL) * 100), 0, 100);
  progressBar.style.width = p + "%";
}

/* ========= Timer ========= */
function setRingProgress(){
  const p = clamp(Math.round((timeLeft / diff.time) * 100), 0, 100);
  ring.style.setProperty("--p", p + "%");
  timerPill.classList.remove("timerWarn","timerDanger");
  if(timeLeft <= 5) timerPill.classList.add("timerDanger");
  else if(timeLeft <= 10) timerPill.classList.add("timerWarn");
}
function stopTimer(){ clearInterval(timerId); timerId=null; }
function startTimer(){
  stopTimer();
  timeLeft = diff.time;
  hudTime.textContent = String(timeLeft);
  setRingProgress();

  timerId = setInterval(()=>{
    if(locked || paused) return;
    timeLeft--;
    hudTime.textContent = String(timeLeft);
    setRingProgress();

    if(timeLeft <= 0){
      stopTimer();
      sfxAlarmLong();
      attemptsForCurrentQuestion++;
      setAttemptsUI();
      addStress(STRESS_RULES.timeout);

      if(attemptsForCurrentQuestion >= diff.attempts){
        missionFail(`‚è±Ô∏è Temps √©coul√©. Mission √©chou√©e (limite ${diff.attempts} atteinte). Retour au d√©part‚Ä¶`);
      }else{
        showOverlay("warn", `‚è±Ô∏è Temps √©coul√©. (Tentative ${attemptsForCurrentQuestion}/${diff.attempts})`, {
          allowRetry:true, allowNext:false, missionFail:false
        });
      }
    }
  }, 1000);
}

/* ========= Overlays ========= */
function showLoading(ms=800){
  loadingOverlay.style.display="flex";
  return new Promise(res=> setTimeout(()=>{ loadingOverlay.style.display="none"; res(); }, ms));
}

function showOverlay(kind, text, {allowRetry, allowNext, missionFail}){
  badgeState.className="badgeState";
  if(kind==="good"){ badgeState.classList.add("bGood"); badgeState.textContent="‚úÖ Bonne r√©ponse"; }
  if(kind==="warn"){ badgeState.classList.add("bWarn"); badgeState.textContent="‚ö†Ô∏è √Ä corriger"; }
  if(kind==="bad") { badgeState.classList.add("bBad");  badgeState.textContent="üö® Mission √©chou√©e"; }

  modalText.innerHTML = text;
  overlay.style.display="flex";

  retryBtn.style.display = allowRetry ? "inline-block" : "none";
  nextBtn.style.display  = allowNext  ? "inline-block" : "none";
  okBtn.style.display    = "none";
  okBtn.onclick = null;

  retryBtn.onclick = ()=>{ hideOverlay(); locked=false; paused=false; startTimer(); };
  nextBtn.onclick  = async ()=>{ hideOverlay(); idx++; if(idx < TOTAL){ await showLoading(650); renderQuestion(idx,true); } else endScenario(); };

  if(missionFail){
    retryBtn.style.display="none"; nextBtn.style.display="none";
    okBtn.style.display="inline-block";
    okBtn.textContent="OK";
    okBtn.onclick = ()=>{ hideOverlay(); resetMission(true); };
  }
}
function hideOverlay(){ overlay.style.display="none"; }

function missionFail(message){
  stopTimer();
  showOverlay("bad", escapeHtml(message), {allowRetry:false, allowNext:false, missionFail:true});
  motion("critical");
}

/* ========= Animations ========= */
function motion(type){
  frame.classList.remove("shake","pulseGood","flashBad");
  modalBox.classList.remove("shake","pulseGood","flashBad");
  if(type==="good"){ frame.classList.add("pulseGood"); }
  else if(type==="wrong"){ modalBox.classList.add("shake"); }
  else if(type==="critical"){ modalBox.classList.add("shake"); frame.classList.add("flashBad"); }
}

/* ========= Reset mission ========= */
function resetMission(showStart=true){
  stopTimer();
  idx=0;
  attemptsForCurrentQuestion=0;
  hintUsedThisQuestion=false;

  setScore(0);
  setStress(0);

  hintsLeft = diff.hints;
  localStorage.setItem(HINT_KEY, String(hintsLeft));
  setHintsUI();
  setMiniHint();

  locked=true;
  paused=false;
  validateBtn.disabled=true;
  clearBtn.style.display="none";

  setProgress();

  if(showStart){
    startOverlay.style.display="flex";
  }

  // ‚úÖ resize after reset
  requestAnimationFrame(()=> window.__fitGenially && window.__fitGenially());
}

/* ========= Hint (auto) ========= */
function autoHintForQuestion(q){
  if(q.hint) return q.hint;

  if(q.type==="single"){
    const ok = (q.options||[]).find(o=>o.kind==="ok");
    return ok ? `Regarde l‚Äôobjectif prioritaire : <b>${escapeHtml(ok.text)}</b>.` : "Priorise la s√©curit√© et l‚ÄôABC.";
  }
  if(q.type==="tf"){
    const isTrueOk = (q.tf && q.tf.trueOpt && q.tf.trueOpt.kind==="ok");
    return `Pense ‚Äúrachis / immobilisation‚Äù ‚Üí plut√¥t <b>${isTrueOk ? "Vrai" : "Faux"}</b>.`;
  }
  if(q.type==="multi"){
    const goods = (q.options||[]).filter(o=>o.correct).map(o=>o.text);
    return goods.length ? `Coche ce qui concerne l‚Äô<b>√©tat</b> du patient : <b>${escapeHtml(goods.join(", "))}</b>.` : "Coche seulement ce qui surveille l‚Äô√©tat du patient.";
  }
  if(q.type==="image_single"){
    const ok = (q.options||[]).find(o=>o.kind==="ok");
    return ok ? `Cherche l‚Äôimage qui montre le <b>maintien t√™te-cou-tronc</b> : option <b>${escapeHtml(ok.label)}</b>.` : "Choisis l‚Äôimage la plus s√©curitaire (immobilisation).";
  }
  if(q.type==="drag_order"){
    return `Commence toujours par <b>s√©curiser</b>, puis <b>ABC</b>, puis <b>immobiliser</b>.`;
  }
  if(q.type==="hotspot"){
    return `Indice : zone √† prot√©ger = <b>rachis / colonne</b> (ne pas mobiliser).`;
  }
  if(q.type==="short"){
    return `Indice : c‚Äôest un mot li√© √† la <b>colonne vert√©brale</b>.`;
  }
  if(q.type==="cloze"){
    return `Indice : compl√®te uniquement les √©l√©ments essentiels (souvent des chiffres/termes cl√©s).`;
  }
  return "Indice : privil√©gie la s√©curit√©, l‚ÄôABC et l‚Äôimmobilisation si trauma.";
}

function useHint(){
  if(locked) return;
  if(hintsLeft<=0) return;
  if(hintUsedThisQuestion) return;

  hintsLeft--;
  localStorage.setItem(HINT_KEY, String(hintsLeft));
  hintUsedThisQuestion = true;

  paused = true;
  stopTimer();

  setHintsUI();
  setMiniHint();

  const q = questions[idx];
  const hintText = autoHintForQuestion(q);
  showOverlay("warn", `üí° <b>Indice</b><br><br>${hintText}`, {allowRetry:false, allowNext:false, missionFail:false});
  retryBtn.style.display="none";
  nextBtn.style.display="none";
  okBtn.style.display="inline-block";
  okBtn.textContent="Reprendre";
  okBtn.onclick = ()=>{ hideOverlay(); paused=false; locked=false; startTimer(); };
}

/* ========= Pause ========= */
function togglePause(){
  if(locked) return;
  paused = !paused;

  if(paused){
    stopTimer();
    showOverlay("warn",
      `‚è∏ <b>PAUSE</b><br><br>Tu peux reprendre quand tu veux.`,
      {allowRetry:false, allowNext:false, missionFail:false}
    );
    retryBtn.style.display="none";
    nextBtn.style.display="none";
    okBtn.style.display="inline-block";
    okBtn.textContent="Reprendre";
    okBtn.onclick = ()=>{ hideOverlay(); paused=false; locked=false; startTimer(); };
    pauseBtn.textContent = "‚ñ∂ Reprendre";
  }else{
    hideOverlay();
    locked=false;
    startTimer();
    pauseBtn.textContent = "‚è∏ Pause";
  }
}

/* ========= Render ========= */
function resetSelectionState(){
  selectedSingle=null;
  multiSelected.clear();
  inputValue="";
  clozeValues={};
  validateBtn.disabled=true;
}

function mkOpt(text){
  const d = document.createElement("div");
  d.className="opt";
  d.textContent=text;
  return d;
}

async function renderQuestion(i, resetAttempts=true){
  locked=false;
  paused=false;
  hideOverlay();

  if(resetAttempts){
    attemptsForCurrentQuestion=0;
    hintUsedThisQuestion=false;
  }
  setAttemptsUI();
  setHintsUI();
  setMiniHint();

  resetSelectionState();

  const q = questions[i];

  qMeta.textContent = `${SCENARIO.label} ‚Ä¢ ${diff.label}`;
  qTitle.textContent = q.title || "‚Äî";
  qDesc.innerHTML = q.desc || "";
  optionsEl.innerHTML = "";
  clearBtn.style.display = "none";

  setProgress();

  const type = q.type;

  if(type==="single"){
    (q.options||[]).forEach((opt, oi)=>{
      const d = mkOpt(opt.text);
      d.onclick=()=>{
        sfxClick();
        [...optionsEl.children].forEach(x=>x.classList.remove("sel"));
        d.classList.add("sel");
        selectedSingle=oi;
        validateBtn.disabled=false;
      };
      optionsEl.appendChild(d);
    });
  }

  if(type==="tf"){
    const opts=[{label:"Vrai",data:q.tf.trueOpt},{label:"Faux",data:q.tf.falseOpt}];
    opts.forEach((o, oi)=>{
      const d = mkOpt(o.label);
      d.onclick=()=>{
        sfxClick();
        [...optionsEl.children].forEach(x=>x.classList.remove("sel"));
        d.classList.add("sel");
        selectedSingle=oi;
        validateBtn.disabled=false;
      };
      optionsEl.appendChild(d);
    });
  }

  if(type==="multi"){
    clearBtn.style.display="inline-block";
    (q.options||[]).forEach((opt, oi)=>{
      const d=mkOpt(opt.text);
      d.onclick=()=>{
        sfxClick();
        if(multiSelected.has(oi)){ multiSelected.delete(oi); d.classList.remove("sel"); }
        else { multiSelected.add(oi); d.classList.add("sel"); }
        validateBtn.disabled = (multiSelected.size===0);
      };
      optionsEl.appendChild(d);
    });
  }

  if(type==="short"){
    clearBtn.style.display="inline-block";
    const box = document.createElement("div");
    box.className="opt"; box.style.cursor="default";
    box.innerHTML = `
      <div style="font-weight:950; margin-bottom:8px;">Ta r√©ponse</div>
      <input id="shortInput" class="form-control" type="text" placeholder="√âcris ici‚Ä¶"
        style="background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.18); color: rgba(255,255,255,.92);" />
      <div style="margin-top:8px; font-size:12px; color: rgba(255,255,255,.72);">Astuce : une valeur courte suffit.</div>
    `;
    optionsEl.appendChild(box);
    const inp = box.querySelector("#shortInput");
    inp.addEventListener("input", ()=>{
      inputValue = inp.value;
      validateBtn.disabled = (inp.value.trim().length===0);
    });
  }

  if(type==="image_single"){
    const grid = document.createElement("div");
    grid.className = "imgGrid";

    (q.options||[]).forEach((opt, oi)=>{
      const card = document.createElement("div");
      card.className = "imgCard";
      card.innerHTML = `
        <div class="imgHead">
          <div>Option ${escapeHtml(opt.label)}</div>
          <div class="imgTag">${escapeHtml(opt.label)}</div>
        </div>
        <img class="imgPic" src="${opt.imgSrc}" alt="Option ${escapeHtml(opt.label)}">
        <div class="imgCap">${escapeHtml(opt.caption||"")}</div>
      `;
      card.onclick = ()=>{
        sfxClick();
        [...grid.querySelectorAll(".imgCard")].forEach(c=>c.classList.remove("sel"));
        card.classList.add("sel");
        selectedSingle = oi;
        validateBtn.disabled = false;
      };
      grid.appendChild(card);
    });

    optionsEl.appendChild(grid);
  }

  if(type==="hotspot"){
    clearBtn.style.display="inline-block";

    const msg = document.createElement("div");
    msg.className="pill";
    msg.innerHTML = "üéØ <b>Clique sur la zone correcte</b> sur l‚Äôimage, puis appuie sur <b>Valider</b>.";
    optionsEl.appendChild(msg);

    const wrap = document.createElement("div");
    wrap.style.position="relative";
    wrap.style.width="100%";
    wrap.style.maxWidth="760px";
    wrap.style.margin="0 auto";
    wrap.style.borderRadius="18px";
    wrap.style.overflow="hidden";
    wrap.style.border="1px solid rgba(255,255,255,.14)";
    wrap.style.background="rgba(0,0,0,.18)";

    wrap.innerHTML = q.svg
      ? q.svg
      : `<img src="${q.imgSrc||""}" alt="hotspot" style="width:100%; height:auto; display:block;">`;

    optionsEl.appendChild(wrap);

    const zones = document.createElement("div");
    zones.style.position="absolute";
    zones.style.inset="0";
    zones.style.pointerEvents="auto";
    wrap.appendChild(zones);

    selectedSingle = null;

    (q.hotspots||[]).forEach((h, hi)=>{
      const z = document.createElement("button");
      z.type="button";
      z.className="hotspot-zone";
      z.style.left = h.x + "%";
      z.style.top  = h.y + "%";
      z.style.width = h.w + "%";
      z.style.height= h.h + "%";
      z.style.borderRadius = (h.r||16) + "px";
      z.onclick=()=>{
        sfxClick();
        [...zones.querySelectorAll("button")].forEach(b=>b.classList.remove("sel"));
        z.classList.add("sel");
        selectedSingle = hi;
        validateBtn.disabled = false;
      };
      zones.appendChild(z);
    });

    validateBtn.disabled = true;
  }

  if(type==="drag_order"){
    clearBtn.style.display="inline-block";

    const note = document.createElement("div");
    note.className="pill";
    note.textContent="üñ±Ô∏è Glisse-d√©pose les cartes pour les mettre dans l‚Äôordre.";
    optionsEl.appendChild(note);

    const list = document.createElement("div");
    list.id="dragList";
    list.style.display="grid";
    list.style.gap="10px";

    const items = [...(q.items||[])];
    for(let k=items.length-1;k>0;k--){
      const j=Math.floor(Math.random()*(k+1));
      [items[k],items[j]]=[items[j],items[k]];
    }

    items.forEach((it)=>{
      const row = document.createElement("div");
      row.className="opt";
      row.setAttribute("draggable","true");
      row.dataset.id = it.id;
      row.innerHTML = `<div style="font-weight:950;">${escapeHtml(it.text)}</div><div style="font-size:12px; color: rgba(255,255,255,.68); margin-top:3px;">(glisser)</div>`;
      list.appendChild(row);
    });
    optionsEl.appendChild(list);

    let dragSrc = null;
    list.addEventListener("dragstart",(e)=>{
      const target = e.target.closest("[draggable='true']");
      if(!target) return;
      dragSrc = target;
      e.dataTransfer.effectAllowed="move";
      target.style.opacity="0.6";
    });
    list.addEventListener("dragend",(e)=>{
      const target = e.target.closest("[draggable='true']");
      if(target) target.style.opacity="1";
      dragSrc=null;
    });
    list.addEventListener("dragover",(e)=>{
      e.preventDefault();
      e.dataTransfer.dropEffect="move";
      const over = e.target.closest("[draggable='true']");
      if(!over || !dragSrc || over===dragSrc) return;
      const rect = over.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      list.insertBefore(dragSrc, before ? over : over.nextSibling);
    });
    list.addEventListener("drop",(e)=>{
      e.preventDefault();
      validateBtn.disabled=false;
    });

    validateBtn.disabled = true;
  }

  hudQnum.textContent = String(i+1);

  setHintsUI();
  startTimer();

  // ‚úÖ re-fit apr√®s rendu (Genially)
  requestAnimationFrame(()=> window.__fitGenially && window.__fitGenially());
}

/* ========= Clear ========= */
clearBtn.onclick = async ()=>{
  sfxClick();
  await showLoading(450);
  renderQuestion(idx, false);
};

/* ========= Validate ========= */
function failedAttempt(baseMsg){
  attemptsForCurrentQuestion++;
  setAttemptsUI();

  if(attemptsForCurrentQuestion >= diff.attempts){
    sfxAlarmLong();
    missionFail(`‚ùå Limite atteinte (${diff.attempts}). Mission √©chou√©e. Retour au d√©part‚Ä¶ (score = 0)`);
    return;
  }
  showOverlay("warn", `${baseMsg}<br><br><span style="opacity:.85;">Tentative ${attemptsForCurrentQuestion}/${diff.attempts}</span>`, {
    allowRetry:true, allowNext:false, missionFail:false
  });
}

function evaluateOption(opt){
  if(opt.kind==="ok"){
    addScore(opt.pts ?? 10);
    showOverlay("good", escapeHtml(opt.fb || "‚úÖ Correct."), {allowRetry:false, allowNext:true, missionFail:false});
    sfxCorrect(); motion("good"); return;
  }
  if(opt.kind==="critical"){
    addStress(STRESS_RULES.critical);
    addScore(opt.pts ?? -10);
    sfxCritical(); motion("critical");
    failedAttempt(opt.fb || "üö® Erreur critique."); return;
  }
  if(opt.kind==="partial"){
    addStress(STRESS_RULES.wrong);
    addScore(opt.pts ?? 3);
    sfxWrong(); motion("wrong");
    failedAttempt(opt.fb || "üü° Partiel."); return;
  }
  addStress(STRESS_RULES.wrong);
  sfxWrong(); motion("wrong");
  failedAttempt(opt.fb || "‚ùå Incorrect.");
}

validateBtn.onclick = ()=>{
  if(locked || paused) return;

  const q = questions[idx];
  const type = q.type;

  const needSelection = (msg)=>{
    sfxClick();
    showOverlay("warn", escapeHtml(msg), {allowRetry:false, allowNext:false, missionFail:false});
    retryBtn.style.display="none";
    nextBtn.style.display="none";
    okBtn.style.display="inline-block";
    okBtn.textContent="OK";
    okBtn.onclick = ()=>{ hideOverlay(); locked=false; startTimer(); };
  };

  if(type==="single" || type==="tf" || type==="image_single" || type==="hotspot"){
    if(selectedSingle===null){ needSelection("Choisis une r√©ponse avant de valider."); return; }
  }
  if(type==="multi"){
    if(multiSelected.size===0){ needSelection("S√©lectionne au moins une proposition avant de valider."); return; }
  }
  if(type==="short"){
    if((inputValue||"").trim().length===0){ needSelection("√âcris une r√©ponse avant de valider."); return; }
  }

  stopTimer();
  locked=true;

  if(type==="single"){ evaluateOption(q.options[selectedSingle]); return; }

  if(type==="tf"){
    const opt = (selectedSingle===0) ? q.tf.trueOpt : q.tf.falseOpt;
    evaluateOption(opt); return;
  }

  if(type==="multi"){
    const chosen=[...multiSelected].sort((a,b)=>a-b);
    const correctIdx=q.options.map((o,i)=>o.correct?i:null).filter(v=>v!==null);
    const ok = chosen.length===correctIdx.length && chosen.every((v,i)=>v===correctIdx[i]);
    if(ok){
      addScore(10);
      showOverlay("good", escapeHtml(q.okFb || "‚úÖ Correct."), {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå Incorrect.");
    }
    return;
  }

  if(type==="short"){
    const norm=(inputValue||"").trim().toLowerCase();
    const accepted=(q.answers||[]).map(a=>String(a).trim().toLowerCase());
    const ok = accepted.includes(norm);
    if(ok){
      addScore(10);
      showOverlay("good", escapeHtml(q.okFb || "‚úÖ Bonne r√©ponse."), {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå R√©ponse incorrecte.");
    }
    return;
  }

  if(type==="image_single"){ evaluateOption(q.options[selectedSingle]); return; }

  if(type==="hotspot"){
    const h = (q.hotspots||[])[selectedSingle];
    if(!h){ locked=false; startTimer(); return; }

    if(h.kind==="ok"){
      addScore(h.pts ?? 10);
      showOverlay("good", escapeHtml(h.fb || "‚úÖ Correct."), {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else if(h.kind==="critical"){
      addStress(STRESS_RULES.critical);
      addScore(h.pts ?? -10);
      sfxCritical(); motion("critical");
      failedAttempt(h.fb || "üö® Erreur critique.");
    }else{
      addStress(STRESS_RULES.wrong);
      addScore(h.pts ?? 0);
      sfxWrong(); motion("wrong");
      failedAttempt(h.fb || "‚ùå Incorrect.");
    }
    return;
  }

  if(type==="drag_order"){
    const list = document.getElementById("dragList");
    const order = [...list.querySelectorAll("[draggable='true']")].map(x=>x.dataset.id);
    const ok = order.length===q.expected.length && q.expected.every((v,i)=>order[i]===v);
    if(ok){
      addScore(10);
      showOverlay("good", escapeHtml(q.okFb || "‚úÖ Bon ordre."), {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå Ordre incorrect.");
    }
    return;
  }
};

/* ========= Corrig√© (Key overlay) ========= */
function buildAnswerKeyHtml(){
  const rows = questions.map((q, i)=>{
    let ans = "";
    if(q.type==="single"){
      const oi = q.options.findIndex(o=>o.kind==="ok");
      ans = oi>=0 ? q.options[oi].text : "‚Äî";
    }else if(q.type==="image_single"){
      const oi = q.options.findIndex(o=>o.kind==="ok");
      ans = oi>=0 ? `${q.options[oi].label} ‚Äî ${q.options[oi].caption}` : "‚Äî";
    }else if(q.type==="tf"){
      ans = (q.tf.trueOpt.kind==="ok") ? "Vrai" : "Faux";
    }else if(q.type==="multi"){
      ans = q.options.filter(o=>o.correct).map(o=>o.text).join(" ; ");
    }else if(q.type==="short"){
      ans = (q.answers||[]).join(" / ");
    }else if(q.type==="drag_order"){
      const map = Object.fromEntries(q.items.map(it=>[it.id,it.text]));
      ans = q.expected.map(id=>map[id]).join(" ‚Üí ");
    }else if(q.type==="hotspot"){
      const ok = (q.hotspots||[]).find(h=>h.kind==="ok");
      ans = ok ? "Zone OK (rachis/colonne)" : "‚Äî";
    }else{
      ans = "‚Äî";
    }
    return `
      <tr>
        <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); width:56px; color: rgba(255,255,255,.75);">Q${i+1}</td>
        <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); font-weight:900;">${escapeHtml(q.title||"")}</td>
        <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); color: rgba(255,255,255,.86);">${escapeHtml(ans)}</td>
      </tr>
    `;
  }).join("");

  return `
    <div style="font-weight:950; font-size:16px; margin-bottom:10px;">Bonnes r√©ponses</div>
    <div style="overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.12);">
      <table style="width:100%; border-collapse:collapse; min-width:720px;">
        <thead>
          <tr>
            <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">#</th>
            <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">Question</th>
            <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">Bonne r√©ponse</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

showKeyBtn.onclick = ()=>{
  if(showKeyBtn.disabled) return;
  sfxClick();
  keyBody.innerHTML = buildAnswerKeyHtml();
  keyOverlay.style.display="flex";
};
keyCloseBtn.onclick = ()=>{
  sfxClick();
  keyOverlay.style.display="none";
};

/* ========= End scenario (badge) ========= */
function computeBadgeFromScore(){
  const max = TOTAL * 10;
  const pct = clamp(Math.round((score / max) * 100), 0, 100);

  if(pct >= 90) return { type:"OR", img:"or.png", label:"Badge Or" };
  if(pct >= 70) return { type:"ARGENT", img:"argent.png", label:"Badge Argent" };
  return { type:"BRONZE", img:"bronze.png", label:"Badge Bronze" };
}

function saveBadge(b){
  const payload = {
    scenarioId: SCENARIO.id,
    mission: SCENARIO.mission,
    niveau: diff.label,
    badgeType: b.type,
    badgeName: `${b.label} ‚Äî ${SCENARIO.mission}`,
    score,
    img: b.img,
    ts: Date.now()
  };
  localStorage.setItem(`badge_s${SCENARIO.id}_${diff.key}`, JSON.stringify(payload));

  const histKey = "badges_history";
  let hist = [];
  try{ hist = JSON.parse(localStorage.getItem(histKey)||"[]"); }catch(e){ hist=[]; }
  hist.unshift(payload);
  localStorage.setItem(histKey, JSON.stringify(hist.slice(0, 50)));
}

function endScenario(){
  stopTimer();
  hideOverlay();
  locked = true;
  paused = false;

  hintBtn.disabled = true;
  pauseBtn.disabled = true;
  clearBtn.style.display="none";
  validateBtn.disabled = true;

  progressBar.style.width = "100%";

  const badge = computeBadgeFromScore();
  saveBadge(badge);

  qMeta.textContent = "FIN ‚Äî BADGE OBTENU";
  qTitle.textContent = "üéâ Mission termin√©e";
  sfxVictory();

  const stressState = (stress>=80) ? "üî¥ Pression extr√™me" : (stress>=40) ? "üü° Sous pression" : "üü¢ Calme";

  qDesc.innerHTML = `
    <div style="margin-top:10px; color: rgba(255,255,255,.86); line-height:1.55;">
      <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
        <div style="width:88px; height:88px; border-radius:20px; overflow:hidden; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.22); display:grid; place-items:center;">
          <img src="assets/${badge.img}" alt="${badge.label}" style="width:72px; height:72px; object-fit:contain;">
        </div>
        <div>
          <div style="font-weight:950; font-size:18px;">üèÖ ${escapeHtml(badge.label)} ‚Äî ${escapeHtml(SCENARIO.mission)}</div>
          <div style="margin-top:6px; color: rgba(255,255,255,.74);">Niveau : <b>${escapeHtml(diff.label)}</b> ‚Ä¢ R√¥le : <b>${escapeHtml(roleLabelMap[role]||role)}</b></div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">‚≠ê Score final : <b>${score}</b></span>
        <span class="pill">üò∞ Stress : <b>${stress}%</b> (${escapeHtml(stressState)})</span>
      </div>

      <div style="margin-top:12px; color: rgba(255,255,255,.74);">
        <b>Conseil :</b> continue, l‚Äôobjectif est d‚Äôagir vite, en s√©curit√©, et avec m√©thode.
      </div>
    </div>
  `;

  optionsEl.innerHTML = `
    <div class="opt" style="cursor:default;">
      <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap;">
        <img src="assets/${badge.img}" alt="${badge.label}" style="width:64px; height:64px; object-fit:contain;">
        <div>
          <div style="font-weight:950; font-size:16px;">Badge enregistr√© ‚úÖ</div>
          <div style="margin-top:4px; color: rgba(255,255,255,.74); font-size:13px;">
            Il sera affich√© dans la page des badges.
          </div>
        </div>
      </div>
    </div>
  `;

  showKeyBtn.disabled = false;
  endBtn.style.display = "inline-block";

  endBtn.onclick = ()=>{
    sfxClick();
    window.location.href = NEXT_SCENARIO_URL;
  };

  // ‚úÖ refit apr√®s √©cran fin
  requestAnimationFrame(()=> window.__fitGenially && window.__fitGenially());
}

/* ========= Buttons ========= */
hintBtn.onclick = ()=>{ sfxClick(); useHint(); };
pauseBtn.onclick = ()=>{ sfxClick(); togglePause(); };

/* ========= Start ========= */
function applyStartOverlayText(){
  startMission.textContent = SCENARIO.mission;

  startRules.innerHTML = `
    Tu vas intervenir en situation d‚Äôurgence. Tu as <b>${diff.time} secondes</b> par question.<br>
    Tu as droit √† <b>${diff.attempts} tentative(s)</b> maximum par question (erreur ou temps √©coul√©).<br>
    Tu disposes de <b>${diff.hints} indice(s)</b> pour tout le sc√©nario, et <b>1 indice max par question</b>.<br><br>
    <b>Si tu atteins la limite</b> (tentatives/timeouts), tu retournes au d√©but de la mission (<b>score = 0</b>).
  `;
}

startBtn.addEventListener("click", async ()=>{
  ensureAudio();
  sfxClick();

  localStorage.setItem("score","0");
  localStorage.setItem("stress","0");
  setScore(0);
  setStress(0);

  if(!localStorage.getItem(HINT_KEY)){
    localStorage.setItem(HINT_KEY, String(diff.hints));
  }
  hintsLeft = parseInt(localStorage.getItem(HINT_KEY) || String(diff.hints), 10);
  if(isNaN(hintsLeft)) hintsLeft = diff.hints;

  setHintsUI();
  setMiniHint();

  startOverlay.style.display="none";
  locked=true;

  await showLoading(800);
  idx=0;
  setProgress();
  renderQuestion(0, true);

  requestAnimationFrame(()=> window.__fitGenially && window.__fitGenially());
});

/* ========= INIT ========= */
(function init(){
  setProfile();
  setTopLevel();

  setAttemptsUI();
  setScore(score);
  setStress(stress);

  if(!localStorage.getItem(HINT_KEY)){
    localStorage.setItem(HINT_KEY, String(diff.hints));
  }
  hintsLeft = parseInt(localStorage.getItem(HINT_KEY) || String(diff.hints), 10);
  if(isNaN(hintsLeft)) hintsLeft = diff.hints;

  setHintsUI();
  setMiniHint();

  applyStartOverlayText();

  locked=true;
  qMeta.textContent = SCENARIO.label;
  qTitle.textContent="Pr√©pare-toi‚Ä¶";
  qDesc.innerHTML=`Tu vas agir en tant que <b>${escapeHtml(roleLabelMap[role]||role)}</b>. Clique sur <b>D√âMARRER</b>.`;
  optionsEl.innerHTML="";
  hudQnum.textContent="1";
  hudTime.textContent=String(diff.time);
  ring.style.setProperty("--p","100%");
  setRingProgress();
  setProgress();

  // ‚úÖ fit initial (Genially)
  requestAnimationFrame(()=> window.__fitGenially && window.__fitGenially());
})();
</script>

  <script src="badge-manager.js"></script>
</body>
</html>
