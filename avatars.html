<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Urgences – Choix de l’avatar</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    html, body { background: transparent; margin: 0; color: #fff; }

    .page-wrap{
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 32px 18px;
      position: relative;
    }

    .glass{
      width: min(920px, 100%);
      background: rgba(0,0,0,.42);
      border: 1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(10px);
      border-radius: 22px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      overflow: hidden;
      position: relative;
    }

    /* Particles overlay */
    #fx {
      position:absolute;
      inset: 0;
      width:100%;
      height:100%;
      pointer-events:none;
      opacity: .85;
      mix-blend-mode: screen;
    }

    .header{
      padding: 18px 18px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      position: relative;
      z-index: 2;
    }

    .hello{
      font-size: 13px;
      color: rgba(255,255,255,.78);
      margin: 0 0 6px;
      letter-spacing: .2px;
    }
    .hello b{
      color: rgba(255, 190, 110, 0.98);
    }

    .title{
      margin: 0;
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 22px;
    }

    .subtitle{
      margin: 6px 0 0;
      color: rgba(255,255,255,.72);
      font-size: 13px;
    }

    /* Trio assemblé */
    .trio-wrap{
      padding: 18px;
      display:flex;
      justify-content:center;
      position: relative;
      z-index: 2;
    }

    .trio{
      width: min(740px, 100%);
      height: 360px;
      position: relative;
      display:flex;
      justify-content:center;
      align-items:flex-end;
    }

    .avatar-pick{
      position:absolute;
      bottom: 0;
      height: 330px;
      width: auto;
      cursor: pointer;
      user-select: none;
      -webkit-user-drag: none;
      filter: drop-shadow(0 18px 18px rgba(0,0,0,.45));
      transition: transform .16s ease, filter .16s ease, opacity .16s ease;
      outline: none;
    }

    .left  { left: 6%;  transform: scale(.96); z-index: 1; opacity: .98; }
    .center{ left: 50%; transform: translateX(-50%) scale(1.03); z-index: 3; }
    .right { right: 6%; transform: scale(.96); z-index: 1; opacity: .98; }

    .avatar-pick:hover{
      transform: translateY(-3px) scale(1.00);
      filter: drop-shadow(0 22px 22px rgba(0,0,0,.55));
    }

    .selected{
      filter:
        drop-shadow(0 26px 28px rgba(0,0,0,.65))
        drop-shadow(0 0 18px rgba(255,165,0,.55));
      z-index: 5 !important;
      opacity: 1 !important;
      transform: translateY(-6px) scale(1.03) !important;
    }
    .dimmed{
      opacity: .55;
      transform: scale(.94);
    }

    .footer{
      padding: 14px 18px 18px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 2;
    }

    /* Animated appearance */
    .pop {
      animation: popIn .25s ease both;
    }
    @keyframes popIn{
      from{ transform: translateY(8px) scale(.98); opacity: 0; }
      to  { transform: translateY(0)   scale(1);   opacity: 1; }
    }

    .badge-ready{
      display:none;
      background: rgba(25, 135, 84, .22);
      border: 1px solid rgba(25, 135, 84, .35);
      color: rgba(255,255,255,.92);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      gap: 8px;
      align-items:center;
    }

    .btn-ember{
      display:none;
      border: 0;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 800;
      background: linear-gradient(180deg, rgba(255, 176, 90, 1), rgba(255, 120, 50, 1));
      color: rgba(10,12,18,.95);
      box-shadow: 0 16px 35px rgba(255, 120, 50, .22);
    }

    .btn-ghost{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.12);
      color: rgba(255,255,255,.85);
      padding: 10px 14px;
      font-weight: 700;
    }

    @media (max-width: 576px){
      .trio{ height: 270px; }
      .avatar-pick{ height: 240px; }
      .left{ left: 1%; }
      .right{ right: 1%; }
    }
  </style>
</head>

<body>
  <div class="page-wrap">
    <div class="glass">
      <canvas id="fx"></canvas>

      <div class="header">
        <p class="hello" id="helloLine"></p>
        <div class="title">Choisis ton avatar</div>
        <div class="subtitle" id="roleLine"></div>
      </div>

      <div class="trio-wrap">
        <div class="trio" id="trio"></div>
      </div>

      <div class="footer">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="badge-ready" id="readyBadge">✅ Avatar sélectionné</span>
          <span class="text-white-50" style="font-size:12px;" id="helpTxt">
            Clique sur un avatar pour le sélectionner.
          </span>
        </div>

        <div class="d-flex gap-2">
          <button class="btn-ghost" type="button" id="resetBtn">Réinitialiser</button>
          <button class="btn-ember" type="button" id="nextBtn">Suivant</button>
        </div>
      </div>

    </div>
  </div>

<script>
  // ---- A) Bonjour [Prénom] ----
  const playerName = localStorage.getItem("playerName") || "Joueur";
  document.getElementById("helloLine").innerHTML =
    `Bonjour <b>${escapeHtml(playerName)}</b>, choisis ton avatar.`;

  // ---- B) Métier ----
  const role = localStorage.getItem("role");
  const roleLine = document.getElementById("roleLine");

  const roleLabels = {
    medecin: "Métier choisi : Médecin",
    infirmier: "Métier choisi : Infirmier",
    pompier: "Métier choisi : Pompier"
  };

  if (!role || !roleLabels[role]) {
    roleLine.textContent = "Aucun métier sélectionné. Retournez à l’étape précédente.";
  } else {
    roleLine.textContent = roleLabels[role];
  }

  // ---- C) Avatars par métier ----
  const avatarsByRole = {
    medecin: [
      {pos:"left",   file:"medecin_f.png",         alt:"Médecin femme"},
      {pos:"center", file:"medecin_f_voilee.png",  alt:"Médecin femme voilée"},
      {pos:"right",  file:"medecin_h.png",         alt:"Médecin homme"}
    ],
    infirmier: [
      {pos:"left",   file:"infirmier_f.png",        alt:"Infirmier femme"},
      {pos:"center", file:"infirmier_f_voilee.png", alt:"Infirmier femme voilée"},
      {pos:"right",  file:"infirmier_h.png",        alt:"Infirmier homme"}
    ],
    pompier: [
      {pos:"left",   file:"pompier_f.png",          alt:"Pompier femme"},
      {pos:"center", file:"pompier_f_voilee.png",   alt:"Pompier femme voilée"},
      {pos:"right",  file:"pompier_h.png",          alt:"Pompier homme"}
    ]
  };

  const trio = document.getElementById("trio");
  const readyBadge = document.getElementById("readyBadge");
  const nextBtn = document.getElementById("nextBtn");
  const resetBtn = document.getElementById("resetBtn");
  const helpTxt = document.getElementById("helpTxt");

  let selectedFile = null;

  function renderTrio() {
    trio.innerHTML = "";
    const items = avatarsByRole[role];
    if (!items) return;

    items.forEach(item => {
      const img = document.createElement("img");
      img.className = `avatar-pick ${item.pos}`;
      img.src = `assets/avatars/${item.file}`;
      img.alt = item.alt;
      img.dataset.file = item.file;
      img.addEventListener("click", () => selectAvatar(item.file));
      trio.appendChild(img);
    });

    // Restore previous selection if any
    const saved = localStorage.getItem("avatar");
    if (saved) selectAvatar(saved, true);
  }

  function showReadyUI(silent){
    readyBadge.style.display = "inline-flex";
    nextBtn.style.display = "inline-block";

    // animate only once
    if (!readyBadge.classList.contains("pop")) readyBadge.classList.add("pop");
    if (!nextBtn.classList.contains("pop")) nextBtn.classList.add("pop");

    helpTxt.textContent = silent ? "Avatar restauré. Clique sur Suivant." : "Parfait. Tu peux continuer.";
  }

  function selectAvatar(file, silent=false) {
    selectedFile = file;

    document.querySelectorAll(".avatar-pick").forEach(el => {
      const isSelected = el.dataset.file === file;
      el.classList.toggle("selected", isSelected);
      el.classList.toggle("dimmed", !isSelected);
    });

    localStorage.setItem("avatar", file);
    localStorage.setItem("setupDone", "true");

    // Start particles burst on selection
    particles.burst();

    showReadyUI(silent);
  }

  resetBtn.addEventListener("click", () => {
    localStorage.removeItem("avatar");
    localStorage.removeItem("setupDone");
    selectedFile = null;

    document.querySelectorAll(".avatar-pick").forEach(el => {
      el.classList.remove("selected", "dimmed");
    });

    readyBadge.style.display = "none";
    nextBtn.style.display = "none";
    helpTxt.textContent = "Clique sur un avatar pour le sélectionner.";

    // reset animation classes so they pop again later
    readyBadge.classList.remove("pop");
    nextBtn.classList.remove("pop");
  });

  nextBtn.addEventListener("click", () => {
    if (!selectedFile) return;

    // Avec Genially, le plus fiable est de cliquer sur le bouton "Suivant" Genially
    alert("✅ Prêt ! Clique maintenant sur « Suivant » dans Genially pour commencer le jeu.");

    // Si tu as une page HTML scene1.html et tu veux y aller directement :
    // window.location.href = "scene1.html";
  });

  // ---- D) Particules (canvas) ----
  const canvas = document.getElementById("fx");
  const ctx = canvas.getContext("2d");

  function resize(){
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = Math.floor(rect.width);
    canvas.height = Math.floor(rect.height);
  }
  window.addEventListener("resize", resize);

  const particles = {
    list: [],
    last: performance.now(),
    enabled: true,

    spawn(x, y, count, power){
      for(let i=0;i<count;i++){
        const a = Math.random() * Math.PI * 2;
        const sp = (Math.random() * 0.9 + 0.2) * power;
        this.list.push({
          x, y,
          vx: Math.cos(a) * sp,
          vy: Math.sin(a) * sp - 0.6,
          life: 1,
          size: Math.random()*2.2 + 0.9,
          hue: 28 + Math.random()*18, // ember-ish
          alpha: 0.85
        });
      }
    },

    burst(){
      // centre de la carte (légèrement au-dessus)
      const x = canvas.width * 0.50;
      const y = canvas.height * 0.50;
      this.spawn(x, y, 52, 2.2);
    },

    tick(now){
      const dt = Math.min(0.033, (now - this.last) / 1000);
      this.last = now;

      ctx.clearRect(0,0,canvas.width,canvas.height);

      // faint ambient sparks (low rate)
      if (Math.random() < 0.08) {
        this.spawn(canvas.width*(0.2+Math.random()*0.6), canvas.height*(0.2+Math.random()*0.6), 2, 0.8);
      }

      // update
      this.list = this.list.filter(p => p.life > 0);
      for(const p of this.list){
        p.vy += 1.2 * dt;        // gravity
        p.vx *= (1 - 0.7*dt);    // drag
        p.vy *= (1 - 0.5*dt);

        p.x += p.vx * 60 * dt;
        p.y += p.vy * 60 * dt;

        p.life -= 1.25 * dt;
        const t = Math.max(0, p.life);
        const a = p.alpha * t;

        ctx.beginPath();
        ctx.fillStyle = `hsla(${p.hue}, 100%, 60%, ${a})`;
        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        ctx.fill();
      }

      requestAnimationFrame(this.tick.bind(this));
    }
  };

  function escapeHtml(str){
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // init
  resize();
  requestAnimationFrame(particles.tick.bind(particles));
  renderTrio();
</script>

</body>
</html>
