<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sc√©nario 4 ‚Äî Accident de la voie publique ‚Äî Interm√©diaire ‚Äî Pompier</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --glass: rgba(25, 27, 31, .72);
      --glass2: rgba(15, 17, 20, .55);

      --text: rgba(255,255,255,.93);
      --muted: rgba(255,255,255,.70);

      --gold: rgba(255,200,80,1);
      --red: rgba(255,70,70,1);
      --green: rgba(45,200,120,1);
      --blue: rgba(80,170,255,1);
      --ember: rgba(255,150,70,1);
      --ember2: rgba(255,120,50,1);
    }

    *{ box-sizing:border-box; }

    html,body{
      margin:0;
      height:100%;
      background: transparent;
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden; /* ‚úÖ anti-scroll Genially */
    }

    /* ‚úÖ Genially-like layout (r√©f√©rence) */
    .stage{
      height: 100vh;
      padding: 10px;
      overflow:hidden;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .wrap{
      width: min(1650px, 100%);
      height: 100%;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
    }

    /* Top tabs (r√©f√©rence) */
    .topTabs{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:12px;
      position:relative;
      z-index:5;
    }
    .levelTab{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius:999px;
      background: var(--glass);
      border:1px solid rgba(255,200,150,.22);
      box-shadow: 0 18px 55px rgba(0,0,0,.40);
      backdrop-filter: blur(12px);
      font-weight:950;
      letter-spacing:.25px;
      text-transform:uppercase;
      font-size:12px;
    }
    .levelDot{
      width:12px; height:12px; border-radius:999px;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      box-shadow: 0 0 0 4px rgba(255,150,70,.18);
      flex:0 0 auto;
    }

    .progressShell{
      flex:1 1 220px;
      min-width:220px;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: 0 18px 55px rgba(0,0,0,.25);
      backdrop-filter: blur(12px);
    }
    .progressBar{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(80,170,255,1), rgba(255,150,70,1));
      transition: width .25s ease;
    }

    .miniHint{
      padding: 10px 12px;
      border-radius:999px;
      background: var(--glass);
      border:1px solid rgba(255,200,150,.22);
      box-shadow: 0 18px 55px rgba(0,0,0,.40);
      backdrop-filter: blur(12px);
      font-weight:950;
      font-size:12px;
      color: rgba(255,255,255,.85);
      white-space:nowrap;
    }

    /* HUD */
    .hud{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      position:relative;
      z-index:5;
    }
    .hudbox{
      background: var(--glass);
      border: 1px solid rgba(255, 200, 150, .22);
      border-radius: 18px;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      position: relative;
      overflow:hidden;
      box-shadow: 0 18px 65px rgba(0,0,0,.45);
      backdrop-filter: blur(12px);
      min-height: 92px;
    }
    .hudbox::after{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      background:
        radial-gradient(420px 160px at 15% 0%, rgba(255,150,70,.18), transparent 60%),
        radial-gradient(520px 220px at 85% 120%, rgba(80,170,255,.10), transparent 60%);
      opacity:.9;
    }

    .profile{ display:flex; align-items:center; gap: 14px; min-width: 0; position: relative; z-index:2; }

    .avatarFrame{
      width: 92px; height: 92px; border-radius: 24px; padding: 4px;
      background: linear-gradient(180deg, rgba(255,150,70,.36), rgba(80,170,255,.14));
      box-shadow: 0 18px 42px rgba(0,0,0,.45);
      flex: 0 0 auto;
    }
    .avatar{
      width:100%; height:100%;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.12);
      object-fit: cover;
      object-position: 50% 6%;
      transform: scale(1.35);
      transform-origin: 50% 12%;
      background: rgba(255,255,255,.06);
    }

    .ptext{ min-width:0; }
    .pname{ font-weight: 950; font-size: 22px; line-height: 1.05; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; text-shadow: 0 14px 30px rgba(0,0,0,.55); }
    .prole{ margin-top: 4px; font-weight: 850; font-size: 13px; color: var(--muted); white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }

    .chip{
      background: rgba(255,150,70,.14);
      border: 1px solid rgba(255,150,70,.20);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 12px;
      font-weight: 950;
      white-space: nowrap;
      position: relative;
      z-index:2;
    }

    .stats{ display:flex; align-items:center; justify-content:flex-end; gap: 10px; flex-wrap: wrap; position: relative; z-index:2; }

    .pill{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-weight: 950;
      font-size: 13px;
      white-space: nowrap;
    }

    .timerPill{ padding: 8px 10px; gap: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18); }

    .ring{
      width: 40px; height: 40px; border-radius: 999px;
      background: conic-gradient(var(--gold) var(--p, 0%), rgba(255,255,255,.14) 0);
      display:grid; place-items:center;
      box-shadow: 0 0 0 5px rgba(255,200,80,.14), 0 0 28px rgba(255,200,80,.10);
      transition: box-shadow .2s ease;
    }
    .ringInner{
      width: 28px; height: 28px; border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      color: rgba(255,255,255,.9);
      font-size: 14px; font-weight: 950;
    }

    .timeText{ display:flex; align-items:center; gap: 8px; }
    .timeText .label{ font-size: 12px; font-weight: 900; color: rgba(255,255,255,.75); }
    .timeText .sec{ font-size: 16px; font-weight: 950; }

    .timerWarn .ring{
      background: conic-gradient(var(--gold) var(--p, 0%), rgba(255,255,255,.14) 0);
      box-shadow: 0 0 0 5px rgba(255,200,80,.18), 0 0 32px rgba(255,200,80,.14);
    }
    .timerDanger .ring{
      background: conic-gradient(var(--red) var(--p, 0%), rgba(255,255,255,.14) 0);
      box-shadow: 0 0 0 5px rgba(255,70,70,.20), 0 0 40px rgba(255,70,70,.18);
    }

    .stressWrap{
      width: 240px; height: 12px; border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .stressBar{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(45,200,120,.95), rgba(255,200,80,.95), rgba(255,70,70,.95));
      transition: width .25s ease;
    }

    /* ‚úÖ Frame = taille fixe / options scroll / actions fix√©es */
    .frame{
      background: var(--glass2);
      border: 1px solid rgba(255, 200, 150, .22);
      border-radius: 18px;
      padding: 18px;
      position: relative;
      overflow:hidden;
      box-shadow: 0 18px 70px rgba(0,0,0,.50);
      backdrop-filter: blur(12px);

      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .frame::after{
      content:"";
      position:absolute; inset:-2px; pointer-events:none;
      background:
        radial-gradient(800px 260px at 55% 0%, rgba(255,150,70,.16), transparent 60%),
        radial-gradient(760px 260px at 40% 120%, rgba(80,170,255,.10), transparent 60%);
      opacity:.9;
    }

    .qmeta{ position: relative; z-index:2; color: rgba(255,255,255,.70); font-size: 12px; font-weight: 950; letter-spacing: .35px; text-transform: uppercase; }
    .qtitle{ position: relative; z-index:2; margin-top: 2px; font-weight: 950; font-size: clamp(18px, 2.2vw, 26px); line-height: 1.2; text-shadow: 0 14px 30px rgba(0,0,0,.55); }
    .qdesc{ position: relative; z-index:2; margin-top: 4px; color: rgba(255,255,255,.82); font-size: 14px; line-height: 1.5; max-width: 1100px; }

    .options{
      position: relative;
      z-index:2;
      display:flex;
      flex-direction:column;
      gap: 12px;
      margin-top: 6px;

      flex:1;
      min-height:0;
      overflow:auto;
      padding-right: 6px;
    }
    .options::-webkit-scrollbar{ width: 10px; }
    .options::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.14);
      border: 2px solid rgba(0,0,0,.22);
      border-radius: 999px;
    }
    .options::-webkit-scrollbar-track{ background: rgba(255,255,255,.06); border-radius:999px; }

    .opt{
      border-radius: 14px;
      padding: 13px 14px;
      font-weight: 950;
      letter-spacing: .2px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, filter .12s ease, background .12s ease;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(80,170,255,.22), rgba(80,170,255,.14));
      box-shadow: 0 10px 28px rgba(0,0,0,.20);
    }
    .opt:hover{ transform: translateY(-1px); filter: brightness(1.07); background: linear-gradient(180deg, rgba(255,150,70,.22), rgba(80,170,255,.10)); }
    .opt:active{ transform: translateY(0px); filter: brightness(.98); }

    .opt.sel{
      background: linear-gradient(180deg, rgba(255,150,70,.30), rgba(255,120,50,.18));
      border-color: rgba(255,150,70,.30);
      box-shadow: 0 0 0 3px rgba(255,150,70,.10), 0 16px 34px rgba(0,0,0,.28);
    }

    /* ‚úÖ Actions fix√©es en bas du conteneur (r√©f√©rence) */
    .actions{
      position: sticky;
      bottom: 0;
      z-index: 10;
      padding-top: 10px;
      margin-top: 6px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .actionsLeft, .actionsRight{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btnNeo{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.90);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 950;
      letter-spacing: .2px;
    }

    .btnPrimary{
      border: none;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      color: rgba(10,12,18,.96);
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .btnPrimary:disabled{ opacity:.45; cursor:not-allowed; }

    .overlay{
      position: fixed; inset: 0;
      display:none; align-items:center; justify-content:center;
      z-index: 60;
      background: rgba(0,0,0,.48);
      backdrop-filter: blur(8px);
    }

    .modalBox{
      width: min(760px, 92%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(8,10,14,.82);
      box-shadow: 0 26px 90px rgba(0,0,0,.62);
      overflow:hidden;
      position: relative;
    }

    .modalTop{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }

    .badgeState{
      font-weight: 950;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }
    .bGood{ border-color: rgba(45,200,120,.30); background: rgba(45,200,120,.12); }
    .bWarn{ border-color: rgba(255,200,80,.30); background: rgba(255,200,80,.12); }
    .bBad { border-color: rgba(255,70,70,.35); background: rgba(255,70,70,.12); }

    .modalBody{ padding: 16px; color: rgba(255,255,255,.92); line-height: 1.5; font-size: 14px; }
    .modalActions{
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex; justify-content:flex-end; gap: 10px; flex-wrap: wrap;
    }

    .startTitle{ font-weight: 950; font-size: 22px; margin-bottom: 6px; }
    .startText{ color: rgba(255,255,255,.82); font-size: 14px; line-height: 1.45; }
    .startBtn{
      border:none; border-radius: 14px; padding: 12px 16px;
      font-weight: 950; letter-spacing: .3px;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      color: rgba(10,12,18,.96);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
    }

    .shake{ animation: shake .24s linear 1; }
    @keyframes shake{
      0% { transform: translateX(0px); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
      100%{ transform: translateX(0px); }
    }
    .pulseGood{ animation: pulseGood .32s ease 1; }
    @keyframes pulseGood{
      from{ box-shadow: 0 0 0 0 rgba(45,200,120,.0); }
      50%{ box-shadow: 0 0 0 7px rgba(45,200,120,.18); }
      to{ box-shadow: 0 0 0 0 rgba(45,200,120,.0); }
    }
    .flashBad{ animation: flashBad .30s ease 1; }
    @keyframes flashBad{
      from{ box-shadow: 0 0 0 0 rgba(255,70,70,.0); }
      50%{ box-shadow: 0 0 0 7px rgba(255,70,70,.22); }
      to{ box-shadow: 0 0 0 0 rgba(255,70,70,.0); }
    }

    @media (max-width: 980px){
      .hud{ grid-template-columns: 1fr; }
      .stressWrap{ width: 190px; }
      .progressShell{ min-width: 100%; }
    }

    /* Hotspot zones */
    @keyframes hsPulse {
      0% { box-shadow: 0 0 0 0 rgba(255,255,255,.25); border-color: rgba(255,255,255,.55); }
      70% { box-shadow: 0 0 0 14px rgba(255,255,255,0); border-color: rgba(255,255,255,.85); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); border-color: rgba(255,255,255,.55); }
    }
    .hotspot-zone{
      position:absolute;
      background: transparent !important;
      border: 2px solid rgba(255,255,255,.65);
      border-radius: 16px;
      padding:0;
      margin:0;
      cursor:pointer;
      animation: hsPulse 1.35s infinite;
    }
    .hotspot-zone.sel{
      border-color: rgba(34,197,94,.95);
      box-shadow: 0 0 0 6px rgba(34,197,94,.20);
      animation: none;
    }

    /* Image cards */
    .imgGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:16px;
      margin-top:12px;
    }
    @media (max-width: 900px){
      .imgGrid{ grid-template-columns: 1fr; }
    }
    .imgCard{
      border-radius:18px;
      overflow:hidden;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      transition:.15s ease;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
    }
    .imgCard:hover{ transform:translateY(-3px); filter:brightness(1.05); }
    .imgCard.sel{
      outline:3px solid rgba(255,165,0,.4);
      box-shadow:0 0 0 4px rgba(255,165,0,.25), 0 20px 40px rgba(0,0,0,.35);
    }
    .imgHead{
      padding:12px 16px;
      font-weight:900;
      display:flex;
      justify-content:space-between;
      background:linear-gradient(180deg, rgba(120,180,255,.25), rgba(120,180,255,.10));
    }
    .imgTag{
      width:36px;
      height:36px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      background:rgba(0,0,0,.25);
    }
    .imgPic{
      width:100%;
      height:220px;  /* ‚úÖ r√©f√©rence */
      object-fit:cover;
      display:block;
    }
    .imgCap{
      padding:14px;
      text-align:center;
      font-weight:800;
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="wrap">

      <!-- TOP -->
      <div class="topTabs">
        <div class="levelTab">
          <span class="levelDot"></span>
          <span id="levelTabText">NIVEAU: INTERM√âDIAIRE</span>
        </div>

        <div class="progressShell" aria-label="progression">
          <div class="progressBar" id="progressBar"></div>
        </div>

        <div class="miniHint" id="miniHint">Dur√©e 45s ‚Ä¢ Tentatives 2 ‚Ä¢ Indices 2 </div>
      </div>

      <!-- HUD -->
      <div class="hud">
        <div class="hudbox">
          <div class="profile">
            <div class="avatarFrame">
              <img class="avatar" id="hudAvatar" alt="Avatar">
            </div>
            <div class="ptext">
              <div class="pname" id="hudName">Joueur</div>
              <div class="prole" id="hudRole">R√¥le: ‚Äî</div>
            </div>
          </div>
          <div class="chip" id="difficultyChip">MODE: INTERM√âDIAIRE</div>
        </div>

        <div class="hudbox">
          <div class="stats">
		  
		  

            <div class="pill">‚≠ê Score <span id="hudScore">0</span></div>
            <div class="pill">Q <span id="hudQnum">1</span>/<span id="hudQtotal">20</span></div>
            <div class="pill">üéØ Tentatives <span id="hudAttempts">1</span>/<span id="hudAttemptsMax">3</span></div>
            <div class="pill">üí° Indices <span id="hudHints">2</span>/<span id="hudHintsMax">2</span></div>

            <button class="btnNeo" id="pauseBtn" type="button">‚è∏ Pause</button>				
            <button class="btnNeo" id="hintBtn" type="button">üí° Indice</button>
			
			<div class="stressWrap" title="Stress">
              <div class="stressBar" id="stressBar"></div>
            </div>		          

		  <div class="pill timerPill" id="timerPill">
              <div class="ring" id="ring"><div class="ringInner">‚è±</div></div>
              <div class="timeText">
                <div class="label">Temps</div>
                <div class="sec"><span id="hudTime">45</span>s</div>
              </div>
            </div>
        </div>
        </div>
      </div>

      <!-- FRAME -->
      <div class="frame" id="frame">
        <div class="qmeta" id="qMeta">Sc√©nario 4 ‚Äî Accident de la voie publique</div>
        <div class="qtitle" id="qTitle">‚Ä¶</div>
        <div class="qdesc" id="qDesc">‚Ä¶</div>

        <div class="options" id="options"></div>

        <!-- ‚úÖ Actions (BS + fix√©es) -->
        <div class="actions">
          <div class="actionsLeft">
            <button class="btnNeo" id="keyBtn" type="button" disabled>üìò Corrig√©</button>
            <button class="btnPrimary" id="continueBtn" type="button" style="display:none;">Continuer</button>
          </div>
          <div class="actionsRight">
            <button class="btnNeo" id="clearBtn" type="button" style="display:none;">Effacer</button>
            <button class="btnPrimary" id="validateBtn" type="button" disabled>Valider</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- START overlay -->
  <div class="overlay" id="startOverlay" style="display:flex;">
    <div class="modalBox">
      <div class="modalTop">
        <div class="badgeState bWarn">üéÆ Pr√™t ?</div>
        <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
          Mission ‚Ä¢ Accident de la voie publique
        </div>
      </div>
      <div class="modalBody">
        <div class="startTitle">Tu as une mission.</div>
        <div class="startText" id="startRules">
          Tu vas intervenir en situation d‚Äôurgence.
          <br><br>
          <b>R√®gles ‚Äî Interm√©diaire :</b>
          <ul style="margin:10px 0 0 18px; color: rgba(255,255,255,.84);">
            <li><b>45s</b> par question</li>
            <li><b>3</b> tentatives maximum par question</li>
            <li><b>2</b> indices pour tout le sc√©nario</li>
            <li><b>1 indice maximum</b> par question</li>
          </ul>
          <div style="margin-top:10px; color: rgba(255,255,255,.78);">
            Si tu √©puises tes tentatives ou si le temps s‚Äô√©coule, la mission red√©marre (score remis √† z√©ro).
          </div>
        </div>
      </div>
      <div class="modalActions">
        <button class="startBtn" id="startBtn">D√âMARRER</button>
      </div>
    </div>
  </div>

  <!-- Feedback overlay -->
  <div class="overlay" id="overlay">
    <div class="modalBox" id="modalBox">
      <div class="modalTop">
        <div class="badgeState" id="badgeState">‚Äî</div>
        <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
          Score: <span id="modalScore">0</span> ‚Ä¢ Stress: <span id="modalStress">0</span>%
        </div>
      </div>
      <div class="modalBody" id="modalText">‚Ä¶</div>
      <div class="modalActions">
        <button class="btnNeo" id="retryBtn">R√©essayer</button>
        <button class="btnPrimary" id="nextBtn">Suivant</button>
        <button class="btnPrimary" id="okBtn" style="display:none;">OK</button>
      </div>
    </div>
  </div>

  <!-- Pause overlay -->
  <div class="overlay" id="pauseOverlay">
    <div class="modalBox">
      <div class="modalTop">
        <div class="badgeState bWarn">‚è∏ Pause</div>
        <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
          Chrono en pause
        </div>
      </div>
      <div class="modalBody">
        Tu peux reprendre quand tu veux.
      </div>
      <div class="modalActions">
        <button class="btnPrimary" id="resumeBtn">Reprendre</button>
      </div>
    </div>
  </div>

  <!-- Hint overlay -->
  <div class="overlay" id="hintOverlay">
    <div class="modalBox">
      <div class="modalTop">
        <div class="badgeState bWarn">üí° Indice</div>
        <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
          Indices restants : <span id="hintLeftText">2</span>
        </div>
      </div>
      <div class="modalBody" id="hintText">‚Ä¶</div>
      <div class="modalActions">
        <button class="btnPrimary" id="hintOkBtn">OK</button>
      </div>
    </div>
  </div>

<script>
/* ========= SFX ========= */
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function tone(freq, dur=0.08, type="sine", gain=0.05){
  ensureAudio();
  const t0 = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type; osc.frequency.value = freq;
  g.gain.value = gain;
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(t0); osc.stop(t0 + dur);
}
function sfxClick(){ tone(520,0.04,"triangle",0.035); }
function sfxCorrect(){ tone(660,0.07,"sine",0.06); setTimeout(()=>tone(880,0.08,"sine",0.06), 80); }
function sfxWrong(){ tone(220,0.10,"square",0.05); setTimeout(()=>tone(180,0.12,"square",0.05), 90); }
function sfxCritical(){ tone(140,0.14,"sawtooth",0.05); setTimeout(()=>tone(120,0.16,"sawtooth",0.05), 120); }
function sfxAlarmLong(){
  ensureAudio();
  const now = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = "sawtooth";
  osc.frequency.setValueAtTime(520, now);
  osc.frequency.linearRampToValueAtTime(380, now + 0.35);
  osc.frequency.linearRampToValueAtTime(520, now + 0.70);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.07, now + 0.02);
  g.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(now); osc.stop(now + 1.25);
}
function sfxVictory(){
  ensureAudio();
  const notes = [
    {f:659,d:0.10},{f:784,d:0.10},{f:988,d:0.14},
    {f:1175,d:0.18},{f:988,d:0.14},{f:1047,d:0.22}
  ];
  let t = 0;
  notes.forEach((n)=>{
    setTimeout(()=>tone(n.f, n.d, "sine", 0.065), t*1000);
    t += n.d + 0.03;
  });
}

/* ========= Helpers ========= */
const el = (id)=>document.getElementById(id);
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function escapeHtml(str){ return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

/* ========= Elements ========= */
const hudName = el("hudName"), hudRole = el("hudRole"), hudAvatar = el("hudAvatar"), difficultyChip = el("difficultyChip");
const hudScore = el("hudScore"), hudQnum = el("hudQnum"), hudQtotal = el("hudQtotal"),
      hudAttempts = el("hudAttempts"), hudAttemptsMax = el("hudAttemptsMax"),
      hudHints = el("hudHints"), hudHintsMax = el("hudHintsMax");

const hudTime = el("hudTime"), ring = el("ring"), timerPill = el("timerPill"), stressBar = el("stressBar");
const qMeta = el("qMeta"), qTitle = el("qTitle"), qDesc  = el("qDesc"), optionsEl = el("options");
const validateBtn = el("validateBtn"), clearBtn = el("clearBtn");
const keyBtn = el("keyBtn"), continueBtn = el("continueBtn");
const progressBar = el("progressBar");

const startOverlay = el("startOverlay"), startBtn = el("startBtn");
const overlay = el("overlay"), modalBox = el("modalBox"), badgeState = el("badgeState"), modalText = el("modalText");
const modalScore = el("modalScore"), modalStress = el("modalStress");
const retryBtn = el("retryBtn"), nextBtn = el("nextBtn"), okBtn = el("okBtn"), frame = el("frame");

const hintBtn = el("hintBtn"), hintOverlay = el("hintOverlay"), hintText = el("hintText"),
      hintOkBtn = el("hintOkBtn"), hintLeftText = el("hintLeftText");

const pauseBtn = el("pauseBtn"), pauseOverlay = el("pauseOverlay"), resumeBtn = el("resumeBtn");

/* ========= CONFIG (r√©f√©rence Interm√©diaire) ========= */
const SCENARIO = {
  id: 4,
  label: "Sc√©nario 4 ‚Äî Accident de la voie publique",
  profile: "Pompier",
  mission: "AVP multi-victimes",
  level: "Interm√©diaire"
};
const NEXT_GENIALLY_URL = "#";

const TIMER_SECONDS = 45;
const MAX_ATTEMPTS = 3;

const STRESS_RULES = { wrong: 10, timeout: 15, critical: 25 };

const HINT_MAX = 2;
const HINT_KEY = `hints_left_s${SCENARIO.id}`;

/* ========= Player ========= */
const role = "pompier";
const playerName = localStorage.getItem("playerName") || "Joueur";
const avatarFile = localStorage.getItem("avatar") || "medecin_f.png";
const roleLabelMap = { medecin:"M√©decin", infirmier:"Infirmier", pompier:"Pompier" };

hudName.textContent = playerName;
hudRole.textContent = "R√¥le: " + (roleLabelMap[role] || "‚Äî");
hudAvatar.src = "assets/avatars/" + avatarFile;
difficultyChip.textContent = "MODE: INTERM√âDIAIRE";

/* ========= State ========= */
let score = parseInt(localStorage.getItem("score") || "0", 10);
let stress = parseInt(localStorage.getItem("stress") || "0", 10);
if(isNaN(score)) score = 0;
if(isNaN(stress)) stress = 0;

let idx = 0;
let attemptsForCurrentQuestion = 3;
let locked = true;
let paused = false;

let timerId = null;
let timeLeft = TIMER_SECONDS;

let hintsLeft = parseInt(localStorage.getItem(HINT_KEY) || String(HINT_MAX), 10);
if(isNaN(hintsLeft)) hintsLeft = HINT_MAX;

/* ========= QUESTIONS (tes questions) ========= */
const questions = [
  {
    "type": "single",
    "title": "Arriv√©e sur l‚ÄôAVP (commandement)",
    "desc": "En tant que pompier, quelle est la premi√®re action structurante sur un AVP multi-victimes ?",
    "hint": "Pense ¬´ s√©curit√© ¬ª avant tout : √©valuer la sc√®ne, baliser, puis organiser.",
    "options": [
      {"text":"Commencer imm√©diatement la d√©sincarc√©ration sans baliser","kind":"wrong","fb":"‚ùå Risque de sur-accident : balisage et s√©curit√© d‚Äôabord."},
      {"text":"√âvaluer la sc√®ne, se mettre en s√©curit√©, √©tablir un point de commandement et demander des renforts adapt√©s","kind":"ok","fb":"‚úÖ Oui : size-up + s√©curit√© + commandement + renforts."},
      {"text":"Faire le constat avec les conducteurs","kind":"wrong","fb":"‚ùå Non prioritaire."},
      {"text":"D√©placer les v√©hicules pour lib√©rer la route","kind":"wrong","fb":"‚ùå Dangereux : risques incendie/rachis, pr√©server la sc√®ne."}
    ]
  },
  {
    "type": "multi",
    "title": "S√©curisation renforc√©e",
    "desc": "Coche les actions pertinentes pour s√©curiser un AVP (plusieurs) :",
    "hint": "S√©curit√© = balisage + r√©duire risques (√©nergie/feu) + zone d‚Äôexclusion.",
    "options": [
      {"text":"Balisage amont/aval + √©clairage si faible visibilit√©","correct":true},
      {"text":"Couper les contacts et si possible d√©brancher la batterie (risque incendie)","correct":true},
      {"text":"Se placer dos √† la circulation en restant sur la voie","correct":false},
      {"text":"√âtablir une zone d‚Äôexclusion (carburant, airbags, circulation)","correct":true}
    ],
    "okFb":"‚úÖ Balisage + r√©duction des risques + zone d‚Äôexclusion.",
    "badFb":"‚ùå Attendu : balisage/√©clairage + coupure √©nergie + zone d‚Äôexclusion."
  },
  {
    "type": "single",
    "title": "Danger imm√©diat (carburant / incendie)",
    "desc": "Tu observes une fuite de carburant proche d‚Äôun v√©hicule accident√©. Ta priorit√© :",
    "hint": "Risque incendie = zone d‚Äôexclusion + supprimer ignition + protection.",
    "options": [
      {"text":"Approcher et rassurer la victime en premier","kind":"wrong","fb":"‚ùå D‚Äôabord supprimer le danger et s√©curiser."},
      {"text":"Cr√©er une zone d‚Äôexclusion, supprimer les sources d‚Äôignition et demander extincteur/ligne de protection","kind":"ok","fb":"‚úÖ Oui : g√©rer le risque incendie avant d‚Äôapprocher."},
      {"text":"Ouvrir toutes les porti√®res pour ventiler","kind":"wrong","fb":"‚ùå Airbags/risques, pas prioritaire."},
      {"text":"Prendre des photos pour le rapport","kind":"wrong","fb":"‚ùå Inutile et dangereux."}
    ]
  },
  {
    "type": "image_single",
    "title": "Triage START ‚Äî choix imm√©diat",
    "desc": "Choisis l‚Äôimage qui correspond √† une victime en d√©tresse vitale (priorit√© IMMEDIATE).",
    "hint": "START : d√©tresse respiratoire / respiration anormale = IMMEDIATE.",
    "options": [
      {"label":"A","imgSrc":"assets/avp_q4_a.png","kind":"wrong","fb":"‚ùå Non.","caption":"Conscient / respiration normale"},
      {"label":"B","imgSrc":"assets/avp_q4_b.png","kind":"ok","fb":"‚úÖ B : d√©tresse respiratoire = IMMEDIATE.","caption":"Inconscient / respiration anormale"},
      {"label":"C","imgSrc":"assets/avp_q4_c.png","kind":"wrong","fb":"‚ùå Non.","caption":"Conscient / h√©morragie externe contr√¥lable"}
    ]
  },
  {
    "type": "single",
    "title": "H√©morragie massive",
    "desc": "Une victime pr√©sente une h√©morragie pulsatile au membre. Le geste le plus efficace imm√©diatement :",
    "hint": "H√©morragie massive : compression forte puis garrot si besoin.",
    "options": [
      {"text":"Mettre un simple pansement l√©ger","kind":"wrong","fb":"‚ùå Insuffisant sur h√©morragie massive."},
      {"text":"Compression directe forte puis garrot si l‚Äôh√©morragie persiste/si impossible √† contr√¥ler","kind":"ok","fb":"‚úÖ Oui : contr√¥ler le saignement rapidement."},
      {"text":"Sur√©lever le membre et attendre","kind":"wrong","fb":"‚ùå Pas assez rapide/efficace."},
      {"text":"Donner √† boire pour compenser","kind":"wrong","fb":"‚ùå Interdit."}
    ]
  },
  {
    "type": "drag_order",
    "title": "S√©quence op√©rationnelle (interm√©diaire)",
    "desc": "Glisse-d√©pose dans l‚Äôordre le plus logique :",
    "hint": "Toujours : s√©curit√© ‚Üí alerte/renforts ‚Üí triage ‚Üí gestes vitaux ‚Üí √©vacuation.",
    "items": [
      {"id":"s","text":"S√©curiser + baliser + EPI"},
      {"id":"a","text":"Alerter / demander renforts + r√©partition des r√¥les"},
      {"id":"t","text":"Triage rapide des victimes"},
      {"id":"g","text":"Gestes vitaux imm√©diats (h√©morragie/VA/O‚ÇÇ si dispo)"},
      {"id":"p","text":"Conditionner / pr√©parer √©vacuation + surveillance"}
    ],
    "expected":["s","a","t","g","p"],
    "okFb":"‚úÖ Bon encha√Ænement : s√©curit√© ‚Üí alerte ‚Üí triage ‚Üí gestes vitaux ‚Üí √©vacuation/surveillance.",
    "badFb":"‚ùå Revois les priorit√©s : s√©curit√© et alerte avant gestes et √©vacuation."
  },
  {
    "type": "cloze",
    "title": "Message d‚Äôalerte (pompiers)",
    "desc": "Compl√®te les 2 informations essentielles pour l‚Äôalerte :",
    "hint": "Alerte = lieu pr√©cis + nombre de victimes (au minimum).",
    "template": "Lieu : <b>{blank1}</b> ‚Ä¢ Nombre de victimes : <b>{blank2}</b>.",
    "blanks": [
      { "key": "blank1", "answer": "route" },
      { "key": "blank2", "answer": "3" }
    ],
    "okFb": "‚úÖ Message clair : lieu + nombre de victimes.",
    "badFb": "‚ùå Attendu : route / 3."
  },
  {
    "type": "tf",
    "title": "D√©placement victime",
    "desc": "On d√©place syst√©matiquement une victime d‚ÄôAVP pour la mettre sur le trottoir.",
    "hint": "Trauma : on √©vite de d√©placer sauf danger imm√©diat (rachis).",
    "tf": {
      "trueOpt": {"kind":"wrong","fb":"‚ùå Faux : sauf danger imm√©diat, risque rachis."},
      "falseOpt":{"kind":"ok","fb":"‚úÖ Vrai : immobilisation/√©valuation, d√©placement seulement si danger."},
      "correct": false
    }
  },
  {
    "type": "hotspot",
    "title": "Hotspot ‚Äî Priorit√© A (Airway)",
    "desc": "Clique la zone associ√©e √† la priorit√© A (protection voies a√©riennes/cervical).",
    "hint": "A = Airway + protection cervicale (t√™te/cou).",
    "imgSrc": "scenario_4_hotspot_q_9.png",
    "hotspots": [
      {"label":"cou/t√™te","x":25,"y":48,"w":12,"h":16,"kind":"ok","fb":"‚úÖ Oui : t√™te/cou = A + protection cervicale."},
      {"label":"jambe","x":52,"y":78,"w":12,"h":16,"kind":"wrong","fb":"‚ùå Ici, on vise la zone A : t√™te/cou."},
      {"label":"bras","x":52,"y":50,"w":12,"h":16,"kind":"wrong","fb":"‚ùå Ici, on vise la zone A : t√™te/cou."}
    ]
  },
  {
    "type": "image_single",
    "title": "D√©cision clinique imm√©diate",
    "desc": "Choisis la conduite la plus s√ªre :",
    "hint": "Bonne conduite = maintien axe + surveillance + alerte.",
    "options": [
      {"label":"A","imgSrc":"assets/avp_q4_a.png","kind":"wrong","fb":"‚ùå Non.","caption":"Maintien axe t√™te-cou-tronc SANS surveillance/alerte"},
      {"label":"B","imgSrc":"assets/avp_q4_b.png","kind":"wrong","fb":"‚ùå Non.","caption":"Maintien axe t√™te-cou-tronc MAIS mobilisation pr√©matur√©e"},
      {"label":"C","imgSrc":"assets/avp_q4_c.png","kind":"ok","fb":"‚úÖ C : maintien + surveillance + alerte.","caption":"Maintien axe t√™te-cou-tronc + surveillance + alerte"}
    ]
  },
  {
    "type": "multi",
    "title": "Suspicion de traumatisme cr√¢nien",
    "desc": "Coche les signes qui doivent te faire classer la victime comme prioritaire :",
    "hint": "Gravit√© = conscience alt√©r√©e + vomissements + respiration anormale.",
    "options": [
      {"text":"Alt√©ration de conscience / confusion","correct":true},
      {"text":"Vomissements r√©p√©t√©s","correct":true},
      {"text":"Plaie superficielle sans saignement","correct":false},
      {"text":"Respiration anormale","correct":true}
    ],
    "okFb":"‚úÖ Bons crit√®res de gravit√©.",
    "badFb":"‚ùå Attendu : alt√©ration conscience, vomissements r√©p√©t√©s, respiration anormale."
  },
  {
    "type": "single",
    "title": "Airbags",
    "desc": "Avant d‚Äôintervenir dans l‚Äôhabitacle, que faut-il anticiper ?",
    "hint": "Airbag non d√©clench√© = risque de d√©ploiement : zone de danger.",
    "options": [
      {"text":"Airbags non d√©clench√©s (risque de d√©ploiement)","kind":"ok","fb":"‚úÖ Oui : zone de danger + stabilisation."},
      {"text":"Que le klaxon se d√©clenche","kind":"wrong","fb":"‚ùå Non prioritaire."},
      {"text":"Que la radio soit allum√©e","kind":"wrong","fb":"‚ùå Non."},
      {"text":"Que la ceinture soit confortable","kind":"wrong","fb":"‚ùå Non."}
    ]
  },
  {
    "type": "tf",
    "title": "Triage START",
    "desc": "Une victime qui ne respire pas apr√®s lib√©ration des voies a√©riennes est class√©e ¬´ d√©c√©d√©e/expectative ¬ª en START.",
    "hint": "START : non-respirant apr√®s manoeuvre = noir.",
    "tf": {
      "trueOpt": {"kind":"ok","fb":"‚úÖ Oui : START = non-respirant apr√®s manoeuvre = noir."},
      "falseOpt":{"kind":"wrong","fb":"‚ùå Non : en START, c‚Äôest class√© noir."},
      "correct": true
    }
  },
  {
    "type": "multi",
    "title": "Transmission au SAMU",
    "desc": "Coche les infos essentielles √† transmettre :",
    "hint": "Transmission = m√©canisme + nb/triage + √©tat vital.",
    "options": [
      {"text":"M√©canisme + cin√©tique (vitesse, choc, √©jection)","correct":true},
      {"text":"Nombre de victimes + cat√©gories de triage","correct":true},
      {"text":"Marque des voitures","correct":false},
      {"text":"√âtat vital (conscience/respiration/h√©morragie)","correct":true}
    ],
    "okFb":"‚úÖ Transmission utile.",
    "badFb":"‚ùå Attendu : m√©canisme, nb/triage, √©tat vital."
  },
  {
    "type": "hotspot",
    "title": "Hotspot ‚Äî Zone √† prot√©ger (rachis)",
    "desc": "Clique la zone √† immobiliser en priorit√© :",
    "hint": "Trauma : priorit√© rachis/colonne vert√©brale.",
    "imgSrc": "scenario_4_hotspot_q_15.png",
    "hotspots": [
      {"label":"rachis","x":60,"y":54,"w":10,"h":35,"kind":"ok","fb":"‚úÖ Oui : rachis/colonne vert√©brale."},
      {"label":"genou","x":65,"y":90,"w":12,"h":12,"kind":"wrong","fb":"‚ùå Zone critique : rachis."},
      {"label":"√©paule","x":52,"y":40,"w":12,"h":12,"kind":"wrong","fb":"‚ùå Zone critique : rachis."}
    ]
  },
  {
    "type": "single",
    "title": "Immobilisation manuelle",
    "desc": "La meilleure action pendant la mise en place du collier/plan dur :",
    "hint": "Maintien manuel continu t√™te-cou (alignement).",
    "options": [
      {"text":"Maintenir t√™te-cou en alignement (maintien manuel)","kind":"ok","fb":"‚úÖ Oui : maintien manuel continu."},
      {"text":"Tirer sur les √©paules pour l‚Äôaligner","kind":"wrong","fb":"‚ùå Risque aggravation."},
      {"text":"Faire asseoir la victime","kind":"wrong","fb":"‚ùå Non."},
      {"text":"Rel√¢cher la t√™te pour pr√©parer le mat√©riel","kind":"wrong","fb":"‚ùå Non : maintien continu."}
    ]
  },
  {
    "type": "image_single",
    "title": "Pr√©vention hypothermie",
    "desc": "Choisis l‚Äôimage qui montre la meilleure conduite :",
    "hint": "Trauma : couvrir/isoler du sol froid = pr√©vention hypothermie.",
    "options": [
      {"label":"A","imgSrc":"assets/avp_q17_a.png","kind":"wrong","fb":"‚ùå Non.","caption":"Victime expos√©e / non isol√©e"},
      {"label":"B","imgSrc":"assets/avp_q17_b.png","kind":"ok","fb":"‚úÖ B : couvrir/isoler = bon geste.","caption":"Couvrir / isoler (pr√©venir hypothermie)"},
      {"label":"C","imgSrc":"assets/avp_q17_c.png","kind":"wrong","fb":"‚ùå Non.","caption":"Couverture incompl√®te / sol froid"}
    ]
  },
  {
    "type": "short",
    "title": "Num√©ro d‚Äôurgence",
    "desc": "Quel num√©ro appelles-tu pour les secours ? (1 valeur)",
    "hint": "En contexte m√©dical : SAMU = 15.",
    "answers": ["15"],
    "okFb": "‚úÖ Correct.",
    "badFb": "‚ùå Non"
  },
  {
    "type": "drag_order",
    "title": "Priorit√©s ABC (terrain)",
    "desc": "Remets dans l‚Äôordre les priorit√©s vitales :",
    "hint": "Toujours : A puis B puis C, puis surveillance.",
    "items": [
      {"id":"c","text":"Contr√¥le h√©morragies / circulation"},
      {"id":"a","text":"Voies a√©riennes + protection cervicale"},
      {"id":"b","text":"Respiration + O‚ÇÇ si dispo"},
      {"id":"d","text":"Surveillance + pr√©vention hypothermie"}
    ],
    "expected":["a","b","c","d"],
    "okFb":"‚úÖ A ‚Üí B ‚Üí C ‚Üí Surveillance.",
    "badFb":"‚ùå Ordre attendu : A puis B puis C puis surveillance."
  },
  {
    "type": "tf",
    "title": "Gestion du stress",
    "desc": "Sur AVP multi-victimes, tu peux d√©l√©guer (balisage, alerte, triage) pour gagner du temps et r√©duire le stress.",
    "hint": "Coordination + d√©l√©gation = meilleure efficacit√© et moins de stress.",
    "tf": {
      "trueOpt":{"kind":"ok","fb":"‚úÖ Vrai : d√©l√©gation et coordination am√©liorent la prise en charge."},
      "falseOpt":{"kind":"wrong","fb":"‚ùå Faux : travailler seul augmente les risques."},
      "correct": true
    }
  }
];

const TOTAL = questions.length;
hudQtotal.textContent = String(TOTAL);

/* ========= Score / Stress / UI ========= */
function setScore(v){
  score=v;
  localStorage.setItem("score", String(score));
  hudScore.textContent=String(score);
  modalScore.textContent=String(score);
}
function addScore(d){ setScore(score + d); }

function setStress(v){
  stress=clamp(v,0,100);
  localStorage.setItem("stress", String(stress));
  stressBar.style.width=stress+"%";
  modalStress.textContent=String(stress);
}
function addStress(d){ setStress(stress + d); }

function setAttemptsUI(){
  hudAttempts.textContent = String(attemptsForCurrentQuestion);
  hudAttemptsMax.textContent = String(MAX_ATTEMPTS);
}
function setHintsUI(){
  hudHints.textContent = String(hintsLeft);
  hudHintsMax.textContent = String(HINT_MAX);
  hintLeftText.textContent = String(hintsLeft);
  hintBtn.disabled = (locked || hintsLeft<=0 || hintUsedThisQuestion);
}

function setProgressUI(){
  const pct = clamp(Math.round((idx / TOTAL) * 100), 0, 100);
  progressBar.style.width = pct + "%";
}

setScore(score);
setStress(stress);
setAttemptsUI();

/* ========= Timer ========= */
function setRingProgress(){
  const p = clamp(Math.round((timeLeft / TIMER_SECONDS) * 100), 0, 100);
  ring.style.setProperty("--p", p + "%");
  timerPill.classList.remove("timerWarn","timerDanger");
  if(timeLeft <= 5) timerPill.classList.add("timerDanger");
  else if(timeLeft <= 10) timerPill.classList.add("timerWarn");
}
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }
function startTimer(){
  stopTimer();
  timeLeft = TIMER_SECONDS;
  hudTime.textContent = String(timeLeft);
  setRingProgress();
  timerId = setInterval(()=>{
    if(locked || paused) return;
    timeLeft--;
    hudTime.textContent = String(timeLeft);
    setRingProgress();
    if(timeLeft <= 0){
      stopTimer();
      sfxAlarmLong();
      addStress(STRESS_RULES.timeout);
      attemptsForCurrentQuestion++;
      setAttemptsUI();

      if(attemptsForCurrentQuestion > MAX_ATTEMPTS){
        missionFail("‚è±Ô∏è Temps √©coul√©. Mission √©chou√©e. Retour au d√©part‚Ä¶ (score remis √† z√©ro)");
      }else{
        showOverlay("warn", `‚è±Ô∏è Temps √©coul√©. (Tentative ${attemptsForCurrentQuestion}/${MAX_ATTEMPTS})`, {allowRetry:true, allowNext:false, missionFail:false});
      }
    }
  }, 1000);
}

/* ========= Selection state ========= */
let selectedSingle = null;
let multiSelected = new Set();
let inputValue = "";
let clozeValues = {};
let hintUsedThisQuestion = false;

function resetState(){
  selectedSingle=null;
  multiSelected.clear();
  inputValue="";
  clozeValues={};
  hintUsedThisQuestion=false;
  validateBtn.disabled=true;
  clearBtn.style.display="none";
  setHintsUI();
}

function mkOpt(text){
  const d = document.createElement("div");
  d.className="opt";
  d.textContent=text;
  return d;
}

/* ========= Render ========= */
function renderQuestion(i, resetAttempts=true){
  locked=false;
  paused=false;
  hideOverlay();
  hidePause();
  hideHint();

  if(resetAttempts){ attemptsForCurrentQuestion=1; setAttemptsUI(); }

  resetState();

  const q = questions[i];
  qMeta.textContent = SCENARIO.label + " ‚Ä¢ " + SCENARIO.level;
  qTitle.textContent = q.title || "‚Äî";
  qDesc.innerHTML = q.desc || "";
  optionsEl.innerHTML = "";

  hudQnum.textContent = String(i+1);
  setProgressUI();

  const type = q.type;

  if(type==="single"){
    q.options.forEach((opt, oi)=>{
      const d = mkOpt(opt.text);
      d.onclick=()=>{
        sfxClick();
        [...optionsEl.children].forEach(x=>x.classList.remove("sel"));
        d.classList.add("sel");
        selectedSingle=oi;
        validateBtn.disabled=false;
      };
      optionsEl.appendChild(d);
    });
  }

  if(type==="tf"){
    const opts=[{label:"Vrai",data:q.tf.trueOpt},{label:"Faux",data:q.tf.falseOpt}];
    opts.forEach((o, oi)=>{
      const d = mkOpt(o.label);
      d.onclick=()=>{
        sfxClick();
        [...optionsEl.children].forEach(x=>x.classList.remove("sel"));
        d.classList.add("sel");
        selectedSingle=oi;
        validateBtn.disabled=false;
      };
      optionsEl.appendChild(d);
    });
  }

  if(type==="multi"){
    clearBtn.style.display="inline-block";
    q.options.forEach((opt, oi)=>{
      const d=mkOpt(opt.text);
      d.onclick=()=>{
        sfxClick();
        if(multiSelected.has(oi)){ multiSelected.delete(oi); d.classList.remove("sel"); }
        else { multiSelected.add(oi); d.classList.add("sel"); }
        validateBtn.disabled = (multiSelected.size===0);
      };
      optionsEl.appendChild(d);
    });
  }

  if(type==="short"){
    clearBtn.style.display="inline-block";
    const box = document.createElement("div");
    box.className="opt"; box.style.cursor="default";
    box.innerHTML = `
      <div style="font-weight:950; margin-bottom:8px;">Ta r√©ponse</div>
      <input id="shortInput" class="form-control" type="text" placeholder="√âcris ici‚Ä¶"
        style="background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.18); color: rgba(255,255,255,.92);" />
      <div style="margin-top:8px; font-size:12px; color: rgba(255,255,255,.72);">Astuce : une valeur courte suffit.</div>
    `;
    optionsEl.appendChild(box);
    const inp = box.querySelector("#shortInput");
    inp.addEventListener("input", ()=>{
      inputValue = inp.value;
      validateBtn.disabled = (inp.value.trim().length===0);
    });
  }

  if(type==="image_single"){
    const grid = document.createElement("div");
    grid.className = "imgGrid";
    q.options.forEach((opt, oi)=>{
      const card = document.createElement("div");
      card.className = "imgCard";
      card.innerHTML = `
        <div class="imgHead">
          <div>Option ${opt.label}</div>
          <div class="imgTag">${opt.label}</div>
        </div>
        <img class="imgPic" src="${opt.imgSrc}" alt="Option ${opt.label}">
        <div class="imgCap">${opt.caption || ""}</div>
      `;
      card.onclick = ()=>{
        sfxClick();
        [...grid.querySelectorAll(".imgCard")].forEach(c=>c.classList.remove("sel"));
        card.classList.add("sel");
        selectedSingle = oi;
        validateBtn.disabled = false;
      };
      grid.appendChild(card);
    });
    optionsEl.appendChild(grid);
  }

  if(type==="hotspot"){
    clearBtn.style.display="inline-block";

    const msg = document.createElement("div");
    msg.className="pill";
    msg.style.marginBottom="10px";
    msg.innerHTML = "üéØ <b>Clique sur la zone correcte</b> sur l‚Äôimage, puis appuie sur <b>Valider</b>.";
    optionsEl.appendChild(msg);

    const wrap = document.createElement("div");
    wrap.style.position="relative";
    wrap.style.width="100%";
    wrap.style.maxWidth="760px";
    wrap.style.margin="0 auto";
    wrap.style.borderRadius="18px";
    wrap.style.overflow="hidden";
    wrap.style.border="1px solid rgba(255,255,255,.14)";
    wrap.style.background="rgba(0,0,0,.18)";
    wrap.innerHTML = `<img src="${q.imgSrc||""}" alt="hotspot" style="width:100%; height:240px; display:block; object-fit:cover;">`;
    optionsEl.appendChild(wrap);

    const zones = document.createElement("div");
    zones.style.position="absolute";
    zones.style.inset="0";
    zones.style.pointerEvents="auto";
    wrap.appendChild(zones);

    selectedSingle = null;
    validateBtn.disabled = true;

    (q.hotspots||[]).forEach((h, hi)=>{
      const z = document.createElement("button");
      z.type="button";
      z.className="hotspot-zone";
      z.style.left = h.x + "%";
      z.style.top  = h.y + "%";
      z.style.width = h.w + "%";
      z.style.height= h.h + "%";
      z.onclick=()=>{
        sfxClick();
        [...zones.querySelectorAll("button")].forEach(b=>b.classList.remove("sel"));
        z.classList.add("sel");
        selectedSingle = hi;
        validateBtn.disabled = false;
      };
      zones.appendChild(z);
    });
  }

  if(type==="cloze"){
    clearBtn.style.display="inline-block";
    const box = document.createElement("div");
    box.className="opt"; box.style.cursor="default";
    const html = q.template
      .replace("{blank1}", `<input data-k="blank1" class="form-control" style="display:inline-block; width:240px; margin:0 6px; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.18); color: rgba(255,255,255,.92);" placeholder="..." />`)
      .replace("{blank2}", `<input data-k="blank2" class="form-control" style="display:inline-block; width:260px; margin:0 6px; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.18); color: rgba(255,255,255,.92);" placeholder="..." />`);
    box.innerHTML = `<div style="line-height:1.8;">${html}</div>`;
    optionsEl.appendChild(box);
    const inputs = box.querySelectorAll("input[data-k]");
    inputs.forEach(inp=>{
      inp.addEventListener("input", ()=>{
        clozeValues[inp.dataset.k] = inp.value;
        const filled = q.blanks.every(b => (clozeValues[b.key]||"").trim().length>0);
        validateBtn.disabled = !filled;
      });
    });
  }

  if(type==="drag_order"){
    clearBtn.style.display="inline-block";

    // Shuffle items
    const items = (q.items||[]).slice();
    for(let k=items.length-1; k>0; k--){
      const j = Math.floor(Math.random()*(k+1));
      [items[k], items[j]] = [items[j], items[k]];
    }

    const box = document.createElement("div");
    box.className = "opt";
    box.style.cursor = "default";
    box.innerHTML = `
      <div style="font-weight:950; margin-bottom:8px;">üß© Glisse-d√©pose pour remettre dans l‚Äôordre</div>
      <div style="font-size:12px; color: rgba(255,255,255,.75); margin-bottom:10px;">(glisser)</div>
      <div id="dragList" style="display:flex; flex-direction:column; gap:10px;"></div>
    `;
    optionsEl.appendChild(box);
    const list = box.querySelector("#dragList");

    items.forEach((it)=>{
      const row = document.createElement("div");
      row.className = "opt";
      row.style.cursor = "grab";
      row.style.margin = "0";
      row.style.background = "linear-gradient(180deg, rgba(80,170,255,.18), rgba(80,170,255,.10))";
      row.style.borderColor = "rgba(255,255,255,.14)";
      row.draggable = true;
      row.dataset.id = it.id;
      row.textContent = it.text;

      row.addEventListener("dragstart", (e)=>{
        row.classList.add("sel");
        e.dataTransfer.setData("text/plain", row.dataset.id);
        e.dataTransfer.effectAllowed = "move";
      });
      row.addEventListener("dragend", ()=> row.classList.remove("sel"));

      row.addEventListener("dragover", (e)=>{
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      row.addEventListener("drop", (e)=>{
        e.preventDefault();
        const draggedId = e.dataTransfer.getData("text/plain");
        const draggedEl = list.querySelector(`[data-id="${draggedId}"]`);
        if(!draggedEl || draggedEl===row) return;

        const rect = row.getBoundingClientRect();
        const before = (e.clientY - rect.top) < (rect.height/2);
        list.insertBefore(draggedEl, before ? row : row.nextSibling);
        sfxClick();
        validateBtn.disabled = false;
      });

      list.appendChild(row);
    });

    validateBtn.disabled = false; // autoris√©
  }

  setHintsUI();
  startTimer();
}

clearBtn.onclick = ()=>{ sfxClick(); renderQuestion(idx, false); };

/* ========= Validation ========= */
validateBtn.onclick = ()=>{
  if(locked || paused) return;

  const q = questions[idx];
  const type = q.type;

  const needSelection = (msg)=>{
    sfxClick();
    showOverlay("warn", msg, {allowRetry:false, allowNext:false, missionFail:false});
    retryBtn.style.display="none";
    nextBtn.style.display="none";
    okBtn.style.display="inline-block";
    okBtn.textContent="OK";
    okBtn.onclick = ()=>{ hideOverlay(); locked=false; startTimer(); };
  };

  if(type==="single" || type==="tf" || type==="image_single" || type==="hotspot"){
    if(selectedSingle===null){ needSelection("Choisis une r√©ponse avant de valider."); return; }
  }
  if(type==="multi"){
    if(multiSelected.size===0){ needSelection("S√©lectionne au moins une proposition avant de valider."); return; }
  }
  if(type==="short"){
    if((inputValue||"").trim().length===0){ needSelection("√âcris une r√©ponse avant de valider."); return; }
  }
  if(type==="cloze"){
    const filled = q.blanks.every(b => ((clozeValues[b.key]||"").trim().length>0));
    if(!filled){ needSelection("Compl√®te tous les trous avant de valider."); return; }
  }

  stopTimer();
  locked=true;

  if(type==="drag_order"){
    const list = document.getElementById("dragList");
    const order = [...list.querySelectorAll("[draggable='true']")].map(x => x.dataset.id);
    const expected = q.expected || [];
    const ok = order.length === expected.length && expected.every((v,i)=> order[i] === v);

    if(ok){
      addScore(10);
      showOverlay("good", q.okFb || "‚úÖ Bon ordre.", {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå Ordre incorrect.");
    }
    return;
  }

  if(type==="single"){
    evaluateOption(q.options[selectedSingle]); return;
  }
  if(type==="tf"){
    const opt = (selectedSingle===0) ? q.tf.trueOpt : q.tf.falseOpt;
    evaluateOption(opt); return;
  }
  if(type==="multi"){
    const chosen=[...multiSelected].sort((a,b)=>a-b);
    const correctIdx=q.options.map((o,i)=>o.correct?i:null).filter(v=>v!==null);
    const ok = chosen.length===correctIdx.length && chosen.every((v,i)=>v===correctIdx[i]);
    if(ok){
      addScore(10);
      showOverlay("good", q.okFb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå Incorrect.");
    }
    return;
  }
  if(type==="short"){
    const norm=(inputValue||"").trim().toLowerCase();
    const accepted=(q.answers||[]).map(a=>String(a).trim().toLowerCase());
    const ok = accepted.includes(norm);
    if(ok){
      addScore(10);
      showOverlay("good", q.okFb || "‚úÖ Bonne r√©ponse.", {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå R√©ponse incorrecte.");
    }
    return;
  }
  if(type==="image_single"){
    evaluateOption(q.options[selectedSingle]); return;
  }
  if(type==="hotspot"){
    const h = (q.hotspots||[])[selectedSingle];
    if(!h){ locked=false; startTimer(); return; }
    if(h.kind==="ok"){
      addScore(h.pts ?? 10);
      showOverlay("good", h.fb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else if(h.kind==="critical"){
      addStress(STRESS_RULES.critical);
      addScore(h.pts ?? -10);
      sfxCritical(); motion("critical");
      failedAttempt(h.fb || "üö® Erreur critique.");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(h.fb || "‚ùå Incorrect.");
    }
    return;
  }
  if(type==="cloze"){
    const norm = (s)=>String(s||"").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ");
    const ok = q.blanks.every(b => norm(clozeValues[b.key]) === norm(b.answer));
    if(ok){
      addScore(10);
      showOverlay("good", q.okFb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
      sfxCorrect(); motion("good");
    }else{
      addStress(STRESS_RULES.wrong);
      sfxWrong(); motion("wrong");
      failedAttempt(q.badFb || "‚ùå Texte incorrect.");
    }
    return;
  }
};

function evaluateOption(opt){
  if(opt.kind==="ok"){
    addScore(opt.pts ?? 10);
    showOverlay("good", opt.fb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
    sfxCorrect(); motion("good"); return;
  }
  if(opt.kind==="critical"){
    addStress(STRESS_RULES.critical);
    addScore(opt.pts ?? -10);
    sfxCritical(); motion("critical");
    failedAttempt(opt.fb || "üö® Erreur critique."); return;
  }
  if(opt.kind==="partial"){
    addStress(STRESS_RULES.wrong);
    addScore(opt.pts ?? 3);
    sfxWrong(); motion("wrong");
    failedAttempt(opt.fb || "üü° Partiel."); return;
  }
  addStress(STRESS_RULES.wrong);
  sfxWrong(); motion("wrong");
  failedAttempt(opt.fb || "‚ùå Incorrect.");
}

function failedAttempt(baseMsg){
  attemptsForCurrentQuestion++;
  setAttemptsUI();

  if(attemptsForCurrentQuestion > MAX_ATTEMPTS){
    sfxAlarmLong();
    missionFail("‚ùå Tentatives √©puis√©es. Mission √©chou√©e. Retour au d√©part‚Ä¶ (score remis √† z√©ro)");
    return;
  }
  showOverlay("warn", `${baseMsg} (Tentative ${attemptsForCurrentQuestion}/${MAX_ATTEMPTS})`, {allowRetry:true, allowNext:false, missionFail:false});
}

function showOverlay(kind, text, {allowRetry, allowNext, missionFail}){
  badgeState.className="badgeState";
  if(kind==="good"){ badgeState.classList.add("bGood"); badgeState.textContent="‚úÖ Bonne r√©ponse"; }
  if(kind==="warn"){ badgeState.classList.add("bWarn"); badgeState.textContent="‚ö†Ô∏è √Ä corriger"; }
  if(kind==="bad") { badgeState.classList.add("bBad");  badgeState.textContent="üö® Mission √©chou√©e"; }

  modalText.textContent = text;
  overlay.style.display="flex";

  retryBtn.style.display = allowRetry ? "inline-block" : "none";
  nextBtn.style.display  = allowNext  ? "inline-block" : "none";
  okBtn.style.display="none"; okBtn.onclick=null;

  retryBtn.onclick = ()=>{ hideOverlay(); locked=false; startTimer(); };
  nextBtn.onclick  = ()=>{ hideOverlay(); idx++; if(idx < TOTAL) renderQuestion(idx,true); else endScenario(); };

  if(missionFail){
    retryBtn.style.display="none"; nextBtn.style.display="none";
    okBtn.style.display="inline-block";
    okBtn.textContent="OK";
    okBtn.onclick = ()=>{ hideOverlay(); resetMission(true); };
  }
}
function hideOverlay(){ overlay.style.display="none"; }

function missionFail(message){
  stopTimer();
  showOverlay("bad", message, {allowRetry:false, allowNext:false, missionFail:true});
  motion("critical");
}

function resetMission(showStart=true){
  stopTimer();
  idx=0;
  attemptsForCurrentQuestion=1;
  setAttemptsUI();
  setScore(0);
  setStress(0);

  hintsLeft = HINT_MAX;
  localStorage.setItem(HINT_KEY, String(hintsLeft));
  setHintsUI();

  locked=true;
  paused=false;
  hidePause();
  hideHint();

  progressBar.style.width = "0%";
  if(showStart) startOverlay.style.display="flex";
}

/* ========= Pause ========= */
function showPause(){
  pauseOverlay.style.display="flex";
}
function hidePause(){
  pauseOverlay.style.display="none";
}
pauseBtn.onclick = ()=>{
  if(locked) return;
  sfxClick();
  paused = true;
  showPause();
};
resumeBtn.onclick = ()=>{
  sfxClick();
  paused = false;
  hidePause();
};

/* ========= Hints (2 total sc√©nario, 1 par question) ========= */
function showHint(text){
  hintText.innerHTML = text;
  hintLeftText.textContent = String(hintsLeft);
  hintOverlay.style.display="flex";
}
function hideHint(){
  hintOverlay.style.display="none";
}
hintBtn.onclick = ()=>{
  if(locked || paused) return;
  if(hintsLeft<=0 || hintUsedThisQuestion) return;

  sfxClick();
  paused = true; // comme r√©f√©rence : indice = pause
  const q = questions[idx];
  const msg = q.hint ? `üí° ${escapeHtml(q.hint)}` : "üí° Concentre-toi sur la s√©curit√© et les priorit√©s vitales.";
  hintsLeft--;
  hintUsedThisQuestion = true;
  localStorage.setItem(HINT_KEY, String(hintsLeft));
  setHintsUI();
  showHint(msg);
};
hintOkBtn.onclick = ()=>{
  sfxClick();
  hideHint();
  paused = false;
  setHintsUI();
};

/* ========= Corrig√© ========= */
function buildAnswerKey(){
  const rows = questions.map((q, i)=>{
    let ans = "";
    if(q.type==="single" || q.type==="image_single"){
      const oi = (q.options||[]).findIndex(o=>o.kind==="ok");
      if(q.type==="image_single"){
        ans = oi>=0 ? `${q.options[oi].label} ‚Äî ${q.options[oi].caption || ""}` : "‚Äî";
      }else{
        ans = oi>=0 ? (q.options[oi].text || ("Option "+q.options[oi].label)) : "‚Äî";
      }
    }else if(q.type==="tf"){
      ans = (q.tf.trueOpt.kind==="ok") ? "Vrai" : "Faux";
    }else if(q.type==="multi"){
      const a = (q.options||[]).map(o=>o.correct?o.text:null).filter(Boolean);
      ans = a.join(" ; ");
    }else if(q.type==="short"){
      ans = (q.answers||[]).join(" / ");
    }else if(q.type==="cloze"){
      ans = (q.blanks||[]).map(b=>b.answer).join(" | ");
    }else if(q.type==="hotspot"){
      const okHs = (q.hotspots||[]).find(h=>h.kind==="ok");
      ans = okHs ? okHs.label : "‚Äî";
    }else if(q.type==="drag_order"){
      ans = (q.expected||[]).join(" ‚Üí ");
    }else{
      ans = "‚Äî";
    }
    return `<tr>
      <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); width:52px; color: rgba(255,255,255,.75);">Q${i+1}</td>
      <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); font-weight:900;">${escapeHtml(q.title||"")}</td>
      <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); color: rgba(255,255,255,.86);">${escapeHtml(ans)}</td>
    </tr>`;
  }).join("");

  return `
    <div class="opt" style="cursor:default;">
      <div style="font-weight:950; font-size:16px; margin-bottom:10px;">üìò Corrig√© (bonnes r√©ponses)</div>
      <div style="overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.12);">
        <table style="width:100%; border-collapse:collapse; min-width:680px;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">#</th>
              <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">Question</th>
              <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">Bonne r√©ponse</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>
  `;
}

/* ========= End ========= */
function endScenario(){
  stopTimer(); hideOverlay();
  locked=true;
  paused=false;

  progressBar.style.width = "100%";

  qMeta.textContent = "Fin ‚Äî Badge obtenu";
  qTitle.textContent = "üéâ F√©licitations !";
  sfxVictory();

  qDesc.innerHTML = `
    <div style="margin-top:6px; color: rgba(255,255,255,.86);">
      <div style="font-weight:950; font-size:16px;">üèÖ Badge ‚Äî AVP (Pompier Interm√©diaire)</div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">‚≠ê Score : <b>${score}</b></span>
        <span class="pill">üò∞ Stress : <b>${stress}%</b></span>
      </div>
      <div style="margin-top:10px; color: rgba(255,255,255,.78);">
        Tu peux afficher le <b>Corrig√©</b> ou <b>Continuer</b>.
      </div>
    </div>
  `;

  optionsEl.innerHTML = `
    <div class="opt" style="cursor:default; text-align:center;">
      <div style="font-size:52px;">üèÖ</div>
      <div style="font-weight:950; margin-top:6px;">Badge d√©bloqu√©</div>
      <div style="color: rgba(255,255,255,.72); font-size:13px; margin-top:4px;">AVP ‚Äî Interm√©diaire</div>
    </div>
    <div id="answerKeyWrap"></div>
  `;

  keyBtn.disabled = false;
  continueBtn.style.display = "inline-block";
  validateBtn.disabled = true;
  clearBtn.style.display = "none";
  hintBtn.disabled = true;
  pauseBtn.disabled = true;

  keyBtn.onclick = ()=>{
    sfxClick();
    const wrap = document.getElementById("answerKeyWrap");
    wrap.innerHTML = wrap.innerHTML ? "" : buildAnswerKey();
    // scroll options to show it
    optionsEl.scrollTop = optionsEl.scrollHeight;
  };

  continueBtn.onclick = ()=>{
    sfxClick();
    window.location.href = NEXT_GENIALLY_URL;
  };
}

/* ========= Motion ========= */
function motion(type){
  frame.classList.remove("shake","pulseGood","flashBad");
  modalBox.classList.remove("shake","pulseGood","flashBad");
  if(type==="good"){ frame.classList.add("pulseGood"); }
  else if(type==="wrong"){ modalBox.classList.add("shake"); }
  else if(type==="critical"){ modalBox.classList.add("shake"); frame.classList.add("flashBad"); }
}

/* ========= Start ========= */
startBtn.addEventListener("click", ()=>{
  ensureAudio(); sfxClick();

  // ‚úÖ Reset au d√©marrage (r√©f√©rence)
  localStorage.setItem("stress", "0");
  localStorage.setItem("score", "0");
  stress = 0; score = 0;
  setStress(0); setScore(0);

  hintsLeft = HINT_MAX;
  localStorage.setItem(HINT_KEY, String(hintsLeft));
  setHintsUI();

  startOverlay.style.display="none";
  idx=0; attemptsForCurrentQuestion=1; setAttemptsUI();
  keyBtn.disabled = true;
  continueBtn.style.display = "none";
  hintBtn.disabled = false;
  pauseBtn.disabled = false;

  renderQuestion(0, true);
});

(function init(){
  locked=true;
  qMeta.textContent = SCENARIO.label;
  qTitle.textContent="Pr√©pare-toi‚Ä¶";
  qDesc.innerHTML=`Tu as <b>${TIMER_SECONDS} secondes</b> par question. Clique sur <b>D√âMARRER</b>.`;
  optionsEl.innerHTML="";
  hudQnum.textContent="1";
  hudTime.textContent=String(TIMER_SECONDS);
  ring.style.setProperty("--p","100%");
  setRingProgress();

  // init hints
  setHintsUI();

  // init progress
  progressBar.style.width = "0%";
})();
</script>

<script src="badge-manager.js"></script>
</body>
</html>
