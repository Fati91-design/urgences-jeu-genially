<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sc√©nario 3 ‚Äî Chute du 2e √©tage ‚Äî Interm√©diaire ‚Äî Pompier</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --glass: rgba(25,27,31,.72);
      --glass2: rgba(15,17,20,.55);
      --text: rgba(255,255,255,.93);
      --muted: rgba(255,255,255,.70);

      --gold: rgba(255,200,80,1);
      --red: rgba(255,70,70,1);
      --green: rgba(45,200,120,1);
      --blue: rgba(80,170,255,1);
      --ember: rgba(255,150,70,1);
      --ember2: rgba(255,120,50,1);
    }

    *{ box-sizing:border-box; }

    /* ‚úÖ Genially anti-scroll */
    html,body{
      height:100%;
      margin:0;
      background: transparent;
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden;
    }

    /* ‚úÖ R√©f√©rence: stage 100vh + wrap min(1120px) + hauteur fixe */
    .stage{
      height:100vh;
      padding:10px;
      overflow:hidden;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .wrap{
      width:min(1120px,100%);
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }

    /* ===== TopTabs (r√©f√©rence) ===== */
    .topTabs{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .levelTab{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: var(--glass);
      border:1px solid rgba(255,200,150,.22);
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 55px rgba(0,0,0,.42);
    }
    .levelDot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      box-shadow:0 0 0 4px rgba(255,150,70,.16);
      flex:0 0 auto;
    }
    #levelTabText{
      font-weight:950;
      letter-spacing:.25px;
      font-size:12px;
      color: rgba(255,255,255,.88);
      white-space:nowrap;
    }
    .progressShell{
      flex:1 1 220px;
      min-width:220px;
      height:9px;
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
    }
    .progressBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(80,170,255,1), rgba(255,150,70,1));
      transition: width .25s ease;
    }
    .miniHint{
      padding:10px 12px;
      border-radius:999px;
      background: var(--glass);
      border:1px solid rgba(255,200,150,.22);
      backdrop-filter: blur(12px);
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
      box-shadow: 0 16px 55px rgba(0,0,0,.42);
      color: rgba(255,255,255,.88);
    }

    /* ===== HUD (r√©f√©rence) ===== */
    .hud{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .hudbox{
      background: var(--glass);
      border:1px solid rgba(255,200,150,.22);
      border-radius:18px;
      padding:12px 14px;
      min-height:90px;
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 65px rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .hudbox::after{
      content:"";
      position:absolute; inset:-2px;
      pointer-events:none;
      background:
        radial-gradient(520px 220px at 15% 0%, rgba(255,150,70,.18), transparent 60%),
        radial-gradient(520px 220px at 85% 120%, rgba(80,170,255,.10), transparent 60%);
      opacity:.9;
    }

    .profile{ display:flex; align-items:center; gap:12px; min-width:0; position:relative; z-index:2; }
    .avatarFrame{
      width:72px; height:72px; border-radius:20px; padding:4px;
      background: linear-gradient(180deg, rgba(255,150,70,.36), rgba(80,170,255,.14));
      box-shadow: 0 18px 42px rgba(0,0,0,.45);
      flex:0 0 auto;
    }
    .avatar{
      width:100%; height:100%;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      object-fit:cover;
      object-position: 50% 6%;
      transform: scale(1.25);
      transform-origin: 50% 12%;
      background: rgba(255,255,255,.06);
    }
    .ptext{ min-width:0; }
    .pname{ font-weight:950; font-size:18px; line-height:1.05; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-shadow:0 14px 30px rgba(0,0,0,.55); }
    .prole{ margin-top:4px; font-weight:850; font-size:12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chip{
      background: rgba(255,150,70,.14);
      border:1px solid rgba(255,150,70,.20);
      border-radius:999px;
      padding:9px 12px;
      font-size:12px;
      font-weight:950;
      white-space:nowrap;
      position:relative;
      z-index:2;
    }

    .stats{ display:flex; align-items:center; justify-content:flex-end; gap:10px; flex-wrap:wrap; position:relative; z-index:2; }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-weight:950;
      font-size:13px;
      white-space:nowrap;
    }
    .timerPill{ padding:8px 10px; gap:10px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18); }
    .ring{
      width:34px; height:34px; border-radius:999px;
      background: conic-gradient(var(--gold) var(--p,0%), rgba(255,255,255,.14) 0);
      display:grid; place-items:center;
      box-shadow: 0 0 0 5px rgba(255,200,80,.14), 0 0 28px rgba(255,200,80,.10);
      transition: box-shadow .2s ease;
    }
    .ringInner{
      width:24px; height:24px; border-radius:999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      color: rgba(255,255,255,.9);
      font-size:12px; font-weight:950;
    }
    .timeText{ display:flex; align-items:center; gap:8px; }
    .timeText .label{ font-size:12px; font-weight:900; color: rgba(255,255,255,.75); }
    .timeText .sec{ font-size:15px; font-weight:950; }

    .timerWarn .ring{
      box-shadow: 0 0 0 5px rgba(255,200,80,.18), 0 0 32px rgba(255,200,80,.14);
    }
    .timerDanger .ring{
      background: conic-gradient(var(--red) var(--p,0%), rgba(255,255,255,.14) 0);
      box-shadow: 0 0 0 5px rgba(255,70,70,.20), 0 0 40px rgba(255,70,70,.18);
    }

    .stressWrap{
      width:200px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .stressBar{
      height:100%; width:0%;
      background: linear-gradient(90deg, rgba(45,200,120,.95), rgba(255,200,80,.95), rgba(255,70,70,.95));
      transition: width .25s ease;
    }

    .pillBtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.90);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 950;
      font-size:13px;
      letter-spacing:.2px;
    }
    .pillBtn:disabled{ opacity:.45; cursor:not-allowed; }

    /* ===== Frame (r√©f√©rence) : hauteur fixe + options scroll + actions coll√©es en bas ===== */
    .frame{
      background: var(--glass2);
      border:1px solid rgba(255,200,150,.22);
      border-radius:18px;
      padding:16px;
      position:relative;
      overflow:hidden;
      box-shadow: 0 18px 70px rgba(0,0,0,.50);
      backdrop-filter: blur(12px);

      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .frame::after{
      content:"";
      position:absolute; inset:-2px; pointer-events:none;
      background:
        radial-gradient(800px 260px at 55% 0%, rgba(255,150,70,.16), transparent 60%),
        radial-gradient(760px 260px at 40% 120%, rgba(80,170,255,.10), transparent 60%);
      opacity:.9;
    }

    .qmeta{ position:relative; z-index:2; color: rgba(255,255,255,.70); font-size:12px; font-weight:950; letter-spacing:.35px; text-transform:uppercase; }
    .qtitle{ position:relative; z-index:2; margin-top:2px; font-weight:950; font-size: clamp(18px, 2.2vw, 26px); line-height:1.2; text-shadow:0 14px 30px rgba(0,0,0,.55); }
    .qdesc{ position:relative; z-index:2; margin-top:6px; color: rgba(255,255,255,.82); font-size:14px; line-height:1.5; max-width:980px; }

    /* ‚úÖ conteneur des questions FIXE (scroll interne) */
    .options{
      position:relative;
      z-index:2;
      display:flex;
      flex-direction:column;
      gap:12px;

      overflow:auto;
      padding-right:6px;
      min-height:0;
      flex:1;
    }

    .options::-webkit-scrollbar{ width:10px; }
    .options::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.25);
    }
    .options::-webkit-scrollbar-track{ background: rgba(0,0,0,.10); border-radius:999px; }

    .opt{
      border-radius:14px;
      padding:13px 14px;
      font-weight:950;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, filter .12s ease, background .12s ease;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(80,170,255,.22), rgba(80,170,255,.14));
      box-shadow: 0 10px 28px rgba(0,0,0,.20);
    }
    .opt:hover{ transform: translateY(-1px); filter: brightness(1.07); background: linear-gradient(180deg, rgba(255,150,70,.22), rgba(80,170,255,.10)); }
    .opt:active{ transform: translateY(0px); filter: brightness(.98); }
    .opt.sel{
      background: linear-gradient(180deg, rgba(255,150,70,.30), rgba(255,120,50,.18));
      border-color: rgba(255,150,70,.30);
      box-shadow: 0 0 0 3px rgba(255,150,70,.10), 0 16px 34px rgba(0,0,0,.28);
    }

    /* ‚úÖ Boutons coll√©s en bas (r√©f√©rence) */
    .qActions{
      position:sticky;
      bottom:0;
      z-index:3;
      padding-top:10px;

    }
    .actionsRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .actionsLeft, .actionsRight{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btnNeo{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.90);
      border-radius:12px;
      padding:10px 12px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .btnPrimary{
      border:none;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      color: rgba(10,12,18,.96);
      border-radius:12px;
      padding:10px 14px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .btnPrimary:disabled{
      opacity:.45;
      filter: grayscale(.2);
      cursor:not-allowed;
    }

    /* ===== Overlays (r√©f√©rence) ===== */
    .overlay{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      z-index:50;
      background: rgba(0,0,0,.48);
      backdrop-filter: blur(8px);
    }
    .modalBox{
      width:min(760px,92%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(8,10,14,.82);
      box-shadow: 0 26px 90px rgba(0,0,0,.62);
      overflow:hidden;
      position:relative;
    }
    .modalTop{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .badgeState{
      font-weight:950;
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .bGood{ border-color: rgba(45,200,120,.30); background: rgba(45,200,120,.12); }
    .bWarn{ border-color: rgba(255,200,80,.30); background: rgba(255,200,80,.12); }
    .bBad { border-color: rgba(255,70,70,.35); background: rgba(255,70,70,.12); }

    .modalBody{ padding:16px; color: rgba(255,255,255,.92); line-height:1.5; font-size:14px; }
    .modalActions{
      padding:14px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
    }

    /* Key overlay */
    .keyBox{
      width:min(980px,94%);
      max-height:86vh;
      overflow:auto;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(8,10,14,.86);
      box-shadow: 0 26px 90px rgba(0,0,0,.62);
    }
    .keyTop{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position:sticky; top:0;
      background: rgba(8,10,14,.92);
      backdrop-filter: blur(8px);
      z-index:2;
    }
    .keyTitle{ font-weight:950; }
    .keyClose{
      border:none;
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:8px 10px;
      font-weight:950;
    }
    .keyBody{ padding:14px; }

    /* Start */
    .startTitle{ font-weight:950; font-size:22px; margin-bottom:6px; }
    .startText{ color: rgba(255,255,255,.82); font-size:14px; line-height:1.45; }
    .startBtn{
      border:none; border-radius:14px; padding:12px 16px;
      font-weight:950; letter-spacing:.3px;
      background: linear-gradient(180deg, rgba(255,176,90,1), rgba(255,120,50,1));
      color: rgba(10,12,18,.96);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
    }

    /* Hotspot */
    @keyframes hsPulse {
      0% { box-shadow: 0 0 0 0 rgba(255,255,255,.25); border-color: rgba(255,255,255,.55); }
      70% { box-shadow: 0 0 0 14px rgba(255,255,255,0); border-color: rgba(255,255,255,.85); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); border-color: rgba(255,255,255,.55); }
    }
    .hotspotWrap{
      position:relative;
      width:100%;
      max-width:640px;
      margin:0 auto;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
    }
    .hotspotWrap img{ width:100%; height:240px; display:block; }
    .hotspot-zone{
      position:absolute;
      background: transparent !important;
      border: 2px solid rgba(255,255,255,.65);
      border-radius: 16px;
      cursor:pointer;
      animation: hsPulse 1.35s infinite;
      padding:0; margin:0;
    }
    .hotspot-zone.sel{
      border-color: rgba(34,197,94,.95);
      box-shadow: 0 0 0 6px rgba(34,197,94,.20);
      animation:none;
    }

    /* Image cards */
    .imgGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:16px;
      margin-top:12px;
    }
    @media (max-width: 900px){
      .imgGrid{ grid-template-columns: 1fr; }
    }
    .imgCard{
      border-radius:18px;
      overflow:hidden;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      cursor:pointer;
      transition:.15s ease;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
    }
    .imgCard:hover{ transform:translateY(-3px); filter:brightness(1.05); }
    .imgCard.sel{
      outline:3px solid rgba(255,165,0,.4);
      box-shadow:0 0 0 4px rgba(255,165,0,.25), 0 20px 40px rgba(0,0,0,.35);
    }
    .imgHead{
      padding:12px 16px;
      font-weight:900;
      display:flex;
      justify-content:space-between;
      background:linear-gradient(180deg, rgba(120,180,255,.25), rgba(120,180,255,.10));
    }
    .imgTag{
      width:36px;
      height:36px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      background:rgba(0,0,0,.25);
    }
    .imgPic{ width:100%; height:220px; object-fit:cover; display:block; }
    .imgCap{ padding:14px; text-align:center; font-weight:800; }

    /* animations */
    .shake{ animation: shake .24s linear 1; }
    @keyframes shake{
      0% { transform: translateX(0px); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
      100%{ transform: translateX(0px); }
    }
    .pulseGood{ animation: pulseGood .32s ease 1; }
    @keyframes pulseGood{
      from{ box-shadow: 0 0 0 0 rgba(45,200,120,.0); }
      50%{ box-shadow: 0 0 0 7px rgba(45,200,120,.18); }
      to{ box-shadow: 0 0 0 0 rgba(45,200,120,.0); }
    }
    .flashBad{ animation: flashBad .30s ease 1; }
    @keyframes flashBad{
      from{ box-shadow: 0 0 0 0 rgba(255,70,70,.0); }
      50%{ box-shadow: 0 0 0 7px rgba(255,70,70,.22); }
      to{ box-shadow: 0 0 0 0 rgba(255,70,70,.0); }
    }

    @media (max-width: 860px){
      .hud{ grid-template-columns: 1fr; }
      .progressShell{ min-width:100%; }
      .stressWrap{ width:170px; }
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="wrap">

      <!-- Top Tabs -->
      <div class="topTabs">
        <div class="levelTab">
          <div class="levelDot"></div>
          <div id="levelTabText">SC√âNARIO 3 ‚Ä¢ INTERM√âDIAIRE</div>
        </div>
        <div class="progressShell" aria-label="Progression">
          <div class="progressBar" id="progressBar"></div>
        </div>
        <div class="miniHint" id="miniHint">45s ‚Ä¢ 3 tentatives ‚Ä¢ 2 indices</div>
      </div>

      <!-- HUD -->
      <div class="hud">
        <div class="hudbox">
          <div class="profile">
            <div class="avatarFrame">
              <img class="avatar" id="hudAvatar" alt="Avatar">
            </div>
            <div class="ptext">
              <div class="pname" id="hudName">Dr. Joueur</div>
              <div class="prole" id="hudRole">R√¥le: ‚Äî</div>
            </div>
          </div>
          <div class="chip" id="difficultyChip">MODE: INTERM√âDIAIRE</div>
        </div>

        <div class="hudbox">
          <div class="stats">
            <div class="pill">‚≠ê <span id="hudScore">0</span></div>
            <div class="pill">Q <span id="hudQnum">1</span>/<span id="hudQtotal">0</span></div>
            <div class="pill">üéØ Tentatives <span id="hudAttempts">0</span>/3</div>
            <div class="pill">üí° <span id="hudHints">2</span>/2</div>


            <div class="stressWrap" title="Stress">
              <div class="stressBar" id="stressBar"></div>
            </div>

            <button class="pillBtn" id="hintBtn" type="button">Indice</button>
            <button class="pillBtn" id="pauseBtn" type="button">Pause</button>
            <div class="pill timerPill" id="timerPill">
              <div class="ring" id="ring"><div class="ringInner">‚è±</div></div>
              <div class="timeText">
                <div class="label">Temps</div>
                <div class="sec"><span id="hudTime">45</span>s</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Frame -->
      <div class="frame" id="frame">
        <div class="qmeta" id="qMeta">Sc√©nario 3 ‚Äî Chute du 2e √©tage</div>
        <div class="qtitle" id="qTitle">‚Ä¶</div>
        <div class="qdesc" id="qDesc">‚Ä¶</div>

        <div class="options" id="options"></div>

        <!-- ‚úÖ Boutons (fix√©s en bas) : Corrig√© + Continuer √† gauche, Valider + Effacer √† droite -->
        <div class="qActions">
          <div class="actionsRow">
            <div class="actionsLeft">
              <button class="btnNeo" id="showKeyBtn" type="button" disabled>üìò Corrig√©</button>
              <button class="btnPrimary" id="continueBtn" type="button" style="display:none;">‚úÖ Continuer</button>
            </div>
            <div class="actionsRight">
              <button class="btnPrimary" id="validateBtn" type="button" disabled>Valider</button>
              <button class="btnNeo" id="clearBtn" type="button" style="display:none;">Effacer</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- START overlay -->
  <div class="overlay" id="startOverlay" style="display:flex;">
    <div class="modalBox">
      <div class="modalTop">
        <div class="badgeState bWarn">üéÆ Pr√™t ?</div>
        <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
          Mission ‚Ä¢ Chute du deuxi√®me √©tage
        </div>
      </div>
      <div class="modalBody">
        <div class="startTitle">Tu as une mission.</div>
        <div class="startText">
          Tu vas intervenir en situation d‚Äôurgence.
          <br><br>
          <b>Mode Interm√©diaire :</b> 45s/question ‚Ä¢ <b>3 tentatives</b> au total ‚Ä¢ <b>2 indices</b> au total (1 indice max par question).
          <br><br>
          <b>Si tu rates 2 fois (mauvaise r√©ponse OU temps √©coul√©), la mission red√©marre (score = 0).</b>
        </div>
      </div>
      <div class="modalActions">
        <button class="startBtn" id="startBtn">D√âMARRER</button>
      </div>
    </div>
  </div>

  <!-- Feedback overlay -->
  <div class="overlay" id="feedbackOverlay">
    <div class="modalBox" id="modalBox">
      <div class="modalTop">
        <div class="badgeState" id="badgeState">‚Äî</div>
        <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
          Score: <span id="modalScore">0</span> ‚Ä¢ Stress: <span id="modalStress">0</span>%
        </div>
      </div>
      <div class="modalBody" id="modalText">‚Ä¶</div>
      <div class="modalActions">
        <button class="btnNeo" id="retryBtn">R√©essayer</button>
        <button class="btnPrimary" id="nextBtn">Suivant</button>
        <button class="btnPrimary" id="okBtn" style="display:none;">OK</button>
      </div>
    </div>
  </div>

  <!-- Hint overlay -->
  <div class="overlay" id="hintOverlay">
    <div class="modalBox">
      <div class="modalTop">
        <div class="badgeState bWarn">üí° Indice</div>
        <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
          Indices restants : <span id="hintLeftLabel">0</span>
        </div>
      </div>
      <div class="modalBody" id="hintText">‚Äî</div>
      <div class="modalActions">
        <button class="btnPrimary" id="hintOkBtn">Reprendre</button>
      </div>
    </div>
  </div>

  <!-- Pause overlay -->
  <div class="overlay" id="pauseOverlay">
    <div class="modalBox">
      <div class="modalTop">
        <div class="badgeState bWarn">‚è∏ Pause</div>
        <div style="color: rgba(255,255,255,.75); font-size:12px; font-weight:950;">
          Timer en pause
        </div>
      </div>
      <div class="modalBody">
        Respire. Observe. Puis reprends la mission.
      </div>
      <div class="modalActions">
        <button class="btnPrimary" id="resumeBtn">Reprendre</button>
      </div>
    </div>
  </div>

  <!-- Key overlay -->
  <div class="overlay" id="keyOverlay">
    <div class="keyBox">
      <div class="keyTop">
        <div class="keyTitle">üìò Corrig√© (bonnes r√©ponses)</div>
        <button class="keyClose" id="keyCloseBtn" type="button">‚úñ</button>
      </div>
      <div class="keyBody" id="answerKeyWrap"></div>
    </div>
  </div>

<script>
/* =========================================================
   ‚úÖ R√âF√âRENCE ENGINE (Interm√©diaire)
   - 45s, 2 tentatives, 2 indices (1 par question)
   - Conteneur questions fixe (options scroll)
   - Boutons fix√©s en bas (Valider / Corrig√© / Continuer)
   - Questions = celles du code fourni (int√©gr√©es ici)
========================================================= */

/* ---------- SFX ---------- */
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function tone(freq, dur=0.08, type="sine", gain=0.05){
  ensureAudio();
  const t0 = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = type; osc.frequency.value = freq;
  g.gain.value = gain;
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(t0); osc.stop(t0 + dur);
}
function sfxClick(){ tone(520,0.04,"triangle",0.035); }
function sfxCorrect(){ tone(660,0.07,"sine",0.06); setTimeout(()=>tone(880,0.08,"sine",0.06), 80); }
function sfxWrong(){ tone(220,0.10,"square",0.05); setTimeout(()=>tone(180,0.12,"square",0.05), 90); }
function sfxCritical(){ tone(140,0.14,"sawtooth",0.05); setTimeout(()=>tone(120,0.16,"sawtooth",0.05), 120); }
function sfxAlarmLong(){
  ensureAudio();
  const now = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = "sawtooth";
  osc.frequency.setValueAtTime(520, now);
  osc.frequency.linearRampToValueAtTime(380, now + 0.35);
  osc.frequency.linearRampToValueAtTime(520, now + 0.70);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.07, now + 0.02);
  g.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(now); osc.stop(now + 1.25);
}
function sfxVictory(){
  ensureAudio();
  const notes = [
    {f:659,d:0.10},{f:784,d:0.10},{f:988,d:0.14},
    {f:1175,d:0.18},{f:988,d:0.14},{f:1047,d:0.22}
  ];
  let t = 0;
  notes.forEach(n=>{
    setTimeout(()=>tone(n.f, n.d, "sine", 0.065), t*1000);
    t += n.d + 0.03;
  });
}

/* ---------- Helpers ---------- */
const el = (id)=>document.getElementById(id);
const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
const escapeHtml = (str)=>String(str)
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

const hudName = el("hudName"), hudRole = el("hudRole"), hudAvatar = el("hudAvatar"), difficultyChip = el("difficultyChip");
const hudScore = el("hudScore"), hudQnum = el("hudQnum"), hudQtotal = el("hudQtotal"), hudAttempts = el("hudAttempts");
const hudHints = el("hudHints");
const hudTime = el("hudTime"), ring = el("ring"), timerPill = el("timerPill"), stressBar = el("stressBar");
const qMeta = el("qMeta"), qTitle = el("qTitle"), qDesc = el("qDesc"), optionsEl = el("options");
const validateBtn = el("validateBtn"), clearBtn = el("clearBtn");
const hintBtn = el("hintBtn"), pauseBtn = el("pauseBtn");

const progressBar = el("progressBar");

/* Overlays */
const startOverlay = el("startOverlay"), startBtn = el("startBtn");
const feedbackOverlay = el("feedbackOverlay"), modalBox = el("modalBox"), badgeState = el("badgeState");
const modalText = el("modalText"), modalScore = el("modalScore"), modalStress = el("modalStress");
const retryBtn = el("retryBtn"), nextBtn = el("nextBtn"), okBtn = el("okBtn");

const hintOverlay = el("hintOverlay"), hintLeftLabel = el("hintLeftLabel"), hintText = el("hintText"), hintOkBtn = el("hintOkBtn");
const pauseOverlay = el("pauseOverlay"), resumeBtn = el("resumeBtn");

const keyOverlay = el("keyOverlay"), keyCloseBtn = el("keyCloseBtn"), answerKeyWrap = el("answerKeyWrap");
const showKeyBtn = el("showKeyBtn"), continueBtn = el("continueBtn");

const frame = el("frame");

/* ---------- CONFIG (Interm√©diaire) ---------- */
const SCENARIO = {
  id: 3,
  label: "Sc√©nario 3 ‚Äî Chute du 2e √©tage",
  mission: "Chute du deuxi√®me √©tage",
  level: "Interm√©diaire"
};
const NEXT_GENIALLY_URL = "#";     // <-- remplace par ton lien Genially

const TIMER_SECONDS = 45;
const ATTEMPTS_MAX = 3;
const HINT_MAX = 2;

const STRESS_RULES = { wrong:10, timeout:15, critical:25 };

const role = "pompier";
const roleLabelMap = { medecin:"M√©decin", infirmier:"Infirmier", pompier:"Pompier" };

/* ---------- Player data ---------- */
function readPlayerName(){
  return (window.player_name || window.playerName ||
    localStorage.getItem("player_name") || localStorage.getItem("playerName") ||
    localStorage.getItem("playerName") || "Joueur");
}
const playerName = readPlayerName();
const avatarFile = localStorage.getItem("avatar") || "pompier_f.png";
const difficulty = (localStorage.getItem("difficulty") || "interm√©diaire");

hudName.textContent = "Dr. " + playerName;
hudRole.textContent = "R√¥le: " + (roleLabelMap[role] || "‚Äî");
hudAvatar.src = "assets/avatars/" + avatarFile;
difficultyChip.textContent = "MODE: INTERM√âDIAIRE";
el("levelTabText").textContent = "SC√âNARIO 3 ‚Ä¢ INTERM√âDIAIRE";

/* ---------- State ---------- */
let score = parseInt(localStorage.getItem("score") || "0", 10); if(isNaN(score)) score = 0;
let stress = parseInt(localStorage.getItem("stress") || "0", 10); if(isNaN(stress)) stress = 0;

let idx = 0;
let locked = true;
let paused = false;

let timerId = null;
let timeLeft = TIMER_SECONDS;

let attemptsUsed = 0;          // ‚úÖ tentatives rat√©es (timeout OU mauvaise r√©ponse)
let hintsLeft = HINT_MAX;
let hintUsedThisQuestion = false;

const HINT_KEY = `hints_left_s${SCENARIO.id}`;

/* ---------- Questions (PRISES DU CODE FOURNI) ---------- */
const questions = [
  {"type": "single", "title": "TCC suspect", "desc": "Signe de traumatisme cr√¢nien :", "options": [{"text": "Confusion / r√©ponses incoh√©rentes", "kind": "ok", "fb": "‚úÖ Oui : signe neuro."}, {"text": "Cheveux mouill√©s", "kind": "wrong", "fb": "‚ùå Non."}, {"text": "Soif l√©g√®re", "kind": "wrong", "fb": "‚ùå Non."}, {"text": "√âraflure minime", "kind": "wrong", "fb": "‚ùå Non."}]},
  {"type": "multi", "title": "Choc", "desc": "Signes de choc :", "options": [{"text": "Peau froide/moite", "correct": true}, {"text": "Pouls rapide", "correct": true}, {"text": "Somnolence", "correct": true}, {"text": "Peau chaude/rouge", "correct": false}], "okFb": "‚úÖ Oui : choc possible.", "badFb": "‚ùå Revois signes de choc."},
  {"type": "single", "title": "Priorit√© A", "desc": "Priorit√© :", "options": [{"text": "Airway + immobilisation cervicale", "kind": "ok", "fb": "‚úÖ Oui."}, {"text": "Tester la marche", "kind": "wrong", "fb": "‚ùå Non."}, {"text": "Donner de l‚Äôeau", "kind": "wrong", "fb": "‚ùå Non."}, {"text": "Mettre assis", "kind": "wrong", "fb": "‚ùå Non."}]},
  {"type": "image_single", "title": "Choix de l‚Äôaction", "desc": "Quelle image repr√©sente la conduite la plus s√ªre imm√©diatement apr√®s la chute ?", "options": [{"label": "A", "imgSrc": "assets/chute_q4_a.png", "caption": "Immobilisation axe t√™te-cou-tronc", "kind": "ok", "fb": "‚úÖ Correct : conduite la plus s√ªre pour un pompier (trauma + rachis)."}, {"label": "B", "imgSrc": "assets/chute_q4_b.png", "caption": "Maintien t√™te-cou-tronc (terrain)", "kind": "wrong", "fb": "‚ùå Non : ici on veut immobilisation stricte (A)."}, {"label": "C", "imgSrc": "assets/chute_q4_c.png", "caption": "Immobilisation + contr√¥le vital + alerte/O‚ÇÇ si dispo", "kind": "wrong", "fb": "‚ùå Non : conduite inadapt√©e ici."}]},
  {"type": "multi", "title": "H√©morragie", "desc": "Si h√©morragie visible :", "options": [{"text": "Compression directe", "correct": true}, {"text": "Garrot si massif et protocole", "correct": true}, {"text": "Laisser saigner", "correct": false}, {"text": "Coton sans pression", "correct": false}], "okFb": "‚úÖ Correct.", "badFb": "‚ùå Contr√¥le h√©morragie indispensable."},
  {"type": "tf", "title": "O‚ÇÇ", "desc": "Vrai/Faux : O‚ÇÇ si d√©tresse respiratoire ou SpO‚ÇÇ basse.", "tf": {"trueOpt": {"kind": "ok", "fb": "‚úÖ Vrai."}, "falseOpt": {"kind": "wrong", "fb": "‚ùå Faux."}}},
  {"type": "single", "title": "Erreur critique", "desc": "Erreur critique :", "options": [{"text": "Faire asseoir/relever la victime", "kind": "critical", "pts": -10, "fb": "üö® Critique : risque rachis."}, {"text": "Couvrir", "kind": "ok", "pts": 0, "fb": "‚úÖ OK."}, {"text": "Rassurer", "kind": "ok", "pts": 0, "fb": "‚úÖ OK."}, {"text": "Surveiller FR", "kind": "ok", "pts": 0, "fb": "‚úÖ OK."}]},
  {"type": "drag_order", "title": "S√©quence", "desc": "Mets l‚Äôordre :", "items": [{"id": "safe", "text": "S√©curiser"}, {"id": "a", "text": "A: VA + rachis"}, {"id": "b", "text": "B: respiration (O‚ÇÇ si besoin)"}, {"id": "c", "text": "C: circulation (h√©morragie/choc)"}, {"id": "call", "text": "Alerter/transmettre"}], "expected": ["safe", "a", "b", "c", "call"], "okFb": "‚úÖ Parfait.", "badFb": "‚ùå S√©curiser ‚Üí A ‚Üí B ‚Üí C ‚Üí Alerter."},
  {"type": "hotspot", "title": "Hotspot ‚Äî Zone √† prot√©ger", "desc": "Clique sur la zone prioritaire √† prot√©ger.", "imgSrc": "scenario_3_hotspot.png", "hotspots": [{"label": "ok", "x": 30, "y": 28, "w": 18, "h": 40, "kind": "ok", "fb": "‚úÖ Correct : rachis/colonne (ne pas mobiliser).", "pts": 10}, {"label": "ko", "x": 10, "y": 18, "w": 18, "h": 20, "kind": "wrong", "fb": "‚ùå Non : zone non prioritaire ici.", "pts": -2}, {"label": "ko", "x": 70, "y": 72, "w": 18, "h": 18, "kind": "wrong", "fb": "‚ùå Non : zone non prioritaire ici.", "pts": -2}]},
  {"type": "single", "title": "Transmission", "desc": "Info indispensable :", "options": [{"text": "Hauteur + m√©canisme + √©tat (FR/conscience)", "kind": "ok", "fb": "‚úÖ Oui."}, {"text": "Adresse mail", "kind": "wrong", "fb": "‚ùå Non."}, {"text": "Photo", "kind": "wrong", "fb": "‚ùå Non."}, {"text": "Nom du lyc√©e", "kind": "wrong", "fb": "‚ùå Non."}]},
  {"type": "multi", "title": "Pr√©venir hypothermie", "desc": "Mesures :", "options": [{"text": "Couvrir / isoler du sol", "correct": true}, {"text": "Limiter exposition", "correct": true}, {"text": "Surveiller r√©guli√®rement", "correct": true}, {"text": "Retirer tout dehors", "correct": false}], "okFb": "‚úÖ Bien.", "badFb": "‚ùå Attention √† l‚Äôexposition."},
  {"type": "tf", "title": "Boisson", "desc": "Vrai/Faux : ne pas faire boire un traumatis√©.", "tf": {"trueOpt": {"kind": "ok", "fb": "‚úÖ Vrai."}, "falseOpt": {"kind": "wrong", "fb": "‚ùå Faux."}}},
  {"type": "single", "title": "Renfort", "desc": "Tu demandes renfort :", "options": [{"text": "Trauma grave suspect√© (hauteur)", "kind": "ok", "fb": "‚úÖ Oui."}, {"text": "Seulement si la victime crie", "kind": "wrong", "fb": "‚ùå Non."}, {"text": "Jamais", "kind": "wrong", "fb": "‚ùå Non."}, {"text": "Apr√®s 30 minutes", "kind": "wrong", "fb": "‚ùå Non."}]},
  {"type": "short", "title": "Num√©ro", "desc": "Num√©ro m√©dical (1 nombre)", "answers": ["15"], "okFb": "‚úÖ 15.", "badFb": "‚ùå 15."},
  {"type": "short", "title": "Mot-cl√©", "desc": "Structure √† prot√©ger (1 mot)", "answers": ["rachis", "colonne"], "okFb": "‚úÖ Rachis.", "badFb": "‚ùå Rachis."}
];

const TOTAL = questions.length;
hudQtotal.textContent = String(TOTAL);

/* ---------- Persist / UI setters ---------- */
function setScore(v){
  score = v;
  localStorage.setItem("score", String(score));
  hudScore.textContent = String(score);
  modalScore.textContent = String(score);
}
function addScore(d){ setScore(score + d); }
function setStress(v){
  stress = clamp(v, 0, 100);
  localStorage.setItem("stress", String(stress));
  stressBar.style.width = stress + "%";
  modalStress.textContent = String(stress);
}
function addStress(d){ setStress(stress + d); }

function setAttemptsUI(){
  hudAttempts.textContent = String(attemptsUsed);
}
function setHintsUI(){
  hudHints.textContent = String(hintsLeft);
  hintBtn.disabled = (locked || paused || hintsLeft <= 0 || hintUsedThisQuestion);
}
function setProgressUI(){
  const pct = clamp(Math.round((idx / TOTAL) * 100), 0, 100);
  progressBar.style.width = pct + "%";
}

function setRingProgress(){
  const p = clamp(Math.round((timeLeft / TIMER_SECONDS) * 100), 0, 100);
  ring.style.setProperty("--p", p + "%");
  timerPill.classList.remove("timerWarn","timerDanger");
  if(timeLeft <= 5) timerPill.classList.add("timerDanger");
  else if(timeLeft <= 10) timerPill.classList.add("timerWarn");
}

/* ---------- Timer ---------- */
function stopTimer(){ clearInterval(timerId); timerId = null; }
function startTimer(reset=true){
  stopTimer();
  if(reset){ timeLeft = TIMER_SECONDS; }
  hudTime.textContent = String(timeLeft);
  setRingProgress();
  timerId = setInterval(()=>{
    if(locked || paused) return;
    timeLeft--;
    hudTime.textContent = String(timeLeft);
    setRingProgress();
    if(timeLeft <= 0){
      stopTimer();
      sfxAlarmLong();
      failAttempt("‚è±Ô∏è Temps √©coul√©.", "timeout");
    }
  }, 1000);
}

/* ---------- Selection state ---------- */
let selectedSingle = null;
let multiSelected = new Set();
let inputValue = "";
let hintCache = ""; // computed hint

function resetSelection(){
  selectedSingle = null;
  multiSelected.clear();
  inputValue = "";
  validateBtn.disabled = true;
  hintUsedThisQuestion = false;
  setHintsUI();
}

/* ---------- Hint generation (auto) ---------- */
function computeHintForQuestion(q){
  if(q.hint) return q.hint;

  if(q.type === "single" || q.type === "image_single"){
    const ok = (q.options||[]).find(o=>o.kind==="ok");
    if(!ok) return "Concentre-toi sur la conduite la plus s√ªre et la priorit√© vitale.";
    const t = ok.text || ok.caption || "";
    return "Indice : cherche la r√©ponse qui correspond √† la priorit√© (s√©curit√© / immobilisation / ABC).";
  }

  if(q.type === "tf"){
    return "Indice : en urgence, on privil√©gie la s√©curit√© et la pr√©vention des aggravations.";
  }

  if(q.type === "multi"){
    const oks = (q.options||[]).filter(o=>o.correct).map(o=>o.text);
    if(oks.length) return "Indice : il y a " + oks.length + " bonnes propositions (signes/gestes cl√©s).";
    return "Indice : s√©lectionne toutes les propositions qui prot√®gent la vie et √©vitent l‚Äôaggravation.";
  }

  if(q.type === "drag_order"){
    return "Indice : l‚Äôordre classique est S√©curiser ‚Üí A ‚Üí B ‚Üí C ‚Üí Alerter.";
  }

  if(q.type === "hotspot"){
    return "Indice : prot√®ge la zone qui, si elle bouge, peut aggraver gravement la victime.";
  }

  if(q.type === "short"){
    return "Indice : une r√©ponse courte suffit (mot-cl√© ou num√©ro).";
  }

  return "Indice : relis la consigne et pense aux priorit√©s d‚Äôintervention.";
}

/* ---------- Render question ---------- */
function mkOpt(text){
  const d = document.createElement("div");
  d.className = "opt";
  d.textContent = text;
  return d;
}

function renderQuestion(i){
  locked = false;
  paused = false;
  hideFeedback();

  idx = i;
  setProgressUI();

  const q = questions[idx];
  qMeta.textContent = `${SCENARIO.label} ‚Ä¢ ${SCENARIO.level}`;
  qTitle.textContent = q.title || "‚Äî";
  qDesc.innerHTML = q.desc || "";
  optionsEl.innerHTML = "";
  clearBtn.style.display = "none";
  resetSelection();

  // refresh hint cache
  hintCache = computeHintForQuestion(q);

  // update Q num
  hudQnum.textContent = String(idx + 1);

  // types
  if(q.type === "single"){
    (q.options||[]).forEach((opt, oi)=>{
      const d = mkOpt(opt.text);
      d.onclick = ()=>{
        sfxClick();
        [...optionsEl.children].forEach(x=>x.classList.remove("sel"));
        d.classList.add("sel");
        selectedSingle = oi;
        validateBtn.disabled = false;
      };
      optionsEl.appendChild(d);
    });
  }

  if(q.type === "tf"){
    const opts = [
      {label:"Vrai", data:q.tf.trueOpt},
      {label:"Faux", data:q.tf.falseOpt}
    ];
    opts.forEach((o, oi)=>{
      const d = mkOpt(o.label);
      d.onclick = ()=>{
        sfxClick();
        [...optionsEl.children].forEach(x=>x.classList.remove("sel"));
        d.classList.add("sel");
        selectedSingle = oi;
        validateBtn.disabled = false;
      };
      optionsEl.appendChild(d);
    });
  }

  if(q.type === "multi"){
    clearBtn.style.display = "inline-block";
    (q.options||[]).forEach((opt, oi)=>{
      const d = mkOpt(opt.text);
      d.onclick = ()=>{
        sfxClick();
        if(multiSelected.has(oi)){ multiSelected.delete(oi); d.classList.remove("sel"); }
        else { multiSelected.add(oi); d.classList.add("sel"); }
        validateBtn.disabled = (multiSelected.size === 0);
      };
      optionsEl.appendChild(d);
    });
  }

  if(q.type === "short"){
    clearBtn.style.display = "inline-block";
    const box = document.createElement("div");
    box.className = "opt";
    box.style.cursor = "default";
    box.innerHTML = `
      <div style="font-weight:950; margin-bottom:8px;">Ta r√©ponse</div>
      <input id="shortInput" class="form-control" type="text" placeholder="√âcris ici‚Ä¶"
        style="background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.18); color: rgba(255,255,255,.92);" />
      <div style="margin-top:8px; font-size:12px; color: rgba(255,255,255,.72);">Astuce : une valeur courte suffit.</div>
    `;
    optionsEl.appendChild(box);
    const inp = box.querySelector("#shortInput");
    inp.addEventListener("input", ()=>{
      inputValue = inp.value;
      validateBtn.disabled = (inp.value.trim().length === 0);
    });
  }

  if(q.type === "image_single"){
    const grid = document.createElement("div");
    grid.className = "imgGrid";

    (q.options||[]).forEach((opt, oi)=>{
      const card = document.createElement("div");
      card.className = "imgCard";
      card.innerHTML = `
        <div class="imgHead">
          <div>Option ${opt.label}</div>
          <div class="imgTag">${opt.label}</div>
        </div>
        <img class="imgPic" src="${opt.imgSrc}" alt="Option ${opt.label}">
        <div class="imgCap">${opt.caption || ""}</div>
      `;
      card.onclick = ()=>{
        sfxClick();
        [...grid.querySelectorAll(".imgCard")].forEach(c=>c.classList.remove("sel"));
        card.classList.add("sel");
        selectedSingle = oi;
        validateBtn.disabled = false;
      };
      grid.appendChild(card);
    });

    optionsEl.appendChild(grid);
  }

  if(q.type === "hotspot"){
    clearBtn.style.display = "inline-block";

    const note = document.createElement("div");
    note.className = "pill";
    note.innerHTML = "üéØ <b>Clique sur la zone correcte</b>, puis <b>Valider</b>.";
    optionsEl.appendChild(note);

    const wrap = document.createElement("div");
    wrap.className = "hotspotWrap";
    wrap.innerHTML = `<img src="${q.imgSrc||""}" alt="hotspot">`;
    optionsEl.appendChild(wrap);

    const zones = document.createElement("div");
    zones.style.position = "absolute";
    zones.style.inset = "0";
    zones.style.pointerEvents = "auto";
    wrap.appendChild(zones);

    selectedSingle = null;
    validateBtn.disabled = true;

    (q.hotspots||[]).forEach((h, hi)=>{
      const z = document.createElement("button");
      z.type = "button";
      z.className = "hotspot-zone";
      z.style.left = h.x + "%";
      z.style.top  = h.y + "%";
      z.style.width  = h.w + "%";
      z.style.height = h.h + "%";
      z.onclick = ()=>{
        sfxClick();
        [...zones.querySelectorAll("button")].forEach(b=>b.classList.remove("sel"));
        z.classList.add("sel");
        selectedSingle = hi;
        validateBtn.disabled = false;
      };
      zones.appendChild(z);
    });
  }

  if(q.type === "drag_order"){
    clearBtn.style.display = "inline-block";

    const note = document.createElement("div");
    note.className = "pill";
    note.textContent = "üñ±Ô∏è Glisse-d√©pose les cartes pour les mettre dans l‚Äôordre.";
    optionsEl.appendChild(note);

    const list = document.createElement("div");
    list.id = "dragList";
    list.style.display = "grid";
    list.style.gap = "10px";

    const items = [...(q.items||[])];
    for(let k=items.length-1;k>0;k--){
      const j = Math.floor(Math.random()*(k+1));
      [items[k], items[j]] = [items[j], items[k]];
    }

    items.forEach(it=>{
      const row = document.createElement("div");
      row.className = "opt";
      row.setAttribute("draggable","true");
      row.dataset.id = it.id;
      row.innerHTML = `<div style="font-weight:950;">${escapeHtml(it.text)}</div><div style="font-size:12px; color: rgba(255,255,255,.68); margin-top:3px;">(glisser)</div>`;
      list.appendChild(row);
    });
    optionsEl.appendChild(list);

    let dragSrc = null;
    list.addEventListener("dragstart",(e)=>{
      const t = e.target.closest("[draggable='true']");
      if(!t) return;
      dragSrc = t;
      e.dataTransfer.effectAllowed="move";
      t.style.opacity="0.6";
    });
    list.addEventListener("dragend",(e)=>{
      const t = e.target.closest("[draggable='true']");
      if(t) t.style.opacity="1";
      dragSrc=null;
    });
    list.addEventListener("dragover",(e)=>{
      e.preventDefault();
      const over = e.target.closest("[draggable='true']");
      if(!over || !dragSrc || over===dragSrc) return;
      const rect = over.getBoundingClientRect();
      const before = (e.clientY - rect.top) < rect.height/2;
      list.insertBefore(dragSrc, before ? over : over.nextSibling);
    });
    list.addEventListener("drop",(e)=>{
      e.preventDefault();
      validateBtn.disabled = false; // allow validate after any interaction
    });

    validateBtn.disabled = false; // order exists anyway
  }

  // start timer
  startTimer(true);
  setHintsUI();
}

/* ---------- Clear ---------- */
clearBtn.onclick = ()=>{
  sfxClick();
  renderQuestion(idx);
};

/* ---------- Hint button ---------- */
hintBtn.onclick = ()=>{
  if(locked || paused) return;
  if(hintsLeft <= 0) return;
  if(hintUsedThisQuestion) return;

  sfxClick();
  paused = true;
  stopTimer();

  hintsLeft = Math.max(0, hintsLeft - 1);
  localStorage.setItem(HINT_KEY, String(hintsLeft));
  hintUsedThisQuestion = true;

  hintLeftLabel.textContent = String(hintsLeft);
  hintText.innerHTML = `<div style="font-weight:950; font-size:15px; margin-bottom:6px;">Indice pour cette question</div>
    <div style="color: rgba(255,255,255,.86); line-height:1.55;">${escapeHtml(hintCache)}</div>`;
  hintOverlay.style.display = "flex";
  setHintsUI();
};

hintOkBtn.onclick = ()=>{
  hintOverlay.style.display = "none";
  paused = false;
  startTimer(false);
  setHintsUI();
};

/* ---------- Pause ---------- */
pauseBtn.onclick = ()=>{
  if(locked) return;
  sfxClick();
  paused = true;
  stopTimer();
  pauseOverlay.style.display = "flex";
  setHintsUI();
};
resumeBtn.onclick = ()=>{
  pauseOverlay.style.display = "none";
  paused = false;
  startTimer(false);
  setHintsUI();
};

/* ---------- Feedback overlay helpers ---------- */
function showFeedback(kind, text, opts){
  // opts: {allowRetry, allowNext, missionFail, customOk}
  badgeState.className = "badgeState";
  if(kind==="good"){ badgeState.classList.add("bGood"); badgeState.textContent="‚úÖ Bonne r√©ponse"; }
  if(kind==="warn"){ badgeState.classList.add("bWarn"); badgeState.textContent="‚ö†Ô∏è √Ä corriger"; }
  if(kind==="bad") { badgeState.classList.add("bBad");  badgeState.textContent="üö® Mission √©chou√©e"; }

  modalText.textContent = text;
  feedbackOverlay.style.display = "flex";

  retryBtn.style.display = opts.allowRetry ? "inline-block" : "none";
  nextBtn.style.display  = opts.allowNext  ? "inline-block" : "none";
  nextBtn.classList.toggle("show", !!opts.allowNext);

  okBtn.style.display = "none";
  okBtn.onclick = null;

  retryBtn.onclick = ()=>{ hideFeedback(); locked=false; paused=false; startTimer(false); setHintsUI(); };
  nextBtn.onclick  = ()=>{ hideFeedback(); goNext(); };

  if(opts.customOk){
    retryBtn.style.display = "none";
    nextBtn.style.display = "none";
    okBtn.style.display = "inline-block";
    okBtn.classList.add("show");
    okBtn.textContent = "OK";
    okBtn.onclick = opts.customOk;
  }
}
function hideFeedback(){
  feedbackOverlay.style.display = "none";
}

/* ---------- Attempts / fail logic (interm√©diaire) ---------- */
function motion(type){
  frame.classList.remove("shake","pulseGood","flashBad");
  modalBox.classList.remove("shake","pulseGood","flashBad");
  if(type==="good"){ frame.classList.add("pulseGood"); }
  else if(type==="wrong"){ modalBox.classList.add("shake"); }
  else if(type==="critical"){ modalBox.classList.add("shake"); frame.classList.add("flashBad"); }
}

function failAttempt(baseMsg, reason){
  // reason: "wrong" | "critical" | "timeout"
  locked = true;
  paused = true;
  attemptsUsed++;
  setAttemptsUI();

  if(reason==="timeout") addStress(STRESS_RULES.timeout);
  else if(reason==="critical") addStress(STRESS_RULES.critical);
  else addStress(STRESS_RULES.wrong);

  if(attemptsUsed >= ATTEMPTS_MAX){
    sfxAlarmLong();
    missionFail("‚ùå Trois tentatives rat√©es. Mission √©chou√©e. Retour au d√©part‚Ä¶ (score remis √† z√©ro)");
    return;
  }

  showFeedback("warn", `${baseMsg} (Tentative ${attemptsUsed}/${ATTEMPTS_MAX})`, {
    allowRetry: true,
    allowNext: false,
    missionFail: false
  });
  motion(reason==="critical" ? "critical" : "wrong");
  paused = true;
}

/* ---------- Evaluation ---------- */
function needSelection(msg){
  sfxClick();
  showFeedback("warn", msg, {
    allowRetry:false,
    allowNext:false,
    missionFail:false,
    customOk: ()=>{
      hideFeedback();
      locked = false;
      paused = false;
      startTimer(false);
      setHintsUI();
    }
  });
}

function evaluateOption(opt){
  if(opt.kind==="ok"){
    addScore(opt.pts ?? 10);
    sfxCorrect();
    showFeedback("good", opt.fb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
    motion("good");
    return;
  }
  if(opt.kind==="critical"){
    addScore(opt.pts ?? -10);
    sfxCritical();
    failAttempt(opt.fb || "üö® Erreur critique.", "critical");
    return;
  }
  // wrong/partial -> count as attempt
  if(opt.kind==="partial"){
    addScore(opt.pts ?? 3);
    sfxWrong();
    failAttempt(opt.fb || "üü° Partiel.", "wrong");
    return;
  }
  sfxWrong();
  failAttempt(opt.fb || "‚ùå Incorrect.", "wrong");
}

/* Validate button */
validateBtn.onclick = ()=>{
  if(locked || paused) return;

  const q = questions[idx];

  // safety: require answer
  if(q.type==="single" || q.type==="tf" || q.type==="image_single" || q.type==="hotspot"){
    if(selectedSingle===null) return needSelection("Choisis une r√©ponse avant de valider.");
  }
  if(q.type==="multi"){
    if(multiSelected.size===0) return needSelection("S√©lectionne au moins une proposition avant de valider.");
  }
  if(q.type==="short"){
    if((inputValue||"").trim().length===0) return needSelection("√âcris une r√©ponse avant de valider.");
  }

  stopTimer();
  locked = true;

  if(q.type==="single" || q.type==="image_single"){
    return evaluateOption(q.options[selectedSingle]);
  }

  if(q.type==="tf"){
    const opt = (selectedSingle===0) ? q.tf.trueOpt : q.tf.falseOpt;
    return evaluateOption(opt);
  }

  if(q.type==="multi"){
    const chosen=[...multiSelected].sort((a,b)=>a-b);
    const correctIdx=q.options.map((o,i)=>o.correct?i:null).filter(v=>v!==null);
    const ok = chosen.length===correctIdx.length && chosen.every((v,i)=>v===correctIdx[i]);
    if(ok){
      addScore(10);
      sfxCorrect(); motion("good");
      showFeedback("good", q.okFb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
    }else{
      sfxWrong();
      failAttempt(q.badFb || "‚ùå Incorrect.", "wrong");
    }
    return;
  }

  if(q.type==="short"){
    const norm=(inputValue||"").trim().toLowerCase();
    const accepted=(q.answers||[]).map(a=>String(a).trim().toLowerCase());
    const ok = accepted.includes(norm);
    if(ok){
      addScore(10);
      sfxCorrect(); motion("good");
      showFeedback("good", q.okFb || "‚úÖ Bonne r√©ponse.", {allowRetry:false, allowNext:true, missionFail:false});
    }else{
      sfxWrong();
      failAttempt(q.badFb || "‚ùå R√©ponse incorrecte.", "wrong");
    }
    return;
  }

  if(q.type==="hotspot"){
    const h = (q.hotspots||[])[selectedSingle];
    if(!h) return;
    if(h.kind==="ok"){
      addScore(h.pts ?? 10);
      sfxCorrect(); motion("good");
      showFeedback("good", h.fb || "‚úÖ Correct.", {allowRetry:false, allowNext:true, missionFail:false});
    }else if(h.kind==="critical"){
      addScore(h.pts ?? -10);
      sfxCritical();
      failAttempt(h.fb || "üö® Erreur critique.", "critical");
    }else{
      addScore(h.pts ?? 0);
      sfxWrong();
      failAttempt(h.fb || "‚ùå Incorrect.", "wrong");
    }
    return;
  }

  if(q.type==="drag_order"){
    const list = document.getElementById("dragList");
    const order = [...list.querySelectorAll("[draggable='true']")].map(x=>x.dataset.id);
    const ok = order.length===q.expected.length && q.expected.every((v,i)=>order[i]===v);
    if(ok){
      addScore(10);
      sfxCorrect(); motion("good");
      showFeedback("good", q.okFb || "‚úÖ Bon ordre.", {allowRetry:false, allowNext:true, missionFail:false});
    }else{
      sfxWrong();
      failAttempt(q.badFb || "‚ùå Ordre incorrect.", "wrong");
    }
    return;
  }
};

/* ---------- Navigation ---------- */
function goNext(){
  hideFeedback();
  locked = false;
  paused = false;

  if(idx + 1 < TOTAL){
    renderQuestion(idx + 1);
  }else{
    endScenario();
  }
}

/* ---------- Mission fail / reset ---------- */
function missionFail(message){
  stopTimer();
  showFeedback("bad", message, {
    allowRetry:false, allowNext:false, missionFail:true,
    customOk: ()=>{
      hideFeedback();
      resetMission(true);
    }
  });
  motion("critical");
}

function resetMission(showStart=true){
  stopTimer();
  locked = true;
  paused = false;

  idx = 0;
  attemptsUsed = 0;
  setAttemptsUI();

  setScore(0);
  setStress(0);

  // Reset hints to max at start (r√©f√©rence)
  hintsLeft = HINT_MAX;
  localStorage.setItem(HINT_KEY, String(hintsLeft));
  setHintsUI();

  progressBar.style.width = "0%";
  hudQnum.textContent = "1";
  hudTime.textContent = String(TIMER_SECONDS);
  ring.style.setProperty("--p","100%");
  setRingProgress();

  if(showStart) startOverlay.style.display = "flex";
}

/* ---------- Corrig√© (Answer Key) ---------- */
function answerOfQuestion(q){
  if(q.type==="single"){
    const ok = (q.options||[]).find(o=>o.kind==="ok");
    return ok ? ok.text : "‚Äî";
  }
  if(q.type==="image_single"){
    const ok = (q.options||[]).find(o=>o.kind==="ok");
    return ok ? `${ok.label} ‚Äî ${ok.caption}` : "‚Äî";
  }
  if(q.type==="tf"){
    return (q.tf.trueOpt.kind==="ok") ? "Vrai" : "Faux";
  }
  if(q.type==="multi"){
    const a = (q.options||[]).filter(o=>o.correct).map(o=>o.text);
    return a.join(" ; ");
  }
  if(q.type==="short"){
    return (q.answers||[]).join(" / ");
  }
  if(q.type==="drag_order"){
    const map = Object.fromEntries((q.items||[]).map(it=>[it.id,it.text]));
    return (q.expected||[]).map(id=>map[id]).join(" ‚Üí ");
  }
  if(q.type==="hotspot"){
    return "Zone: Rachis / Colonne (ne pas mobiliser).";
  }
  return "‚Äî";
}

function buildAnswerKey(){
  const rows = questions.map((q, i)=>{
    const ans = answerOfQuestion(q);
    return `
      <tr>
        <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); width:52px; color: rgba(255,255,255,.75);">Q${i+1}</td>
        <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); font-weight:900;">${escapeHtml(q.title||"")}</td>
        <td style="padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); color: rgba(255,255,255,.86);">${escapeHtml(ans)}</td>
      </tr>`;
  }).join("");

  return `
    <div style="margin-bottom:10px; color: rgba(255,255,255,.78);">
      Corrig√© du <b>${escapeHtml(SCENARIO.label)}</b> ‚Ä¢ Mode <b>Interm√©diaire</b>
    </div>
    <div style="overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.12);">
      <table style="width:100%; border-collapse:collapse; min-width:680px;">
        <thead>
          <tr>
            <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">#</th>
            <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">Question</th>
            <th style="text-align:left; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.12); color: rgba(255,255,255,.65); font-size:12px;">Bonne r√©ponse</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

/* ---------- End scenario / badge ---------- */
function computeBadgeFromScore(){
  const max = TOTAL * 10;
  const pct = (max>0) ? (score / max) * 100 : 0;
  if(pct >= 90) return {type:"OR", img:"assets/or.png"};
  if(pct >= 70) return {type:"ARGENT", img:"assets/argent.png"};
  return {type:"BRONZE", img:"assets/bronze.png"};
}

function saveBadge(badge){
  const payload = {
    scenarioId: SCENARIO.id,
    mission: SCENARIO.mission,
    niveau: "interm√©diaire",
    badgeType: badge.type,
    badgeName: `Badge ${badge.type} ‚Äî ${SCENARIO.mission}`,
    score: score,
    dateISO: new Date().toISOString()
  };

  const key = `badge_s${SCENARIO.id}_intermediaire`;
  localStorage.setItem(key, JSON.stringify(payload));

  const histKey = "badges_history";
  const hist = JSON.parse(localStorage.getItem(histKey) || "[]");
  hist.push(payload);
  localStorage.setItem(histKey, JSON.stringify(hist));
}

function endScenario(){
  stopTimer();
  locked = true;
  paused = false;

  // disable HUD buttons
  hintBtn.disabled = true;
  pauseBtn.disabled = true;

  // disable action buttons
  validateBtn.disabled = true;
  clearBtn.style.display = "none";

  // badge
  const badge = computeBadgeFromScore();
  saveBadge(badge);

  // unlock Corrig√© + show Continuer
  showKeyBtn.disabled = false;
  continueBtn.style.display = "inline-block";

  // progress 100%
  progressBar.style.width = "100%";

  qMeta.textContent = "FIN ‚Äî BADGE OBTENU";
  qTitle.textContent = "üéâ Mission termin√©e !";
  sfxVictory();

  const stressState = (stress>=80) ? "üî¥ Pression extr√™me" : (stress>=40) ? "üü° Sous pression" : "üü¢ Calme";

  qDesc.innerHTML = `
    <div style="margin-top:4px; color: rgba(255,255,255,.86);">
      <div style="font-weight:950; font-size:16px;">üèÖ Badge ${escapeHtml(badge.type)} ‚Äî ${escapeHtml(SCENARIO.mission)}</div>
      <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">‚≠ê Score final : <b>${score}</b></span>
        <span class="pill">üò∞ Stress : <b>${stress}%</b> (${escapeHtml(stressState)})</span>
      </div>
    </div>`;

  optionsEl.innerHTML = `
    <div class="opt" style="cursor:default; text-align:center;">
      <div style="display:flex; justify-content:center; gap:14px; align-items:center; flex-wrap:wrap;">
        <div style="width:92px; height:92px; border-radius:18px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
                    display:grid; place-items:center; box-shadow:0 18px 55px rgba(0,0,0,.35);">
          <img src="${badge.img}" alt="badge" style="width:64px; height:64px; object-fit:contain;">
        </div>
        <div style="text-align:left; min-width:220px;">
          <div style="font-weight:950; font-size:18px;">FIN ‚Äî BADGE OBTENU</div>
          <div style="color: rgba(255,255,255,.74); margin-top:4px; line-height:1.45;">
            Sc√©nario 3 ‚Ä¢ Chute du 2e √©tage ‚Ä¢ Pompier ‚Ä¢ Interm√©diaire
          </div>
        </div>
      </div>
    </div>`;
}

/* Actions: Corrig√© / Continuer */
showKeyBtn.onclick = ()=>{
  sfxClick();
  answerKeyWrap.innerHTML = buildAnswerKey();
  keyOverlay.style.display = "flex";
};
keyCloseBtn.onclick = ()=>{
  sfxClick();
  keyOverlay.style.display = "none";
};
continueBtn.onclick = ()=>{
  sfxClick();
  window.location.href = NEXT_GENIALLY_URL;
};

/* ---------- Start ---------- */
startBtn.onclick = ()=>{
  ensureAudio(); sfxClick();

  // reset run
  localStorage.setItem("score","0");
  localStorage.setItem("stress","0");

  // reset hints forced to max at start (r√©f√©rence)
  hintsLeft = HINT_MAX;
  localStorage.setItem(HINT_KEY, String(hintsLeft));

  score = 0; stress = 0;
  setScore(0); setStress(0);

  attemptsUsed = 0;
  setAttemptsUI();

  startOverlay.style.display = "none";
  renderQuestion(0);
};

/* ---------- Init ---------- */
(function init(){
  setScore(score);
  setStress(stress);

  // load hints from storage (but reset at start)
  const stored = parseInt(localStorage.getItem(HINT_KEY) || String(HINT_MAX), 10);
  hintsLeft = isNaN(stored) ? HINT_MAX : clamp(stored, 0, HINT_MAX);

  attemptsUsed = 0;
  setAttemptsUI();
  setHintsUI();

  qMeta.textContent = SCENARIO.label;
  qTitle.textContent = "Pr√©pare-toi‚Ä¶";
  qDesc.innerHTML = "Tu as <b>45 secondes</b> par question. Clique sur <b>D√âMARRER</b>.";
  optionsEl.innerHTML = "";

  hudQnum.textContent = "1";
  hudQtotal.textContent = String(TOTAL);
  hudTime.textContent = String(TIMER_SECONDS);

  ring.style.setProperty("--p","100%");
  setRingProgress();
  progressBar.style.width = "0%";
})();
</script>
  <script src="badge-manager.js"></script>
</body>
</html>
