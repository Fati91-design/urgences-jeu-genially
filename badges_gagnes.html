  <!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Urgences ‚Äî Badges</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">

<style>
  :root{
    --glass: rgba(0,0,0,.42);
    --glass2: rgba(0,0,0,.30);
    --text: rgba(255,255,255,.93);
    --muted: rgba(255,255,255,.75);

    --gold: rgba(255,190,110,1);
    --blue: rgba(120,190,255,1);
    --ember: rgba(255,120,50,1);
    --line: rgba(255,255,255,.14);
  }

  html, body { background: transparent; margin: 0; color: #fff; overflow:hidden; }
  *{ box-sizing: border-box; }

  /* ‚úÖ Genially: sc√®ne fixe 16:9 + scale auto */
  .genially-stage{
    width: 100vw;
    height: 100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  .genially-page{
    width: 1920px;
    height: 1080px;
    position: relative;
    transform-origin: center;
  }

  .page-wrap{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 38px 50px;
  }
  .container{ max-width: 1500px; }

  /* ===== Title (style inspir√© de ton √©cran) ===== */
  .gameTitleWrap{
    text-align:center;
    margin: 0 0 14px;
    position: relative;
    isolation: isolate;
  }
  .topBadge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding: 7px 14px;
    border-radius: 999px;
    font-size: 12px;
    letter-spacing: .22em;
    text-transform: uppercase;
    color: rgba(255,255,255,.92);
    background: rgba(0,0,0,.35);
    border: 1px solid rgba(255,255,255,.16);
    backdrop-filter: blur(10px);
    box-shadow: 0 22px 60px rgba(0,0,0,.35);
    margin-bottom: 10px;
  }
  .gameTitleBack{
    font-family:'Anton', sans-serif;
    text-transform:uppercase;
    letter-spacing:.06em;
    font-size: 72px;
    line-height: .92;
    margin: 0;

    background: linear-gradient(180deg, #d7e9ff 0%, #86bfff 40%, #cfe3ff 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;

    text-shadow:
      0 18px 70px rgba(0,0,0,.75),
      0 0 45px rgba(120,190,255,.22);
  }
  .gameSubtitleBig{
    font-family:'Anton', sans-serif;
    text-transform:uppercase;
    letter-spacing:.05em;
    font-size: 54px;
    line-height: .92;
    margin: 6px 0 0;
    color: rgba(255,255,255,.98);
    text-shadow:
      0 26px 90px rgba(0,0,0,.75),
      0 0 28px rgba(255,255,255,.08);
  }
  .gameTitleWrap::before{
    content:"";
    position:absolute;
    inset: -22px -10px -10px -10px;
    background: radial-gradient(closest-side, rgba(255,255,255,.10), transparent 70%);
    filter: blur(10px);
    opacity: .60;
    z-index: 0;
    pointer-events:none;
  }

  /* ===== Glass container ===== */
  .glass{
    width: min(1400px, 100%);
    background: var(--glass);
    border: 1px solid var(--line);
    backdrop-filter: blur(12px);
    border-radius: 24px;
    box-shadow: 0 20px 70px rgba(0,0,0,.45);
    overflow: hidden;
    position: relative;
  }
  .glass::before{
    content:"";
    position:absolute; inset:-2px;
    background:
      radial-gradient(900px 240px at 18% 0%, rgba(255,120,50,.18), transparent 60%),
      radial-gradient(900px 240px at 82% 120%, rgba(120,190,255,.12), transparent 60%),
      linear-gradient(120deg, rgba(255,255,255,.10), transparent 35%, rgba(255,255,255,.06));
    opacity:.22;
    pointer-events:none;
  }

  .header{
    position: relative;
    padding: 18px 22px 14px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    z-index: 2;
  }

  .hello{
    margin:0 0 4px;
    font-weight: 900;
    font-size: 30px;
    text-shadow: 0 12px 30px rgba(0,0,0,.55);
  }
  .hello .name{
    color: var(--gold);
    text-shadow: 0 0 14px rgba(255,165,0,.35);
  }
  .subtitle{
    margin:0;
    font-size: 14px;
    color: rgba(255,255,255,.75);
  }

  .headerRow{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap: 14px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .pill{
    padding: 7px 12px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 900;
    letter-spacing: .12em;
    text-transform: uppercase;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.25);
    color: rgba(255,255,255,.88);
    white-space: nowrap;
    display:inline-flex;
    align-items:center;
    gap: 8px;
  }
  .pill strong{ letter-spacing: normal; }

  /* Filter pills */
  .filterGroup{
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content:flex-end;
  }
  .filterBtn{
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.25);
    color: rgba(255,255,255,.90);
    border-radius: 999px;
    padding: 9px 14px;
    font-weight: 900;
    letter-spacing: .10em;
    text-transform: uppercase;
    font-size: 12px;
    cursor: pointer;
    transition: transform .15s ease, filter .15s ease, border-color .15s ease, box-shadow .15s ease;
    user-select: none;
  }
  .filterBtn:hover{ transform: translateY(-2px); filter: brightness(1.06); }
  .filterBtn.isActive{
    border-color: rgba(255,165,0,.55);
    box-shadow: 0 0 0 6px rgba(255,165,0,.14);
    background: rgba(0,0,0,.32);
  }

  /* Counters */
  .counterRow{
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content:flex-start;
  }
  .pillGold{ border-color: rgba(255,190,110,.35); background: rgba(255,190,110,.12); }
  .pillSilver{ border-color: rgba(120,190,255,.35); background: rgba(120,190,255,.12); }
  .pillBronze{ border-color: rgba(255,120,50,.40); background: rgba(255,120,50,.12); }

  .body{
    position: relative;
    z-index: 2;
    padding: 18px 20px 22px;
  }

  .sectionTitle{
    text-align:center;
    font-weight: 900;
    letter-spacing: .12em;
    text-transform: uppercase;
    font-size: 18px;
    margin: 6px 0 14px;
    color: rgba(255,255,255,.92);
  }

  /* Badges grid */
  .grid{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
  }
  @media (max-width: 1400px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 1000px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 640px){ .grid{ grid-template-columns: 1fr; } }

  .badgeCard{
    background: rgba(0,0,0,.34);
    border: 1px solid rgba(255,255,255,.14);
    border-radius: 22px;
    padding: 14px 14px 12px;
    backdrop-filter: blur(12px);
    box-shadow: 0 16px 55px rgba(0,0,0,.35);
    transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    position: relative;
    overflow: hidden;
    min-height: 170px;
  }
  .badgeCard::before{
    content:"";
    position:absolute;
    inset:-2px;
    background: linear-gradient(120deg, rgba(255,255,255,.10), transparent 35%, rgba(255,255,255,.08));
    opacity:.18;
    pointer-events:none;
  }
  .badgeCard:hover{
    transform: translateY(-4px);
    border-color: rgba(255,165,0,.40);
    box-shadow: 0 26px 85px rgba(0,0,0,.55);
  }
  .badgeCard.locked{
    opacity: .70;
    filter: grayscale(.35);
  }

  .badgeTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    margin-bottom: 10px;
  }
  .badgeTitle{
    font-weight: 900;
    letter-spacing: .08em;
    text-transform: uppercase;
    font-size: 15px;
    margin: 0;
    color: rgba(255,255,255,.92);
  }
  .badgeMini{
    font-size: 12px;
    font-weight: 900;
    color: rgba(255,255,255,.78);
  }
  .badgeMid{
    display:flex;
    align-items:center;
    gap: 12px;
    margin-top: 4px;
  }
  .badgeImg{
    width: 62px;
    height: 62px;
    border-radius: 18px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
    display:grid;
    place-items:center;
    overflow:hidden;
    flex: 0 0 auto;
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
  }
  .badgeImg img{
    width: 44px;
    height: 44px;
    object-fit: contain;
    display:block;
  }
  .badgeInfo{
    min-width:0;
  }
  .badgeLine{
    font-weight: 950;
    font-size: 16px;
    margin: 0;
    line-height: 1.2;
    text-shadow: 0 14px 30px rgba(0,0,0,.55);
  }
  .badgeMeta{
    margin-top: 6px;
    font-size: 13px;
    font-weight: 900;
    color: rgba(255,255,255,.74);
    display:flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .badgeMeta .tag{
    display:inline-flex;
    align-items:center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.22);
  }

  .footer{
    position: relative;
    z-index: 2;
    padding: 14px 18px;
    border-top: 1px solid rgba(255,255,255,.10);
    text-align:center;
    font-size: 13px;
    color: rgba(255,255,255,.72);
  }

  /* ===== Fullscreen celebration overlay ===== */
  .celebrate{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
    background: rgba(0,0,0,.92);
    overflow: hidden;
  }

  .confettiHost{
    position:absolute;
    inset:0;
    pointer-events:none;
    opacity: 1;
  }
  .confetti{
    position:absolute;
    top: -12px;
    width: 10px;
    height: 16px;
    border-radius: 3px;
    opacity: .95;
    transform: translateY(-10px) rotate(0deg);
    animation: confettiFall var(--dur) linear var(--delay) 1 forwards;
  }
  @keyframes confettiFall{
    0%{ transform: translateY(-20px) rotate(0deg); opacity: .95; }
    85%{ opacity: .95; }
    100%{ transform: translateY(110vh) rotate(720deg); opacity: 0; }
  }

  .celebrateBox{
    width: min(980px, 92%);
    background: rgba(0,0,0,.42);
    border: 1px solid rgba(255,255,255,.14);
    border-radius: 26px;
    backdrop-filter: blur(12px);
    box-shadow: 0 30px 120px rgba(0,0,0,.70);
    overflow: hidden;
    position: relative;
    animation: popIn .55s ease 1;
  }
  @keyframes popIn{
    from{ transform: translateY(18px) scale(.96); opacity: 0; }
    to{ transform: translateY(0) scale(1); opacity: 1; }
  }

  .celebrateTop{
    padding: 16px 18px;
    border-bottom: 1px solid rgba(255,255,255,.10);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .celebrateBadge{
    display:inline-flex;
    align-items:center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 900;
    letter-spacing: .12em;
    text-transform: uppercase;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.28);
  }
  .celebrateClose{
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.92);
    width: 40px;
    height: 40px;
    border-radius: 14px;
    display:grid;
    place-items:center;
    cursor:pointer;
    user-select:none;
    font-weight: 900;
  }
  .celebrateClose:hover{ filter: brightness(1.08); }

  .celebrateBody{
    padding: 22px 18px 18px;
    text-align:center;
  }
  .celebrateTitle{
    font-family:'Anton', sans-serif;
    letter-spacing:.06em;
    text-transform: uppercase;
    font-size: 56px;
    margin: 0;
    line-height: .95;
    background: linear-gradient(180deg, #fff 0%, #cfe3ff 50%, #86bfff 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 24px 90px rgba(0,0,0,.70);
  }
  .celebrateMsg{
    margin-top: 10px;
    color: rgba(255,255,255,.86);
    font-size: 15px;
    line-height: 1.55;
  }

  .hero{
    margin-top: 16px;
    display:flex;
    gap: 14px;
    align-items:center;
    justify-content:center;
    flex-wrap: wrap;
  }
  .heroThumb{
    width: 110px;
    height: 110px;
    border-radius: 26px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.14);
    display:grid;
    place-items:center;
    box-shadow: 0 26px 85px rgba(0,0,0,.55);
    position: relative;
  }
  .heroThumb::after{
    content:"";
    position:absolute; inset:-2px;
    background: radial-gradient(closest-side, rgba(255,165,0,.22), transparent 70%);
    filter: blur(10px);
    opacity: .60;
    pointer-events:none;
  }
  .heroThumb img{
    width: 76px;
    height: 76px;
    object-fit: contain;
    display:block;
    animation: badgeGlow 1.25s ease-in-out infinite;
  }
  @keyframes badgeGlow{
    0%,100%{ filter: drop-shadow(0 0 0 rgba(255,165,0,.0)); transform: translateY(0) scale(1); }
    50%{ filter: drop-shadow(0 0 18px rgba(255,165,0,.35)); transform: translateY(-2px) scale(1.02); }
  }

  .heroInfo{
    text-align:left;
    min-width: 280px;
  }
  .heroLine{
    font-weight: 950;
    font-size: 18px;
    margin: 0;
  }
  .heroSub{
    margin-top: 6px;
    color: rgba(255,255,255,.74);
    font-weight: 900;
    font-size: 13px;
  }
  .heroPills{
    margin-top: 10px;
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content:flex-start;
  }

  .celebrateActions{
    padding: 14px 16px 18px;
    border-top: 1px solid rgba(255,255,255,.10);
    display:flex;
    justify-content:center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .btn-ember{
    border:0;
    border-radius:14px;
    padding:10px 16px;
    font-weight:900;
    font-size: 13px;
    letter-spacing:.10em;
    text-transform:uppercase;
    background: linear-gradient(180deg,#ffb05a,#ff7832);
    color:#0a0c12;
    box-shadow:0 14px 30px rgba(255,120,50,.22);
    transition: transform .15s ease, filter .15s ease;
    white-space: nowrap;
    cursor:pointer;
  }
  .btn-ember:hover{ transform: translateY(-2px); filter: brightness(1.06); }

  .btn-ghost{
    border-radius:14px;
    padding:10px 16px;
    font-weight:900;
    font-size: 13px;
    letter-spacing:.10em;
    text-transform:uppercase;
    border: 1px solid rgba(140,200,255,.55);
    background: rgba(0,0,0,.28);
    color: rgba(255,255,255,.92);
    box-shadow: 0 16px 50px rgba(0,0,0,.30);
    transition: transform .15s ease, filter .15s ease;
    white-space: nowrap;
    cursor:pointer;
  }
  .btn-ghost:hover{ transform: translateY(-2px); filter: brightness(1.08); }

  @media (max-width: 576px){
    .gameTitleBack{ font-size: 56px; }
    .gameSubtitleBig{ font-size: 44px; }
    .celebrateTitle{ font-size: 44px; }
    .heroInfo{ text-align:center; min-width:auto; }
    .heroPills{ justify-content:center; }
  }
</style>
</head>

<body>
<div class="genially-stage">
  <div class="genially-page" id="geniallyPage">
    <div class="page-wrap">
      <div class="container">

        <div class="gameTitleWrap">
          <div class="topBadge">Collection</div>
          <h1 class="gameTitleBack">URGENCES</h1>
          <h2 class="gameSubtitleBig">Badges obtenus</h2>
        </div>

        <div class="glass">
          <div class="header">
            <p class="hello" id="helloLine"></p>
            <p class="subtitle" id="subLine">Filtre par niveau, consulte tes badges et progresse jusqu‚Äôau OR.</p>

            <div class="headerRow">
              <div class="counterRow" aria-label="Compteurs de badges">
                <span class="pill pillGold" id="countOr">üèÖ OR <strong id="nOr">0</strong></span>
                <span class="pill pillSilver" id="countArgent">ü•à ARGENT <strong id="nArgent">0</strong></span>
                <span class="pill pillBronze" id="countBronze">ü•â BRONZE <strong id="nBronze">0</strong></span>
              </div>

              <div class="filterGroup" aria-label="Filtre par difficult√©">
                <button class="filterBtn" data-diff="debutant" id="btnDeb">D√©butant</button>
                <button class="filterBtn" data-diff="intermediaire" id="btnInt">Interm√©diaire</button>
                <button class="filterBtn" data-diff="expert" id="btnExp">Expert</button>
              </div>
            </div>
          </div>

          <div class="body">
            <div class="sectionTitle" id="sectionTitle">Badges ‚Äî Niveau : D√âBUTANT</div>
            <div class="grid" id="badgesGrid"></div>
          </div>

          <div class="footer" id="helpTxt">
            Astuce : le badge le plus r√©cent peut s‚Äôafficher en plein √©cran (animation), puis se range automatiquement ici.
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Fullscreen animation: dernier badge gagn√© -->
<div class="celebrate" id="celebrateOverlay" role="dialog" aria-modal="true">
  <div class="confettiHost" id="confettiHost"></div>

  <div class="celebrateBox">
    <div class="celebrateTop">
      <div class="celebrateBadge" id="celebratePill">NOUVEAU BADGE</div>
      <div class="celebrateClose" id="celebrateClose" title="Fermer">‚úï</div>
    </div>

    <div class="celebrateBody">
      <h3 class="celebrateTitle">F√âLICITATIONS !</h3>
      <div class="celebrateMsg" id="celebrateMsg">
        Tu viens de gagner un nouveau badge. Chaque seconde compte ‚Äî continue comme √ßa.
      </div>

      <div class="hero">
        <div class="heroThumb">
          <img id="celebrateImg" alt="badge">
        </div>
        <div class="heroInfo">
          <p class="heroLine" id="celebrateLine">üèÖ Badge ‚Äî</p>
          <div class="heroSub" id="celebrateSub">Niveau ‚Äî ‚Ä¢ Score ‚Äî</div>
          <div class="heroPills">
            <span class="pill" id="celebrateP1">‚≠ê Score : ‚Äî</span>
            <span class="pill" id="celebrateP2">üéö Niveau : ‚Äî</span>
            <span class="pill" id="celebrateP3">üßæ Mission : ‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <div class="celebrateActions">
      <button class="btn-ember" id="celebrateOk">CONTINUER</button>
      <button class="btn-ghost" id="celebrateNoRepeat">NE PLUS R√âAFFICHER</button>
    </div>
  </div>
</div>

<script>
/* ‚úÖ Scale auto pour Genially */
(function scaleGeniallyPage(){
  const page = document.getElementById('geniallyPage');
  function apply(){
    const sw = window.innerWidth / 1920;
    const sh = window.innerHeight / 1080;
    const s = Math.min(sw, sh);
    page.style.transform = `scale(${s})`;
  }
  window.addEventListener('resize', apply);
  apply();
})();

/* ===== Data / helpers ===== */
const SCENARIOS = [
  { id: 1, label: "Sc√©nario 1" },
  { id: 2, label: "Sc√©nario 2" },
  { id: 3, label: "Sc√©nario 3" },
  { id: 4, label: "Sc√©nario 4" }
];

const BADGE_IMAGES = {
  OR: "or.png",
  ARGENT: "argent.png",
  BRONZE: "bronze.png",
  LOCK: "bronze.png" // mets "lock.png" si tu as
};

function escapeHtml(str){
  return String(str||"").replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

function normalizeDiff(d){
  const s = String(d||"").toLowerCase();
  if(s.includes("inter")) return "intermediaire";
  if(s.includes("expert")) return "expert";
  return "debutant";
}
function labelDiff(d){
  const x = normalizeDiff(d);
  if(x==="intermediaire") return "INTERM√âDIAIRE";
  if(x==="expert") return "EXPERT";
  return "D√âBUTANT";
}

function getImgPath(img){
  const s = String(img||"").trim();
  if(!s) return "assets/" + BADGE_IMAGES.BRONZE;
  if(s.startsWith("assets/")) return s;
  return "assets/" + s;
}

function safeJsonParse(raw, fallback=null){
  try{ return JSON.parse(raw); }catch(e){ return fallback; }
}

/* ===== Read badge formats (compatibles) =====
   - Format A (ton quiz engine): {scenario, name, type, niveau, score, img, ts, mission?}
   - Format B (ancien): {badgeLevel, badgeImage, difficulty, score, scenarioLabel}
*/
function readBadgeByKey(key){
  if(!key) return null;
  const raw = localStorage.getItem(key);
  if(!raw) return null;
  const obj = safeJsonParse(raw, null);
  if(!obj) return null;
  return obj;
}

function readBadgeScenarioDifficulty(scenarioId, diff){
  // prioritaire: badge_s{scenarioId}_{diff}
  const key1 = `badge_s${scenarioId}_${String(diff||"").toUpperCase()}`;
  const a = readBadgeByKey(key1);
  if(a) return a;

  // fallback: badge_s{scenarioId}_{diffLower}
  const key2 = `badge_s${scenarioId}_${String(diff||"").toLowerCase()}`;
  const b = readBadgeByKey(key2);
  if(b) return b;

  // fallback: badge_s{scenarioId} (si tu stockes sans difficult√©)
  const key3 = `badge_s${scenarioId}`;
  const c = readBadgeByKey(key3);
  if(c) return c;

  return null;
}

function normalizeBadge(obj, scenarioFallback){
  if(!obj) return null;

  // Format A
  if(obj.type && obj.img){
    const scenarioId = Number(obj.scenario ?? scenarioFallback?.id ?? 0) || 0;
    const mission = obj.mission || (obj.name ? String(obj.name).split("‚Äî").pop().trim() : "") || "";
    const diff = normalizeDiff(obj.niveau || obj.difficulty || localStorage.getItem("niveau") || "debutant");
    const type = String(obj.type).toUpperCase();
    return {
      scenarioId,
      scenarioLabel: obj.scenarioLabel || scenarioFallback?.label || `Sc√©nario ${scenarioId||"?"}`,
      mission,
      type,
      difficulty: diff,
      score: Number(obj.score ?? 0) || 0,
      img: getImgPath(obj.img),
      ts: Number(obj.ts ?? 0) || 0,
      raw: obj
    };
  }

  // Format B
  if(obj.badgeLevel || obj.badgeImage){
    const scenarioId = Number(obj.scenarioId ?? scenarioFallback?.id ?? 0) || 0;
    const diff = normalizeDiff(obj.difficulty || localStorage.getItem("niveau") || "debutant");
    const type = String(obj.badgeLevel || "BRONZE").toUpperCase();
    return {
      scenarioId,
      scenarioLabel: obj.scenarioLabel || scenarioFallback?.label || `Sc√©nario ${scenarioId||"?"}`,
      mission: obj.mission || "",
      type,
      difficulty: diff,
      score: Number(obj.score ?? 0) || 0,
      img: getImgPath(obj.badgeImage || BADGE_IMAGES[type] || BADGE_IMAGES.BRONZE),
      ts: Number(obj.ts ?? 0) || 0,
      raw: obj
    };
  }

  return null;
}

/* ===== History: rangement automatique ===== */
function readHistory(){
  const raw = localStorage.getItem("badges_history") || localStorage.getItem("badgesHistory");
  const arr = safeJsonParse(raw, []);
  return Array.isArray(arr) ? arr : [];
}

function writeHistory(arr){
  localStorage.setItem("badges_history", JSON.stringify(arr));
}

function ensureHistoryIncludes(b){
  if(!b) return;

  const hist = readHistory();

  // D√©tecter doublon (souple): scenarioId + difficulty + type + score
  const exists = hist.some(x=>{
    const sid = Number(x.scenarioId ?? x.scenario ?? 0) || 0;
    const diff = normalizeDiff(x.niveau || x.difficulty || "");
    const type = String(x.badgeType || x.type || "").toUpperCase();
    const score = Number(x.score ?? 0) || 0;
    return sid === b.scenarioId && diff === b.difficulty && type === b.type && score === b.score;
  });

  if(!exists){
    hist.push({
      scenarioId: b.scenarioId,
      mission: b.mission || "",
      niveau: b.difficulty,                   // ex: debutant/intermediaire/expert
      badgeType: b.type,                      // OR/ARGENT/BRONZE
      badgeName: `${b.type} ‚Äî ${b.mission||b.scenarioLabel||"Mission"}`,
      score: b.score,
      img: b.img.replace(/^assets\//,""),
      ts: b.ts || Date.now(),
      dateISO: new Date(b.ts || Date.now()).toISOString()
    });
    writeHistory(hist);
  }
}

/* ===== UI rendering ===== */
const badgesGrid = document.getElementById("badgesGrid");
const sectionTitle = document.getElementById("sectionTitle");
const helpTxt = document.getElementById("helpTxt");

const nOr = document.getElementById("nOr");
const nArgent = document.getElementById("nArgent");
const nBronze = document.getElementById("nBronze");

let activeDifficulty = normalizeDiff(localStorage.getItem("niveau") || localStorage.getItem("difficulty") || "debutant");

function setActiveFilter(diff){
  activeDifficulty = normalizeDiff(diff);
  localStorage.setItem("badges_filter", activeDifficulty);

  document.querySelectorAll(".filterBtn").forEach(btn=>{
    btn.classList.toggle("isActive", normalizeDiff(btn.dataset.diff) === activeDifficulty);
  });

  sectionTitle.textContent = `Badges ‚Äî Niveau : ${labelDiff(activeDifficulty)}`;
  renderBadges();
}

document.querySelectorAll(".filterBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    setActiveFilter(btn.dataset.diff);
  });
});

function renderBadges(){
  const diffLabel = labelDiff(activeDifficulty);

  const cards = SCENARIOS.map(sc=>{
    const raw = readBadgeScenarioDifficulty(sc.id, diffLabel);
    const b = normalizeBadge(raw, sc);

    if(!b){
      return `
        <div class="badgeCard locked">
          <div class="badgeTop">
            <div class="badgeTitle">${escapeHtml(sc.label)}</div>
            <div class="badgeMini">üîí Non obtenu</div>
          </div>
          <div class="badgeMid">
            <div class="badgeImg"><img src="${getImgPath(BADGE_IMAGES.LOCK)}" alt="locked"></div>
            <div class="badgeInfo">
              <p class="badgeLine">Objectif : obtenir un badge</p>
              <div class="badgeMeta">
                <span class="tag">üéö ${escapeHtml(diffLabel)}</span>
                <span class="tag">‚≠ê Score : ‚Äî</span>
                <span class="tag">üèÖ Type : ‚Äî</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    const dateTxt = b.ts ? new Date(b.ts).toLocaleString("fr-FR",{ dateStyle:"medium", timeStyle:"short" }) : "‚Äî";
    const typeEmoji = (b.type==="OR") ? "üèÖ" : (b.type==="ARGENT") ? "ü•à" : "ü•â";

    return `
      <div class="badgeCard">
        <div class="badgeTop">
          <div class="badgeTitle">${escapeHtml(b.scenarioLabel || sc.label)}</div>
          <div class="badgeMini">${typeEmoji} ${escapeHtml(b.type)}</div>
        </div>

        <div class="badgeMid">
          <div class="badgeImg"><img src="${escapeHtml(b.img)}" alt="${escapeHtml(b.type)}"></div>
          <div class="badgeInfo">
            <p class="badgeLine">${escapeHtml(b.mission ? b.mission : "Badge obtenu")}</p>
            <div class="badgeMeta">
              <span class="tag">üéö ${escapeHtml(diffLabel)}</span>
              <span class="tag">‚≠ê ${escapeHtml(String(b.score))}</span>
              <span class="tag">üïí ${escapeHtml(dateTxt)}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  badgesGrid.innerHTML = cards;

  // Counters
  const got = SCENARIOS.map(sc => normalizeBadge(readBadgeScenarioDifficulty(sc.id, diffLabel), sc)).filter(Boolean);
  const count = { OR:0, ARGENT:0, BRONZE:0 };
  got.forEach(b=>{
    const t = String(b.type||"").toUpperCase();
    if(count[t] != null) count[t]++;
  });
  nOr.textContent = String(count.OR);
  nArgent.textContent = String(count.ARGENT);
  nBronze.textContent = String(count.BRONZE);

  helpTxt.textContent = `Filtre actif : ${diffLabel}. Badges obtenus : ${got.length}/${SCENARIOS.length}.`;
}

/* ===== Fullscreen animation: last badge ===== */
const celebrateOverlay = document.getElementById("celebrateOverlay");
const confettiHost = document.getElementById("confettiHost");
const celebrateClose = document.getElementById("celebrateClose");
const celebrateOk = document.getElementById("celebrateOk");
const celebrateNoRepeat = document.getElementById("celebrateNoRepeat");

const celebratePill = document.getElementById("celebratePill");
const celebrateMsg = document.getElementById("celebrateMsg");
const celebrateImg = document.getElementById("celebrateImg");
const celebrateLine = document.getElementById("celebrateLine");
const celebrateSub = document.getElementById("celebrateSub");
const celebrateP1 = document.getElementById("celebrateP1");
const celebrateP2 = document.getElementById("celebrateP2");
const celebrateP3 = document.getElementById("celebrateP3");

function randomConfettiColor(){
  const colors = [
    "rgba(255,190,110,.95)", // gold
    "rgba(120,190,255,.95)", // blue
    "rgba(255,120,50,.95)",  // ember
    "rgba(255,255,255,.90)"
  ];
  return colors[Math.floor(Math.random()*colors.length)];
}

function spawnConfetti(n=90){
  confettiHost.innerHTML = "";
  for(let i=0;i<n;i++){
    const s = document.createElement("span");
    s.className = "confetti";
    s.style.left = Math.random()*100 + "vw";
    s.style.background = randomConfettiColor();
    s.style.width = (6 + Math.random()*10) + "px";
    s.style.height = (10 + Math.random()*14) + "px";
    s.style.opacity = (0.65 + Math.random()*0.35).toFixed(2);
    s.style.setProperty("--dur", (2.2 + Math.random()*1.8).toFixed(2) + "s");
    s.style.setProperty("--delay", (Math.random()*0.5).toFixed(2) + "s");
    confettiHost.appendChild(s);
  }
}

function openCelebrate(badge){
  if(!badge) return;

  // rangement auto dans l‚Äôhistorique
  ensureHistoryIncludes(badge);

  const diffLabel = labelDiff(badge.difficulty);
  const type = String(badge.type||"BRONZE").toUpperCase();
  const emoji = (type==="OR")?"üèÖ":(type==="ARGENT")?"ü•à":"ü•â";

  celebratePill.textContent = `NOUVEAU BADGE ‚Äî ${type}`;
  celebrateMsg.innerHTML = `üî• Tu avances vite, <b>${escapeHtml(playerName)}</b>. Continue : chaque seconde compte.`;
  celebrateImg.src = badge.img;

  celebrateLine.textContent = `${emoji} ${type} ‚Äî ${badge.mission || badge.scenarioLabel || "Mission"}`;
  celebrateSub.textContent = `Niveau ${diffLabel} ‚Ä¢ Score ${badge.score}`;

  celebrateP1.innerHTML = `‚≠ê Score : <strong>${escapeHtml(String(badge.score))}</strong>`;
  celebrateP2.innerHTML = `üéö Niveau : <strong>${escapeHtml(diffLabel)}</strong>`;
  celebrateP3.innerHTML = `üßæ Mission : <strong>${escapeHtml(badge.mission || badge.scenarioLabel || "‚Äî")}</strong>`;

  spawnConfetti(95);

  celebrateOverlay.style.display = "flex";
  document.body.style.overflow = "hidden";

  // Fermer auto apr√®s un court moment (mais laisse le bouton)
  clearTimeout(openCelebrate._t);
  openCelebrate._t = setTimeout(()=>{
    // on baisse l√©g√®rement la densit√© (effet ‚Äúretomb√©e‚Äù)
    spawnConfetti(55);
  }, 1300);
}

function closeCelebrate(){
  celebrateOverlay.style.display = "none";
  document.body.style.overflow = "";
  confettiHost.innerHTML = "";
}

celebrateClose.addEventListener("click", closeCelebrate);
celebrateOk.addEventListener("click", closeCelebrate);
celebrateOverlay.addEventListener("click", (e)=>{ if(e.target === celebrateOverlay) closeCelebrate(); });

/* ‚úÖ lecture last_badge_key + fallback badges_history (dernier ts) */
function getLastBadge(){
  const lastKey = localStorage.getItem("last_badge_key");

  // si l‚Äôutilisateur a demand√© ‚Äúne plus r√©afficher‚Äù
  const noRepeat = localStorage.getItem("last_badge_no_repeat") === "1";
  if(noRepeat) return null;

  if(lastKey){
    const obj = readBadgeByKey(lastKey);
    // lastKey peut √™tre badge_s{scenarioId}_{DIFF}
    // si on peut extraire scenarioId, sinon on prendra l'objet tel quel
    let scenarioFallback = null;
    const m = String(lastKey).match(/badge_s(\d+)/i);
    if(m){
      const sid = Number(m[1]) || 0;
      scenarioFallback = SCENARIOS.find(s=>s.id===sid) || { id: sid, label: `Sc√©nario ${sid}` };
    }
    const b = normalizeBadge(obj, scenarioFallback);

    // anti-replay: ne rejoue pas si d√©j√† vu pour cette cl√©
    const seenKey = localStorage.getItem("last_badge_seen_key");
    if(seenKey && seenKey === lastKey) return null;

    // marque vu (mais tu peux aussi supprimer last_badge_key si tu veux)
    localStorage.setItem("last_badge_seen_key", lastKey);

    return b;
  }

  // fallback: badges_history -> dernier ts
  const hist = readHistory();
  if(hist.length){
    const last = [...hist].sort((a,b)=>(Number(b.ts||0)-Number(a.ts||0)))[0];
    const scenarioFallback = SCENARIOS.find(s=>s.id===Number(last.scenarioId)) || { id: Number(last.scenarioId||0), label: `Sc√©nario ${last.scenarioId||"?"}` };
    const pseudo = {
      scenario: last.scenarioId,
      mission: last.mission || "",
      type: last.badgeType || last.type || "BRONZE",
      niveau: last.niveau || last.difficulty || "debutant",
      score: last.score || 0,
      img: last.img || BADGE_IMAGES.BRONZE,
      ts: last.ts || Date.now()
    };
    return normalizeBadge(pseudo, scenarioFallback);
  }

  return null;
}

celebrateNoRepeat.addEventListener("click", ()=>{
  localStorage.setItem("last_badge_no_repeat", "1");
  closeCelebrate();
});

/* ===== Greeting ===== */
const playerName =
  localStorage.getItem("player_name") ||
  localStorage.getItem("playerName") ||
  "Joueur";

document.getElementById("helloLine").innerHTML =
  `Bravo <span class="name">${escapeHtml(playerName)}</span> ‚Äî voici tes badges.`;

/* ===== Init ===== */
(function init(){
  // Filtre: si l‚Äôutilisateur avait choisi avant
  const savedFilter = localStorage.getItem("badges_filter");
  if(savedFilter) activeDifficulty = normalizeDiff(savedFilter);

  setActiveFilter(activeDifficulty);

  // Plein √©cran: dernier badge (si last_badge_key existe)
  const last = getLastBadge();
  if(last){
    // Ajuste le filtre sur la difficult√© du badge (effet ‚Äúrangement‚Äù visible)
    setActiveFilter(last.difficulty);
    // Ouvre l‚Äôanimation
    openCelebrate(last);
  }

  // Rendu final
  renderBadges();
})();
</script>

<!--
‚úÖ IMPORTANT (petite note) :
Pour que l‚Äôanimation ‚Äúdernier badge gagn√©‚Äù marche √† 100%,
dans ton code de fin de sc√©nario, ajoute juste apr√®s saveBadge(...) :

  const key = `badge_s${SCENARIO.id}_${levelLabel}`; // ex: badge_s1_DEBUTANT
  localStorage.setItem("last_badge_key", key);

Et assure-toi de sauvegarder aussi le badge dans cette cl√© (badge_s1_DEBUTANT).
-->
</body>
</html>
