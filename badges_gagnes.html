<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Urgences ‚Äî Badges</title>

<!-- (Optionnel) Police sympa, l√©g√®re. Si tu veux rester 100% offline, supprime ces 2 lignes. -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet">

<style>
:root{
  --glass: rgba(25,27,31,.72);
  --glass2: rgba(15,17,20,.55);
  --text: rgba(255,255,255,.93);
  --muted: rgba(255,255,255,.70);

  --gold: rgba(255,200,80,1);
  --blue: rgba(80,170,255,1);
  --ember: rgba(255,150,70,1);
  --ember2: rgba(255,120,50,1);

  --line: rgba(255,255,255,.12);
  --line2: rgba(255,255,255,.08);

  --shadow: 0 18px 70px rgba(0,0,0,.50);
  --shadow2: 0 14px 34px rgba(0,0,0,.28);

  --r12: 12px;
  --r16: 16px;
  --r18: 18px;
  --r22: 22px;
}

html,body{
  margin:0;
  background: transparent;
  overflow:hidden; /* Genially */
  color: var(--text);
  font-family: Inter, system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}

.stage{
  height:100vh;
  padding: 10px;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:stretch;
  position: relative;
}

/* ‚ú® Ambient background glow (ne bouge pas tes √©l√©ments) */
.stage::before,
.stage::after{
  content:"";
  position:absolute;
  inset:-30px;
  pointer-events:none;
  z-index:0;
  opacity:.85;
}
.stage::before{
  background:
    radial-gradient(700px 260px at 20% 10%, rgba(255,150,70,.18), transparent 62%),
    radial-gradient(860px 320px at 80% 25%, rgba(80,170,255,.12), transparent 62%),
    radial-gradient(820px 340px at 55% 120%, rgba(255,200,80,.10), transparent 62%);
  filter: blur(2px);
}
.stage::after{
  background:
    radial-gradient(520px 220px at 15% 80%, rgba(80,170,255,.08), transparent 62%),
    radial-gradient(620px 260px at 90% 90%, rgba(255,120,50,.10), transparent 62%);
  mix-blend-mode: screen;
}

/* Layout inchang√© */
.big{
  width:min(1400px,100%);
  height:100%;
  display:grid;
  grid-template-columns: 320px 1fr;
  gap: 18px;
  position:relative;
  z-index:1; /* au-dessus du glow */
}

/* Left column */
.left{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  gap: 12px;
  padding-top: 8px;
}

/* Carte de profil (fond glass derri√®re, sans d√©placer) */
.profileCard{
  width: 100%;
  border-radius: var(--r22);
  border: 1px solid var(--line);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
  box-shadow: var(--shadow2);
  backdrop-filter: blur(12px);
  overflow:hidden;
  position:relative;
  padding: 12px 12px 14px;
}
.profileCard::after{
  content:"";
  position:absolute;
  inset:-2px;
  pointer-events:none;
  background:
    radial-gradient(440px 160px at 15% 0%, rgba(255,150,70,.16), transparent 60%),
    radial-gradient(560px 240px at 85% 120%, rgba(80,170,255,.10), transparent 60%);
  opacity:.9;
}

.avatar{
  width: 100%;
  height: min(520px, 64vh);
  object-fit: contain;
  filter: drop-shadow(0 30px 55px rgba(0,0,0,.55));
  position:relative;
  z-index:2;
}

/* Bloc texte (inchang√©) */
.name{
  font-family: Anton, Inter, system-ui, sans-serif;
  letter-spacing:.3px;
  font-weight: 400;
  font-size: 24px;
  line-height:1.08;
  text-shadow: 0 16px 34px rgba(0,0,0,.55);
  position:relative;
  z-index:2;
  margin-top: 8px;
  text-align:center;
}

.level{
  font-size: 12px;
  font-weight: 950;
  color: rgba(255,255,255,.82);
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(0,0,0,.20);
  border: 1px solid var(--line);
  display:inline-flex;
  align-items:center;
  gap: 8px;
  position:relative;
  z-index:2;
}
.levelDot{
  width: 9px; height: 9px; border-radius:999px;
  background: rgba(255,176,90,1);
  box-shadow: 0 0 0 5px rgba(255,176,90,.18);
}

/* Right column */
.right{
  display:flex;
  flex-direction:column;
  gap: 12px;
  padding: 8px 8px 0 8px;
  min-height:0;
}

/* Top row: m√™mes √©l√©ments / m√™me place */
.topRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  flex-wrap:wrap;
}

/* Header title */
.hTitle{
  font-family: Anton, Inter, system-ui, sans-serif;
  font-weight: 400;
  font-size: 22px;
  letter-spacing:.35px;
  text-shadow: 0 16px 34px rgba(0,0,0,.55);
  display:flex;
  align-items:center;
  gap: 10px;
}
.hTitle .badgeIcon{
  width: 34px; height: 34px;
  border-radius: 14px;
  display:grid;
  place-items:center;
  background: linear-gradient(180deg, rgba(255,150,70,.20), rgba(80,170,255,.10));
  border: 1px solid var(--line);
  box-shadow: 0 14px 34px rgba(0,0,0,.26);
}

/* Progress group */
.progressWrap{
  display:flex;
  align-items:center;
  gap: 10px;
  color: rgba(255,255,255,.82);
  font-weight: 900;
  font-size: 12px;
  white-space:nowrap;
}

.progressShell{
  width: 260px;
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.10);
  border: 1px solid var(--line);
  overflow:hidden;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
}
.progressBar{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(80,170,255,.95), rgba(255,200,80,.95), rgba(255,120,50,.95));
  transition: width .45s cubic-bezier(.2,.8,.2,1);
  position:relative;
}
.progressBar::after{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
  transform: translateX(-120%);
  animation: shine 2.2s ease-in-out infinite;
  opacity:.6;
}
@keyframes shine{
  0%{ transform: translateX(-140%); }
  50%{ transform: translateX(140%); }
  100%{ transform: translateX(140%); }
}

/* Debug button */
.debugBtn{
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: rgba(255,255,255,.92);
  border-radius: 14px;
  padding: 9px 11px;
  font-weight: 950;
  cursor:pointer;
  font-size: 12px;
  box-shadow: 0 14px 34px rgba(0,0,0,.22);
  transition: transform .12s ease, filter .12s ease, background .12s ease;
}
.debugBtn:hover{
  transform: translateY(-1px);
  filter: brightness(1.05);
  background: rgba(255,255,255,.06);
}
.debugBtn:active{ transform: translateY(0px); }

/* List zone */
.list{
  flex:1;
  min-height:0;
  overflow:auto;
  padding-right: 6px;
  display:flex;
  flex-direction:column;
  gap: 10px;
}
.list::-webkit-scrollbar{ width: 10px; }
.list::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.18);
  border-radius: 999px;
  border: 2px solid rgba(0,0,0,.18);
}
.list::-webkit-scrollbar-track{
  background: rgba(0,0,0,.16);
  border-radius: 999px;
}

/* Badge card improved */
.item{
  display:flex;
  align-items:center;
  gap: 14px;
  padding: 12px 14px;
  border-radius: 20px;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
  border: 1px solid var(--line);
  box-shadow: var(--shadow2);
  position:relative;
  overflow:hidden;
  transform: translateY(0);
  transition: transform .14s ease, filter .14s ease, border-color .14s ease;
}
.item::after{
  content:"";
  position:absolute; inset:-2px;
  pointer-events:none;
  background:
    radial-gradient(420px 160px at 15% 0%, rgba(255,150,70,.16), transparent 60%),
    radial-gradient(520px 220px at 85% 120%, rgba(80,170,255,.10), transparent 60%);
  opacity:.9;
}
.item:hover{
  transform: translateY(-2px);
  filter: brightness(1.05);
  border-color: rgba(255,255,255,.18);
}

.bimg{
  width: 64px;
  height: 64px;
  object-fit: contain;
  filter: drop-shadow(0 14px 26px rgba(0,0,0,.48));
  position:relative;
  z-index:2;
}

/* Tiny "shine" on badge image */
.bimgWrap{
  width: 74px;
  height: 74px;
  border-radius: 22px;
  display:grid;
  place-items:center;
  background: rgba(0,0,0,.18);
  border: 1px solid var(--line);
  position:relative;
  overflow:hidden;
  z-index:2;
}
.bimgWrap::before{
  content:"";
  position:absolute;
  inset:-40%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
  transform: rotate(20deg) translateX(-140%);
  animation: badgeShine 3.2s ease-in-out infinite;
  opacity:.55;
}
@keyframes badgeShine{
  0%{ transform: rotate(20deg) translateX(-160%); }
  55%{ transform: rotate(20deg) translateX(160%); }
  100%{ transform: rotate(20deg) translateX(160%); }
}

.info{
  flex:1;
  min-width:0;
  position:relative;
  z-index:2;
}
.itTitle{
  font-weight: 950;
  font-size: 14px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  letter-spacing:.15px;
}
.itMeta{
  margin-top: 7px;
  display:flex;
  flex-wrap:wrap;
  gap: 8px;
  font-size: 12px;
  font-weight: 900;
  color: rgba(255,255,255,.80);
}

.pill{
  padding: 6px 9px;
  border-radius: 999px;
  background: rgba(0,0,0,.18);
  border: 1px solid var(--line2);
  white-space:nowrap;
}

.tag{
  font-weight: 950;
  font-size: 12px;
  padding: 7px 11px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: rgba(0,0,0,.18);
  position:relative;
  z-index:2;
  white-space:nowrap;
  box-shadow: 0 14px 34px rgba(0,0,0,.18);
}
.tag.OR{
  border-color: rgba(255,200,80,.35);
  background: rgba(255,200,80,.10);
}
.tag.ARGENT{
  border-color: rgba(210,220,235,.35);
  background: rgba(210,220,235,.10);
}
.tag.BRONZE{
  border-color: rgba(255,150,70,.40);
  background: rgba(255,150,70,.10);
}

.empty{
  margin-top: 8px;
  padding: 14px 14px;
  border-radius: 20px;
  border: 1px solid var(--line);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
  color: rgba(255,255,255,.82);
  font-weight: 900;
  box-shadow: var(--shadow2);
}

/* DEBUG panel improved */
.debug{
  margin-top: 10px;
  padding: 12px 12px;
  border-radius: 20px;
  border: 1px solid var(--line);
  background: rgba(0,0,0,.22);
  color: rgba(255,255,255,.85);
  font-size: 12px;
  font-weight: 850;
  overflow:auto;
  max-height: 200px;
  display:none;
  box-shadow: 0 14px 34px rgba(0,0,0,.22);
}
.debug pre{
  margin: 8px 0 0 0;
  white-space: pre-wrap;
  word-break: break-word;
  color: rgba(255,255,255,.78);
  font-weight: 800;
  font-size: 11px;
}

/* Responsive: positions conserv√©es (left en haut, right en dessous) */
@media (max-width: 900px){
  .big{ grid-template-columns: 1fr; }
  .profileCard{ padding: 12px; }
  .avatar{ height: min(280px, 36vh); }
  .progressShell{ width: 220px; }
}
</style>
</head>

<body>
<div class="stage">
  <div class="big">

    <!-- LEFT (emplacement identique) -->
    <div class="left">
      <div class="profileCard">
        <img id="avatar" class="avatar" alt="avatar">
        <div class="name" id="pname">Dr. Joueur</div>
        <div class="level" id="plevel"><span class="levelDot"></span> NIVEAU : D√âBUTANT</div>
      </div>
    </div>

    <!-- RIGHT (emplacement identique) -->
    <div class="right">
      <div class="topRow">
        <div class="hTitle">
          <span class="badgeIcon">üèÖ</span>
          <span>Tes badges</span>
        </div>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="debugBtn" id="toggleDebug" type="button">üß™ Debug</button>

          <div class="progressWrap">
            <span id="pcount">0/4</span>
            <div class="progressShell"><div class="progressBar" id="pbar"></div></div>
          </div>
        </div>
      </div>

      <div id="badgesGrid" class="list"></div>

      <div id="empty" class="empty" style="display:none;">
        Aucun badge trouv√©. Termine au moins un sc√©nario pour voir tes badges appara√Ætre ici.
      </div>

      <div class="debug" id="debugPanel">
        <div>üîé Diagnostic localStorage</div>
        <pre id="debugText">...</pre>
      </div>
    </div>

  </div>
</div>

<script>
/* =========================
   ‚úÖ Helpers
========================= */
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normDifficulty(raw){
  const d = String(raw||"").toLowerCase();
  if(d.includes("expert")) return "EXPERT";
  if(d.includes("inter")) return "INTERM√âDIAIRE";
  return "D√âBUTANT";
}

function getDifficultyLabel(){
  const raw =
    (typeof window.niveau !== "undefined" && window.niveau) ? window.niveau :
    (localStorage.getItem("niveau") || localStorage.getItem("difficulty") || "d√©butant");
  return normDifficulty(raw);
}

function getPlayer(){
  return localStorage.getItem("playerName")
    || localStorage.getItem("player_name")
    || (typeof window.player_name !== "undefined" ? window.player_name : "")
    || (typeof window.playerName !== "undefined" ? window.playerName : "")
    || "Joueur";
}
function getAvatar(){
  return localStorage.getItem("avatar") || "medecin_f.png";
}

/* =========================
   ‚úÖ Read badges robustly
   1) badges_history (si pr√©sent)
   2) scan cl√©s badge_s*
========================= */
function readBadgesFromHistory(targetDifficulty){
  const out = [];
  let arr = [];
  try { arr = JSON.parse(localStorage.getItem("badges_history") || "[]"); }
  catch(e){ arr = []; }
  if(!Array.isArray(arr)) return out;

  arr.forEach((b)=>{
    const diff = normDifficulty(b.niveau || b.difficulty || b.level || "");
    if(diff !== targetDifficulty) return;

    const sid = Number(b.scenarioId ?? b.scenario ?? b.scenario_id ?? NaN);
    if(!Number.isFinite(sid)) return;

    out.push({
      key: b.__key || null,
      scenarioId: sid,
      scenarioLabel: b.scenarioLabel || b.label || ("Sc√©nario " + sid),
      mission: b.mission || "",
      difficulty: diff,
      badgeLevel: String((b.badgeLevel || b.badgeType || b.type || "BRONZE")).toUpperCase(),
      badgeImage: b.badgeImage || b.img || "assets/bronze.png",
      score: Number(b.score ?? 0),
      date: Number(b.date ?? b.ts ?? Date.now())
    });
  });

  return out;
}

function scanBadgesFromLocalStorage(targetDifficulty){
  const out = [];
  const keys = Object.keys(localStorage);

  keys.forEach((k)=>{
    if(!k.startsWith("badge_s")) return;
    if(k === "badges_history") return;

    let v = null;
    try { v = JSON.parse(localStorage.getItem(k) || "null"); }
    catch(e){ v = null; }
    if(!v || typeof v !== "object") return;

    const sid = Number(v.scenarioId ?? v.scenario ?? v.scenario_id ?? NaN);
    if(!Number.isFinite(sid)) return;

    const diff = normDifficulty(v.difficulty || v.niveau || v.level || "");
    let diff2 = diff;
    if(!String(v.difficulty||v.niveau||"").trim()){
      const up = k.toUpperCase();
      if(up.includes("EXPERT")) diff2 = "EXPERT";
      else if(up.includes("INTER")) diff2 = "INTERM√âDIAIRE";
      else if(up.includes("DEB")) diff2 = "D√âBUTANT";
    }
    if(diff2 !== targetDifficulty) return;

    out.push({
      key: k,
      scenarioId: sid,
      scenarioLabel: v.scenarioLabel || v.label || ("Sc√©nario " + sid),
      mission: v.mission || "",
      difficulty: diff2,
      badgeLevel: String(v.badgeLevel || v.badgeType || v.type || "BRONZE").toUpperCase(),
      badgeImage: v.badgeImage || v.img || "assets/bronze.png",
      score: Number(v.score ?? 0),
      date: Number(v.date ?? v.ts ?? Date.now())
    });
  });

  return out;
}

function uniqueByScenario(arr){
  const map = new Map();
  arr.forEach(b=>{
    const prev = map.get(b.scenarioId);
    if(!prev || (b.date||0) > (prev.date||0)) map.set(b.scenarioId, b);
  });
  return [...map.values()].sort((a,b)=>a.scenarioId - b.scenarioId);
}

/* =========================
   ‚úÖ Render
========================= */
const DIFFICULTY = getDifficultyLabel();
document.getElementById("pname").textContent = "Dr. " + getPlayer();
document.getElementById("plevel").innerHTML = `<span class="levelDot"></span> NIVEAU : ${escapeHtml(DIFFICULTY)}`;
document.getElementById("avatar").src = "assets/avatars/" + getAvatar();

const host = document.getElementById("badgesGrid");
const empty = document.getElementById("empty");
const pbar = document.getElementById("pbar");
const pcount = document.getElementById("pcount");

function render(){
  const fromHist = readBadgesFromHistory(DIFFICULTY);
  const fromScan = scanBadgesFromLocalStorage(DIFFICULTY);
  let badges = uniqueByScenario([...fromHist, ...fromScan]);

  // progression sur 4
  pcount.textContent = badges.length + "/4";
  pbar.style.width = Math.round((badges.length/4)*100) + "%";

  if(badges.length === 0){
    host.innerHTML = "";
    empty.style.display = "block";
  }else{
    empty.style.display = "none";
    host.innerHTML = badges.map(b=>{
      const lvl = escapeHtml(String(b.badgeLevel||"BRONZE").toUpperCase());
      const title = escapeHtml(b.scenarioLabel || ("Sc√©nario " + b.scenarioId));
      const img = escapeHtml(b.badgeImage || "assets/bronze.png");
      const diff = escapeHtml(b.difficulty || DIFFICULTY);
      const score = escapeHtml(String(b.score ?? 0));
      const mission = escapeHtml(b.mission || "");

      return `
        <div class="item">
          <div class="bimgWrap">
            <img class="bimg" src="${img}" alt="${lvl}">
          </div>

          <div class="info">
            <div class="itTitle">${title}${mission ? " ‚Äî " + mission : ""}</div>
            <div class="itMeta">
              <span class="pill">‚≠ê ${score}</span>
              <span class="pill">üéö ${diff}</span>
              <span class="pill">#${escapeHtml(String(b.scenarioId))}</span>
            </div>
          </div>

          <div class="tag ${lvl}">${lvl}</div>
        </div>
      `;
    }).join("");
  }

  buildDebug(fromHist, fromScan, badges);
}

/* =========================
   ‚úÖ DEBUG
========================= */
const debugPanel = document.getElementById("debugPanel");
const debugText = document.getElementById("debugText");
document.getElementById("toggleDebug").addEventListener("click", ()=>{
  debugPanel.style.display = (debugPanel.style.display === "block") ? "none" : "block";
});

function buildDebug(fromHist, fromScan, finalBadges){
  const keys = Object.keys(localStorage).sort();
  const badgeKeys = keys.filter(k=>k.startsWith("badge_s"));
  const lastKey = localStorage.getItem("last_badge_key");

  const lines = [];
  lines.push("DIFFICULTY (page) = " + DIFFICULTY);
  lines.push("playerName = " + getPlayer());
  lines.push("avatar = " + getAvatar());
  lines.push("");
  lines.push("last_badge_key = " + (lastKey || "‚Äî"));
  lines.push("");
  lines.push("Keys badge_s* trouv√©es (" + badgeKeys.length + "):");
  badgeKeys.forEach(k=>lines.push(" - " + k));
  lines.push("");
  lines.push("badges_history length = " + (JSON.parse(localStorage.getItem("badges_history")||"[]").length || 0));
  lines.push("fromHistory (filtered) = " + fromHist.length);
  lines.push("fromScan (filtered) = " + fromScan.length);
  lines.push("finalBadges = " + finalBadges.length);
  lines.push("");
  finalBadges.forEach(b=>{
    lines.push(`‚Ä¢ S${b.scenarioId} ${b.badgeLevel} score=${b.score} diff=${b.difficulty} key=${b.key||"‚Äî"}`);
  });

  debugText.textContent = lines.join("\n");
}

render();
</script>
</body>
</html>
