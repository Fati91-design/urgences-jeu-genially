<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Urgences ‚Äî Badges</title>

<style>
:root{
  --glass: rgba(25,27,31,.72);
  --glass2: rgba(15,17,20,.55);
  --text: rgba(255,255,255,.93);
  --muted: rgba(255,255,255,.70);
}

html,body{
  margin:0;
  background: transparent;
  overflow:hidden; /* Genially */
  color: var(--text);
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}

.stage{
  height:100vh;
  padding: 10px;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:stretch;
}

.big{
  width:min(1400px,100%);
  height:100%;
  display:grid;
  grid-template-columns: 320px 1fr;
  gap: 18px;
  position:relative;
}

.left{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  gap: 10px;
  padding-top: 8px;
}

.avatar{
  width: 100%;
  height: min(540px, 66vh);
  object-fit: contain;
  filter: drop-shadow(0 30px 55px rgba(0,0,0,.55));
}

.name{
  font-weight: 950;
  font-size: 20px;
  line-height:1.1;
  text-shadow: 0 16px 34px rgba(0,0,0,.55);
}

.level{
  font-size: 12px;
  font-weight: 950;
  color: rgba(255,255,255,.82);
  padding: 7px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
}

.right{
  display:flex;
  flex-direction:column;
  gap: 12px;
  padding: 8px 8px 0 8px;
  min-height:0;
}

.topRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  flex-wrap:wrap;
}

.hTitle{
  font-weight: 950;
  font-size: 18px;
  text-shadow: 0 16px 34px rgba(0,0,0,.55);
}

.progressWrap{
  display:flex;
  align-items:center;
  gap: 10px;
  color: rgba(255,255,255,.82);
  font-weight: 900;
  font-size: 12px;
  white-space:nowrap;
}

.progressShell{
  width: 240px;
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.progressBar{
  height:100%;
  width:0%;
  background: linear-gradient(90deg, rgba(80,170,255,.95), rgba(255,200,80,.95), rgba(255,120,50,.95));
  transition: width .35s ease;
}

.list{
  flex:1;
  min-height:0;
  overflow:auto;
  padding-right: 6px;
  display:flex;
  flex-direction:column;
  gap: 10px;
}
.list::-webkit-scrollbar{ width: 10px; }
.list::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.18);
  border-radius: 999px;
  border: 2px solid rgba(0,0,0,.18);
}
.list::-webkit-scrollbar-track{ background: rgba(0,0,0,.16); border-radius: 999px; }

.item{
  display:flex;
  align-items:center;
  gap: 14px;
  padding: 12px 14px;
  border-radius: 18px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 14px 34px rgba(0,0,0,.28);
  position:relative;
  overflow:hidden;
}

.item::after{
  content:"";
  position:absolute; inset:-2px;
  pointer-events:none;
  background:
    radial-gradient(420px 160px at 15% 0%, rgba(255,150,70,.16), transparent 60%),
    radial-gradient(520px 220px at 85% 120%, rgba(80,170,255,.10), transparent 60%);
  opacity:.9;
}

.bimg{
  width: 62px;
  height: 62px;
  object-fit: contain;
  filter: drop-shadow(0 14px 26px rgba(0,0,0,.45));
  position:relative;
  z-index:2;
}

.info{
  flex:1;
  min-width:0;
  position:relative;
  z-index:2;
}
.itTitle{
  font-weight: 950;
  font-size: 14px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.itMeta{
  margin-top: 6px;
  display:flex;
  flex-wrap:wrap;
  gap: 8px;
  font-size: 12px;
  font-weight: 900;
  color: rgba(255,255,255,.80);
}
.pill{
  padding: 6px 9px;
  border-radius: 999px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.10);
  white-space:nowrap;
}

.tag{
  font-weight: 950;
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  position:relative;
  z-index:2;
  white-space:nowrap;
}
.tag.OR{ border-color: rgba(255,200,80,.35); background: rgba(255,200,80,.10); }
.tag.ARGENT{ border-color: rgba(210,220,235,.35); background: rgba(210,220,235,.10); }
.tag.BRONZE{ border-color: rgba(255,150,70,.40); background: rgba(255,150,70,.10); }

.empty{
  margin-top: 8px;
  padding: 14px 14px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.82);
  font-weight: 900;
  box-shadow: 0 14px 34px rgba(0,0,0,.22);
}

/* DEBUG panel */
.debug{
  margin-top: 10px;
  padding: 12px 12px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.22);
  color: rgba(255,255,255,.85);
  font-size: 12px;
  font-weight: 850;
  overflow:auto;
  max-height: 180px;
  display:none;
}
.debug pre{
  margin: 8px 0 0 0;
  white-space: pre-wrap;
  word-break: break-word;
  color: rgba(255,255,255,.78);
  font-weight: 800;
  font-size: 11px;
}

.debugBtn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.18);
  color: rgba(255,255,255,.90);
  border-radius: 12px;
  padding: 8px 10px;
  font-weight: 950;
  cursor:pointer;
  font-size: 12px;
}

@media (max-width: 900px){
  .big{ grid-template-columns: 1fr; }
  .avatar{ height: min(280px, 36vh); }
  .progressShell{ width: 200px; }
}
</style>
</head>

<body>
<div class="stage">
  <div class="big">

    <div class="left">
      <img id="avatar" class="avatar" alt="avatar">
      <div class="name" id="pname">Dr. Joueur</div>
      <div class="level" id="plevel">NIVEAU : D√âBUTANT</div>
    </div>

    <div class="right">
      <div class="topRow">
        <div class="hTitle">üèÖ Tes badges</div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="debugBtn" id="toggleDebug" type="button">üß™ Debug</button>
          <div class="progressWrap">
            <span id="pcount">0/4</span>
            <div class="progressShell"><div class="progressBar" id="pbar"></div></div>
          </div>
        </div>
      </div>

      <div id="badgesGrid" class="list"></div>

      <div id="empty" class="empty" style="display:none;">
        Aucun badge trouv√©. Assure-toi d‚Äôavoir fini au moins un sc√©nario (et que le badge est bien enregistr√© dans localStorage).
      </div>

      <div class="debug" id="debugPanel">
        <div>üîé Diagnostic localStorage</div>
        <pre id="debugText">...</pre>
      </div>
    </div>

  </div>
</div>

<script>
/* =========================
   ‚úÖ Helpers
========================= */
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function normDifficulty(raw){
  const d = String(raw||"").toLowerCase();
  if(d.includes("expert")) return "EXPERT";
  if(d.includes("inter")) return "INTERM√âDIAIRE";
  return "D√âBUTANT";
}

function getDifficultyLabel(){
  const raw =
    (typeof window.niveau !== "undefined" && window.niveau) ? window.niveau :
    (localStorage.getItem("niveau") || localStorage.getItem("difficulty") || "d√©butant");
  return normDifficulty(raw);
}

function getPlayer(){
  return localStorage.getItem("playerName")
    || localStorage.getItem("player_name")
    || (typeof window.player_name !== "undefined" ? window.player_name : "")
    || (typeof window.playerName !== "undefined" ? window.playerName : "")
    || "Joueur";
}
function getAvatar(){
  return localStorage.getItem("avatar") || "medecin_f.png";
}

/* =========================
   ‚úÖ Read badges robustly
   1) badges_history (si pr√©sent)
   2) scan cl√©s badge_s*
========================= */
function readBadgesFromHistory(targetDifficulty){
  const out = [];
  let arr = [];
  try { arr = JSON.parse(localStorage.getItem("badges_history") || "[]"); }
  catch(e){ arr = []; }

  if(!Array.isArray(arr)) return out;

  arr.forEach((b)=>{
    const diff = normDifficulty(b.niveau || b.difficulty || b.level || "");
    if(diff !== targetDifficulty) return;

    // scenarioId (plusieurs noms possibles)
    const sid = Number(b.scenarioId ?? b.scenario ?? b.scenario_id ?? NaN);
    if(!Number.isFinite(sid)) return;

    out.push({
      key: b.__key || null,
      scenarioId: sid,
      scenarioLabel: b.scenarioLabel || b.label || ("Sc√©nario " + sid),
      mission: b.mission || "",
      difficulty: diff,
      badgeLevel: String((b.badgeLevel || b.badgeType || b.type || "BRONZE")).toUpperCase(),
      badgeImage: b.badgeImage || b.img || "assets/bronze.png",
      score: Number(b.score ?? 0),
      date: Number(b.date ?? b.ts ?? Date.now())
    });
  });

  return out;
}

function scanBadgesFromLocalStorage(targetDifficulty){
  const out = [];
  const keys = Object.keys(localStorage);

  keys.forEach((k)=>{
    if(!k.startsWith("badge_s")) return;
    if(k === "badges_history") return;

    let v = null;
    try { v = JSON.parse(localStorage.getItem(k) || "null"); }
    catch(e){ v = null; }
    if(!v || typeof v !== "object") return;

    // scenarioId
    const sid = Number(v.scenarioId ?? v.scenario ?? v.scenario_id ?? NaN);
    if(!Number.isFinite(sid)) return;

    const diff = normDifficulty(v.difficulty || v.niveau || v.level || "");
    // IMPORTANT: si diff manquante dans l‚Äôobjet, on essaie de la d√©duire de la cl√© badge_s1_DEBUTANT
    let diff2 = diff;
    if(!diff2 || diff2 === "D√âBUTANT" && !String(v.difficulty||v.niveau||"").trim()){
      const up = k.toUpperCase();
      if(up.includes("EXPERT")) diff2 = "EXPERT";
      else if(up.includes("INTER")) diff2 = "INTERM√âDIAIRE";
      else if(up.includes("DEB")) diff2 = "D√âBUTANT";
    }
    if(diff2 !== targetDifficulty) return;

    out.push({
      key: k,
      scenarioId: sid,
      scenarioLabel: v.scenarioLabel || v.scenarioLabel || v.label || v.scenario || ("Sc√©nario " + sid),
      mission: v.mission || "",
      difficulty: diff2,
      badgeLevel: String(v.badgeLevel || v.badgeType || v.type || "BRONZE").toUpperCase(),
      badgeImage: v.badgeImage || v.img || "assets/bronze.png",
      score: Number(v.score ?? 0),
      date: Number(v.date ?? v.ts ?? Date.now())
    });
  });

  return out;
}

function uniqueByScenario(arr){
  // garde le plus r√©cent par scenarioId (si doublons)
  const map = new Map();
  arr.forEach(b=>{
    const prev = map.get(b.scenarioId);
    if(!prev || (b.date||0) > (prev.date||0)) map.set(b.scenarioId, b);
  });
  return [...map.values()].sort((a,b)=>a.scenarioId - b.scenarioId);
}

/* =========================
   ‚úÖ Render
========================= */
const DIFFICULTY = getDifficultyLabel();
document.getElementById("pname").textContent = "Dr. " + getPlayer();
document.getElementById("plevel").textContent = "NIVEAU : " + DIFFICULTY;
document.getElementById("avatar").src = "assets/avatars/" + getAvatar();

const host = document.getElementById("badgesGrid");
const empty = document.getElementById("empty");
const pbar = document.getElementById("pbar");
const pcount = document.getElementById("pcount");

function render(){
  // 1) history
  const fromHist = readBadgesFromHistory(DIFFICULTY);
  // 2) scan cl√©s
  const fromScan = scanBadgesFromLocalStorage(DIFFICULTY);

  let badges = uniqueByScenario([...fromHist, ...fromScan]);

  // Progression (sur 4)
  pcount.textContent = badges.length + "/4";
  pbar.style.width = Math.round((badges.length/4)*100) + "%";

  if(badges.length === 0){
    host.innerHTML = "";
    empty.style.display = "block";
  }else{
    empty.style.display = "none";
    host.innerHTML = badges.map(b=>{
      const lvl = escapeHtml(String(b.badgeLevel||"BRONZE").toUpperCase());
      const title = escapeHtml(b.scenarioLabel || ("Sc√©nario " + b.scenarioId));
      const img = escapeHtml(b.badgeImage || "assets/bronze.png");
      const diff = escapeHtml(b.difficulty || DIFFICULTY);
      const score = escapeHtml(String(b.score ?? 0));
      const mission = escapeHtml(b.mission || "");

      return `
        <div class="item">
          <img class="bimg" src="${img}" alt="${lvl}">
          <div class="info">
            <div class="itTitle">${title}${mission ? " ‚Äî " + mission : ""}</div>
            <div class="itMeta">
              <span class="pill">‚≠ê ${score}</span>
              <span class="pill">üéö ${diff}</span>
              <span class="pill">#${escapeHtml(String(b.scenarioId))}</span>
            </div>
          </div>
          <div class="tag ${lvl}">${lvl}</div>
        </div>
      `;
    }).join("");
  }

  // debug
  buildDebug(fromHist, fromScan, badges);
}

/* =========================
   ‚úÖ DEBUG
========================= */
const debugPanel = document.getElementById("debugPanel");
const debugText = document.getElementById("debugText");
document.getElementById("toggleDebug").addEventListener("click", ()=>{
  debugPanel.style.display = (debugPanel.style.display === "block") ? "none" : "block";
});

function buildDebug(fromHist, fromScan, finalBadges){
  const keys = Object.keys(localStorage).sort();
  const badgeKeys = keys.filter(k=>k.startsWith("badge_s"));
  const lastKey = localStorage.getItem("last_badge_key");

  const lines = [];
  lines.push("DIFFICULTY (page) = " + DIFFICULTY);
  lines.push("playerName = " + getPlayer());
  lines.push("avatar = " + getAvatar());
  lines.push("");
  lines.push("last_badge_key = " + (lastKey || "‚Äî"));
  lines.push("");
  lines.push("Keys badge_s* trouv√©es (" + badgeKeys.length + "):");
  badgeKeys.forEach(k=>lines.push(" - " + k));
  lines.push("");
  lines.push("badges_history length = " + (JSON.parse(localStorage.getItem("badges_history")||"[]").length || 0));
  lines.push("fromHistory (filtered) = " + fromHist.length);
  lines.push("fromScan (filtered) = " + fromScan.length);
  lines.push("finalBadges = " + finalBadges.length);
  lines.push("");
  // aper√ßu
  finalBadges.forEach(b=>{
    lines.push(`‚Ä¢ S${b.scenarioId} ${b.badgeLevel} score=${b.score} diff=${b.difficulty} key=${b.key||"‚Äî"}`);
  });

  debugText.textContent = lines.join("\n");
}

render();
</script>
</body>
</html>
